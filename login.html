<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign in - Imran Square Studio</title>
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a0a0a">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background-color: #0a0a0a;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Background Image */
        .bg-glow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('resources/hero-bg.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.12;
            z-index: 0;
        }

        /* Resend Style Buttons - EXACT MATCH */
        .btn-google {
            width: 100%;
            padding: 13px 16px;
            background: linear-gradient(to bottom, #fafafa, #f5f5f5);
            color: #000;
            border: 1px solid #e5e5e5;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.15s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .btn-google:hover {
            background: linear-gradient(to bottom, #f5f5f5, #efefef);
            border-color: #d4d4d4;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .btn-dark {
            width: 100%;
            padding: 13px 16px;
            background: #171717;
            color: #fff;
            border: 1px solid #262626;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .btn-dark:hover {
            background: #1f1f1f;
            border-color: #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Resend Style Input */
        .input-resend {
            width: 100%;
            padding: 13px 16px;
            background-color: #0a0a0a;
            border: 1px solid #262626;
            border-radius: 10px;
            color: #fff;
            font-size: 15px;
            transition: all 0.2s;
        }

        .input-resend:focus {
            outline: none;
            border-color: #404040;
            background-color: #0f0f0f;
        }

        .input-resend::placeholder {
            color: #525252;
        }

/* Animate fade in */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
    animation: fadeIn 0.3s ease-out;
}

/* Logo Glowing Animation */
@keyframes logoGlow {
    0%, 100% {
        box-shadow: 
            0 0 6px rgba(255, 255, 255, 0.1),
            0 0 12px rgba(255, 255, 255, 0.05),
            inset 0 0 6px rgba(255, 255, 255, 0.03);
    }
    50% {
        box-shadow: 
            0 0 12px rgba(255, 255, 255, 0.2),
            0 0 20px rgba(255, 255, 255, 0.1),
            0 0 25px rgba(255, 255, 255, 0.05),
            inset 0 0 10px rgba(255, 255, 255, 0.05);
    }
}

.logo-container {
    position: relative;
    width: 50px;
    height: 50px;
}

.logo-wrapper {
    position: relative;
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
    border-radius: 10px;
    padding: 1.5px;
    animation: logoGlow 3s ease-in-out infinite;
}

.logo-wrapper::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 10px;
    padding: 1.5px;
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.15) 0%, 
        rgba(255, 255, 255, 0.05) 50%, 
        rgba(255, 255, 255, 0.15) 100%);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    animation: rotateGlow 4s linear infinite;
}

@keyframes rotateGlow {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

.logo-inner {
    position: relative;
    width: 100%;
    height: 100%;
    background: #0a0a0a;
    border-radius: 8.5px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.logo-img {
    width: 35px;
    height: 35px;
    position: relative;
    z-index: 2;
}

/* NEW PREMIUM INSTALL BUTTON */
        .install-btn {
            display: flex; /* Hamesha dikhega */
            align-items: center;
            gap: 8px;
            background-color: #ffffff; /* White Background for visibility */
            color: #000000;
            border: 1px solid #e5e5e5;
            padding: 8px 16px;
            border-radius: 9999px; /* Pill Shape */
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100; /* Sabse upar */
            pointer-events: auto; /* Clickable banaya */
            text-decoration: none;
        }

        .install-btn:hover {
            background-color: #f0f0f0;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(255,255,255,0.1);
        }

        .install-btn:active {
            transform: translateY(0);
        }

        /* Mobile Responsive */
        @media (max-width: 640px) {
            .install-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }


    </style>
</head>

<body class="selection:bg-white/20 relative">
  <div class="bg-glow"></div>

<!-- Header - Back Button + Install App -->
<div class="absolute top-0 left-0 w-full p-6 flex items-start justify-between z-50 pointer-events-none">
  
  <a href="landing.html" class="flex items-center gap-2 text-gray-500 hover:text-white transition text-sm pointer-events-auto bg-black/50 px-3 py-1.5 rounded-full border border-white/10 backdrop-blur-md">
    <svg fill="currentColor" viewBox="0 0 20 20" class="w-4 h-4">
      <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/>
    </svg>
    <span>Home</span>
  </a>

  <button id="pwaInstallBtn" class="install-btn pointer-events-auto">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
    </svg>
    <span>Install App</span>
  </button>
</div>


  <!-- Main Content -->
  <main class="flex-1 flex flex-col items-center justify-center px-4 pt-20 pb-10">
    <div class="w-full max-w-[420px] animate-fade-in relative z-20">
      
<!-- Logo (Center Only) with Glowing Effect -->
<div class="flex justify-center mb-8">
  <div class="logo-container">
    <div class="logo-wrapper">
      <div class="logo-inner">
        <img src="resources/logo.png" alt="Imran Square Studio" class="logo-img">
      </div>
    </div>
  </div>
</div>





      <!-- Title -->
      <div id="stepTitle" class="text-center mb-10">
        <h1 class="text-[32px] font-semibold text-white mb-2 tracking-tight leading-tight">Imran Square Studio</h1>
        <p class="text-[15px] text-gray-500">Create, manage & share your projects</p>
      </div>

      <!-- Step 1: Providers -->
      <div id="stepProviders" class="space-y-3">
        <!-- Google Button - EXACT RESEND STYLE -->
        <button id="btnGoogle" class="btn-google">
          <svg class="w-[18px] h-[18px]" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Sign in with Google
        </button>

        <!-- Divider -->
        <div class="relative flex items-center py-4">
          <div class="flex-grow border-t border-[#1f1f1f]"></div>
          <span class="flex-shrink-0 mx-4 text-[11px] text-[#525252] uppercase font-medium tracking-wider">Existing User</span>
          <div class="flex-grow border-t border-[#1f1f1f]"></div>
        </div>

        <!-- Dark Buttons -->
        <button id="btnLoginGoogle" class="btn-dark">
          Login with Email
        </button>
        <button id="btnUsername" class="btn-dark">
          Login with Username
        </button>
      </div>

      <!-- Step 2: Contact Input -->
      <div id="stepContact" class="hidden space-y-4">
        <div>
          <label id="contactLabel" class="text-[13px] text-gray-400 mb-2 block ml-1 font-medium">Email Address</label>
          <input id="contactInput" type="email" placeholder="name@example.com" class="input-resend">
          <p id="contactHint" class="text-[12px] text-gray-600 mt-2 ml-1">We'll send you a secure code.</p>
        </div>
        <button id="btnSendOtp" class="btn-google">Send Code</button>
        <button id="btnBackToProviders" class="w-full text-[14px] text-gray-500 hover:text-white py-2 transition">
          ‚Üê Back
        </button>
      </div>

      <!-- Step 3: OTP Verification -->
      <div id="stepOtp" class="hidden space-y-5 text-center">
        <div class="space-y-3">
          <input id="otpInput" type="text" maxlength="6" placeholder="000000" class="input-resend text-center text-2xl tracking-[0.5em] font-mono py-4">
          <p class="text-[13px] text-gray-500">Sent to <span id="displayEmail" class="text-white font-medium">email</span></p>
        </div>
        
        <button id="btnVerifyOtp" class="btn-google">Verify Code</button>
        
        <div class="flex items-center justify-between px-2">
          <span id="timer" class="text-[13px] text-gray-600 font-mono">60</span>
          <button id="btnResendOtp" class="text-[13px] text-gray-500 hover:text-white transition" disabled>Resend Code</button>
        </div>
      </div>

      <!-- Step 4: Username Login -->
      <div id="stepUsernameLogin" class="hidden space-y-4">
        <input id="loginUsername" type="text" placeholder="Username" class="input-resend">
        <input id="loginPassword" type="password" placeholder="Password" class="input-resend">
        
        <button id="btnUsernameLogin" class="btn-google">Sign In</button>
        <button id="btnBackFromUsername" class="w-full text-[14px] text-gray-500 hover:text-white py-2 transition">
          ‚Üê Back
        </button>
      </div>

      <!-- Step 5: Registration -->
      <div id="stepRegister" class="hidden space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <input id="firstName" placeholder="First Name" class="input-resend">
          <input id="lastName" placeholder="Last Name" class="input-resend">
        </div>
        
        <div>
          <input id="username" placeholder="Username" class="input-resend">
          <p id="usernameHint" class="text-[11px] text-gray-500 mt-1.5 ml-1"></p>
        </div>

        <input id="brotherName" placeholder="Security Answer (Who is Bro?)" class="input-resend">

        <div class="relative">
          <input id="password" type="password" placeholder="Password" class="input-resend pr-10">
          <button type="button" id="togglePassword" class="absolute right-3 top-3.5 text-gray-500 hover:text-white text-lg">
            üëÅÔ∏è
          </button>
        </div>
        
        <div class="relative">
          <input id="passwordConfirm" type="password" placeholder="Confirm Password" class="input-resend pr-10">
          <button type="button" id="togglePasswordConfirm" class="absolute right-3 top-3.5 text-gray-500 hover:text-white text-lg">
            üëÅÔ∏è
          </button>
        </div>

        <button id="btnRegister" class="btn-google mt-3">Create Account</button>
      </div>

      <!-- Footer -->
      <div class="mt-10 text-center text-[12px] text-gray-600 leading-relaxed">
        By signing up, you agree to our 
        <a href="#" class="text-gray-500 underline hover:text-gray-400">Terms</a>, 
        <a href="#" class="text-gray-500 underline hover:text-gray-400">Acceptable Use</a>, and 
        <a href="#" class="text-gray-500 underline hover:text-gray-400">Privacy Policy</a>.
      </div>

    </div>
  </main>

  <!-- Toast Notification -->
  <div id="toast" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 px-5 py-3 bg-white text-black text-sm font-medium rounded-full shadow-2xl z-50"></div>

  <!-- JavaScript Logic -->

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    // 1. Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyA_D3AuwSzHKgs5svcwRoP0St2Nc-delF8",
        authDomain: "iimransquare.firebaseapp.com",
        projectId: "iimransquare",
        storageBucket: "iimransquare.firebasestorage.app",
        messagingSenderId: "431645042472",
        appId: "1:431645042472:web:87e7cea4659d6a0564121d"
    };

    // 2. Initialize
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }

    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
        .then(() => {
            console.log("‚úÖ Session Persistence set to LOCAL");
        })
        .catch((error) => {
            console.error("‚ùå Persistence Error:", error);
        });
        
    
    // 3. Global Access (Taaki console error hat jaye)
    window.auth = firebase.auth();
    window.db = firebase.firestore();
    console.log("‚úÖ Firebase Loaded on Login Page");
</script>
  
 <script>
// GLOBAL STATE
let currentProvider = null;
let contactValue = null; // Email yahan store hoga verify hone ke baad
let timerInterval = null;

// Helper
function $(id) {
  return document.getElementById(id);
}

// API Base URL
const API_BASE = window.location.hostname === 'localhost' 
  ? 'http://localhost:10000' 
  : 'https://imran-square-studio.onrender.com';

// Toast Notification
function showToast(msg, timeout = 3000) {
  const el = $('toast');
  if (!el) { alert(msg); return; }
  el.textContent = msg;
  el.classList.remove('hidden');
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(() => {
    el.classList.add('hidden');
  }, timeout);
}

// Show/Hide Steps
function showStep(stepId) {
  const allIds = ['stepProviders', 'stepContact', 'stepOtp', 'stepRegister', 'stepUsernameLogin'];
  allIds.forEach(id => {
    const el = $(id);
    if (el) el.classList.add('hidden');
  });
  const target = $(stepId);
  if (target) target.classList.remove('hidden');
}

// Update Title
function setStepTitle(title, subtitle) {
  const wrapper = $('stepTitle');
  if (!wrapper) return;
  const h1 = wrapper.querySelector('h1');
  const p = wrapper.querySelector('p');
  if (h1) h1.textContent = title;
  if (p) p.textContent = subtitle;
}

// Timer
function startTimer(seconds = 60) {
  const timer = $('timer');
  const btnResendOtp = $('btnResendOtp');
  if (!timer) return;
  
  let timeLeft = seconds;
  timer.textContent = `${timeLeft}`;
  if (btnResendOtp) btnResendOtp.disabled = true;
  
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeLeft--;
    timer.textContent = `${timeLeft}`;
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      if (btnResendOtp) btnResendOtp.disabled = false;
    }
  }, 1000);
}
document.addEventListener('DOMContentLoaded', function () {
    console.log('‚úÖ DOM Ready');

    // ============================================================
    // üöÄ STEP 1: REGISTER SERVICE WORKER (VERY IMPORTANT FOR PWA)
    // ============================================================
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js')
            .then(() => console.log('‚úÖ Service Worker Registered Successfully'))
            .catch((err) => console.log('‚ùå Service Worker Failed:', err));
    }

    // ============================================================
    // üöÄ STEP 2: PWA INSTALL PROMPT LOGIC
    // ============================================================
    let deferredPrompt = null;
    const installBtn = document.getElementById('pwaInstallBtn');

    // 1. Capture the event
    window.addEventListener('beforeinstallprompt', (e) => {
        console.log('‚úÖ beforeinstallprompt event fired!');
        e.preventDefault(); // Browser ka default popup roko
        deferredPrompt = e; // Event ko save karo baad ke liye
        
        // Button ko dikhao
        if (installBtn) {
            installBtn.style.display = 'flex';
            console.log('‚úÖ Install button visible now');
        }
    });

    // 2. Handle Install Success
    window.addEventListener('appinstalled', () => {
        console.log('‚úÖ PWA installed!');
        deferredPrompt = null;
        if (installBtn) installBtn.style.display = 'none';
    });

    // 3. Button Click Handler
    if (installBtn) {
        installBtn.addEventListener('click', async () => {
            console.log('üîò Install Button Clicked');
            
            if (deferredPrompt) {
                console.log('‚úÖ Triggering Native Prompt');
                deferredPrompt.prompt(); // Native popup dikhao
                const outcome = await deferredPrompt.userChoice;
                console.log('User response:', outcome);
                deferredPrompt = null;
            } else {
                console.log('‚ùå No native prompt available');
                // Fallback instructions
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                if (isIOS) {
                    alert('To install on iPhone:\n1. Tap the Share icon (bottom center)\n2. Scroll down & tap "Add to Home Screen"');
                } else {
                    alert('App might already be installed or not supported. Check your browser menu for "Install App".');
                }
            }
        });
    }

    // ============================================================
    // üöÄ STEP 3: LOGIN & AUTHENTICATION LOGIC
    // ============================================================

    // Global State
    let currentProvider = null;
    let contactValue = null;
    let timerInterval = null;

    // Helpers
    function $(id) { return document.getElementById(id); }
    
    const API_BASE = window.location.hostname === 'localhost' 
      ? 'http://localhost:10000' 
      : 'https://imran-square-studio.onrender.com';

    function showToast(msg, timeout = 3000) {
        const el = $('toast');
        if (!el) { alert(msg); return; }
        el.textContent = msg;
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), timeout);
    }

    function showStep(stepId) {
        ['stepProviders', 'stepContact', 'stepOtp', 'stepRegister', 'stepUsernameLogin'].forEach(id => {
            const el = $(id);
            if (el) el.classList.add('hidden');
        });
        const target = $(stepId);
        if (target) target.classList.remove('hidden');
    }

    function setStepTitle(title, subtitle) {
        const wrapper = $('stepTitle');
        if (!wrapper) return;
        wrapper.querySelector('h1').textContent = title;
        wrapper.querySelector('p').textContent = subtitle;
    }

    function startTimer(seconds = 60) {
        const timer = $('timer');
        const btnResendOtp = $('btnResendOtp');
        if (!timer) return;
        
        let timeLeft = seconds;
        timer.textContent = `${timeLeft}`;
        if (btnResendOtp) btnResendOtp.disabled = true;
        
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            timer.textContent = `${timeLeft}`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                if (btnResendOtp) btnResendOtp.disabled = false;
            }
        }, 1000);
    }

    // --- EVENT LISTENERS ---

    // 1. Google Button
    const btnGoogle = $('btnGoogle');
    if (btnGoogle) {
        btnGoogle.addEventListener('click', () => {
            currentProvider = 'google';
            setStepTitle('Sign in with Google', 'We will send a one-time code to your Gmail.');
            const ci = $('contactInput');
            if(ci) { ci.placeholder = 'you@gmail.com'; ci.value = ''; }
            $('contactLabel').textContent = 'Google email';
            showStep('stepContact');
        });
    }

    // 2. Email Login
    const btnLoginGoogle = $('btnLoginGoogle');
    if (btnLoginGoogle) {
        btnLoginGoogle.addEventListener('click', () => {
            currentProvider = 'email';
            setStepTitle('Login with Email', 'Enter your email address to continue.');
            const ci = $('contactInput');
            if(ci) { ci.placeholder = 'name@example.com'; ci.value = ''; }
            $('contactLabel').textContent = 'Email address';
            showStep('stepContact');
        });
    }

    // 3. Username Login
    const btnUsername = $('btnUsername');
    if (btnUsername) {
        btnUsername.addEventListener('click', () => {
            setStepTitle('Login with Username', 'Enter your username and password.');
            showStep('stepUsernameLogin');
        });
    }

    // 4. Back Buttons
    const btnBackToProviders = $('btnBackToProviders');
    if (btnBackToProviders) btnBackToProviders.addEventListener('click', () => showStep('stepProviders'));

    const btnBackFromUsername = $('btnBackFromUsername');
    if (btnBackFromUsername) btnBackFromUsername.addEventListener('click', () => showStep('stepProviders'));

    // 5. SEND OTP Logic
    const btnSendOtp = $('btnSendOtp');
    if (btnSendOtp) {
        btnSendOtp.addEventListener('click', async () => {
            const email = $('contactInput').value.trim();
            if (!email) { alert('Please enter an email address'); return; }

            contactValue = email;
            btnSendOtp.textContent = 'Sending...';
            btnSendOtp.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/api/send-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();

                if (data.success) {
                    $('displayEmail').textContent = email;
                    showToast('OTP Sent!');
                    showStep('stepOtp');
                    setStepTitle('Check your inbox', `Enter code sent to ${email}`);
                    startTimer(60);
                } else {
                    alert(data.message || 'Failed to send OTP');
                }
            } catch (err) {
                console.error(err);
                alert('Connection error');
            } finally {
                btnSendOtp.textContent = 'Send Code';
                btnSendOtp.disabled = false;
            }
        });
    }

    // 6. VERIFY OTP Logic
    const btnVerifyOtp = $('btnVerifyOtp');
    if (btnVerifyOtp) {
        btnVerifyOtp.addEventListener('click', async () => {
            const code = $('otpInput').value.trim();
            if (!code) { alert('Enter the 6-digit code'); return; }

            btnVerifyOtp.textContent = 'Verifying...';
            btnVerifyOtp.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/api/verify-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: contactValue, code })
                });
                const data = await res.json();

                if (data.success) {
                    localStorage.setItem('tempEmail', contactValue);
                    
                    if (data.user) {
                        localStorage.setItem('imranUser', JSON.stringify(data.user));
                        localStorage.setItem('userId', data.user.userId);
                    }

                    if (data.isNew) {
                        showStep('stepRegister');
                        setStepTitle('Complete Setup', 'Create your account details.');
                    } else {
                        localStorage.setItem('imranUser', JSON.stringify(data.user));
                        localStorage.setItem('userId', data.user.userId);
                        
                        // GOD MODE CHECK
                        if (data.user.email === 'mohdesigner09@gmail.com') {
                            window.location.href = 'admin.html';
                        } else {
                            window.location.href = 'index.html';
                        }
                    }
                } else {
                    alert(data.message || 'Invalid Code');
                }
            } catch (err) {
                console.error(err);
                alert('Verification Failed');
            } finally {
                btnVerifyOtp.textContent = 'Verify Code';
                btnVerifyOtp.disabled = false;
            }
        });
    }

    // 7. USERNAME LOGIN Submit
    const btnUsernameLogin = $('btnUsernameLogin');
    if (btnUsernameLogin) {
        btnUsernameLogin.addEventListener('click', async () => {
            const username = $('loginUsername').value.trim();
            const password = $('loginPassword').value;

            if(!username || !password) { alert('Enter username & password'); return; }

            btnUsernameLogin.textContent = 'Signing in...';
            btnUsernameLogin.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/api/login-username`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();

                if (data.success) {
                    localStorage.setItem('imranUser', JSON.stringify(data.user));
                    localStorage.setItem('userId', data.user.userId);
                    
                    if (data.user.email === 'mohdesigner09@gmail.com') {
                        window.location.href = 'admin.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                } else {
                    alert(data.message || 'Login failed');
                }
            } catch(err) {
                console.error(err);
                alert('Login error');
            } finally {
                btnUsernameLogin.textContent = 'Sign In';
                btnUsernameLogin.disabled = false;
            }
        });
    }

    // 8. CREATE ACCOUNT Logic
    const btnRegister = $('btnRegister');
    if (btnRegister) {
        btnRegister.addEventListener('click', async () => {
            const firstName = $('firstName').value.trim();
            const lastName = $('lastName').value.trim();
            const username = $('username').value.trim();
            const brotherName = $('brotherName').value.trim();
            const password = $('password').value;
            const passwordConfirm = $('passwordConfirm').value;
            const email = localStorage.getItem('tempEmail') || contactValue;

            if (!firstName || !lastName || !username || !password) { alert('Please fill all fields'); return; }
            if (password !== passwordConfirm) { alert('Passwords do not match'); return; }
            if (brotherName !== 'IMRAN KHAN') { alert('Security answer is incorrect (Bro Name?)'); return; }

            btnRegister.textContent = 'Creating Account...';
            btnRegister.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/api/complete-registration`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, firstName, lastName, username, password, role: 'user' })
                });

                const data = await res.json();

                if (data.success) {
                    showToast('Account Created! Redirecting...');
                    setTimeout(() => {
                        localStorage.setItem('imranUser', JSON.stringify(data.user));
                        localStorage.setItem('userId', data.user.userId);
                        
                        if (data.user.email === 'mohdesigner09@gmail.com') {
                            window.location.href = 'admin.html';
                        } else {
                            window.location.href = 'index.html';
                        }
                    }, 1000);
                } else {
                    alert(data.message || 'Registration failed');
                    btnRegister.disabled = false;
                    btnRegister.textContent = 'Create Account';
                }
            } catch (err) {
                console.error(err);
                alert('Server Error');
                btnRegister.disabled = false;
                btnRegister.textContent = 'Create Account';
            }
        });
    }

    // 9. PASSWORD TOGGLE
    const togglePassword = $('togglePassword');
    const passwordInput = $('password');
    if (togglePassword && passwordInput) {
        togglePassword.addEventListener('click', () => {
            const type = passwordInput.type === 'password' ? 'text' : 'password';
            passwordInput.type = type;
            togglePassword.textContent = type === 'password' ? 'üôà' : 'üëÅÔ∏è';
        });
    }

    const togglePasswordConfirm = $('togglePasswordConfirm');
    const passwordConfirmInput = $('passwordConfirm');
    if (togglePasswordConfirm && passwordConfirmInput) {
        togglePasswordConfirm.addEventListener('click', () => {
            const type = passwordConfirmInput.type === 'password' ? 'text' : 'password';
            passwordConfirmInput.type = type;
            togglePasswordConfirm.textContent = type === 'password' ? 'üôà' : 'üëÅÔ∏è';
        });
    }

});

// ‚úÖ ADD THIS AT THE TOP OF YOUR LOGIN SCRIPT (After Firebase init)
firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
  .then(() => {
    console.log("‚úÖ Auth persistence enabled");
  })
  .catch((error) => {
    console.error("‚ùå Persistence error:", error);
  });

</script>
</body>
</html>
