<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign in - Imran Square Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background-color: #0a0a0a;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Background Image */
        .bg-glow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('resources/hero-bg.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.12;
            z-index: 0;
        }

        /* Resend Style Buttons - EXACT MATCH */
        .btn-google {
            width: 100%;
            padding: 13px 16px;
            background: linear-gradient(to bottom, #fafafa, #f5f5f5);
            color: #000;
            border: 1px solid #e5e5e5;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.15s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .btn-google:hover {
            background: linear-gradient(to bottom, #f5f5f5, #efefef);
            border-color: #d4d4d4;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .btn-dark {
            width: 100%;
            padding: 13px 16px;
            background: #171717;
            color: #fff;
            border: 1px solid #262626;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .btn-dark:hover {
            background: #1f1f1f;
            border-color: #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Resend Style Input */
        .input-resend {
            width: 100%;
            padding: 13px 16px;
            background-color: #0a0a0a;
            border: 1px solid #262626;
            border-radius: 10px;
            color: #fff;
            font-size: 15px;
            transition: all 0.2s;
        }

        .input-resend:focus {
            outline: none;
            border-color: #404040;
            background-color: #0f0f0f;
        }

        .input-resend::placeholder {
            color: #525252;
        }

/* Animate fade in */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
    animation: fadeIn 0.3s ease-out;
}

/* Logo Glowing Animation */
@keyframes logoGlow {
    0%, 100% {
        box-shadow: 
            0 0 6px rgba(255, 255, 255, 0.1),
            0 0 12px rgba(255, 255, 255, 0.05),
            inset 0 0 6px rgba(255, 255, 255, 0.03);
    }
    50% {
        box-shadow: 
            0 0 12px rgba(255, 255, 255, 0.2),
            0 0 20px rgba(255, 255, 255, 0.1),
            0 0 25px rgba(255, 255, 255, 0.05),
            inset 0 0 10px rgba(255, 255, 255, 0.05);
    }
}

.logo-container {
    position: relative;
    width: 50px;
    height: 50px;
}

.logo-wrapper {
    position: relative;
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
    border-radius: 10px;
    padding: 1.5px;
    animation: logoGlow 3s ease-in-out infinite;
}

.logo-wrapper::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 10px;
    padding: 1.5px;
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.15) 0%, 
        rgba(255, 255, 255, 0.05) 50%, 
        rgba(255, 255, 255, 0.15) 100%);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    animation: rotateGlow 4s linear infinite;
}

@keyframes rotateGlow {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

.logo-inner {
    position: relative;
    width: 100%;
    height: 100%;
    background: #0a0a0a;
    border-radius: 8.5px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.logo-img {
    width: 35px;
    height: 35px;
    position: relative;
    z-index: 2;
}

/* Install App Button - Resend Style */
.install-btn {
    display: none; /* Hidden by default, JS will show it */
    padding: 8px 14px;
    background: linear-gradient(to bottom, #fafafa, #f5f5f5);
    color: #000;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    align-items: center;
    gap: 6px;
    transition: all 0.15s ease;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.install-btn:hover {
    background: linear-gradient(to bottom, #f5f5f5, #efefef);
    border-color: #d4d4d4;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
}

.install-btn.visible {
    display: flex;
}



    </style>
</head>

<body class="selection:bg-white/20 relative">
  <div class="bg-glow"></div>

<!-- Header - Back Button + Install App -->
<div class="absolute top-0 left-0 w-full p-6 flex items-start justify-between z-10">
  <!-- Back Button (Left) -->
  <a href="landing.html" class="flex items-center gap-2 text-gray-500 hover:text-white transition text-sm pointer-events-auto">
    <svg fill="currentColor" viewBox="0 0 20 20" class="w-4 h-4">
      <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/>
    </svg>
    Home
  </a>

  <!-- Install App Button (Right) -->
  <button id="pwaInstallBtn" class="install-btn pointer-events-auto">
    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
    </svg>
    Install App
  </button>
</div>


  <!-- Main Content -->
  <main class="flex-1 flex flex-col items-center justify-center px-4 pt-20 pb-10">
    <div class="w-full max-w-[420px] animate-fade-in relative z-20">
      
<!-- Logo (Center Only) with Glowing Effect -->
<div class="flex justify-center mb-8">
  <div class="logo-container">
    <div class="logo-wrapper">
      <div class="logo-inner">
        <img src="resources/logo.png" alt="Imran Square Studio" class="logo-img">
      </div>
    </div>
  </div>
</div>





      <!-- Title -->
      <div id="stepTitle" class="text-center mb-10">
        <h1 class="text-[32px] font-semibold text-white mb-2 tracking-tight leading-tight">Imran Square Studio</h1>
        <p class="text-[15px] text-gray-500">Create, manage & share your projects</p>
      </div>

      <!-- Step 1: Providers -->
      <div id="stepProviders" class="space-y-3">
        <!-- Google Button - EXACT RESEND STYLE -->
        <button id="btnGoogle" class="btn-google">
          <svg class="w-[18px] h-[18px]" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Sign in with Google
        </button>

        <!-- Divider -->
        <div class="relative flex items-center py-4">
          <div class="flex-grow border-t border-[#1f1f1f]"></div>
          <span class="flex-shrink-0 mx-4 text-[11px] text-[#525252] uppercase font-medium tracking-wider">Existing User</span>
          <div class="flex-grow border-t border-[#1f1f1f]"></div>
        </div>

        <!-- Dark Buttons -->
        <button id="btnLoginGoogle" class="btn-dark">
          Login with Email
        </button>
        <button id="btnUsername" class="btn-dark">
          Login with Username
        </button>
      </div>

      <!-- Step 2: Contact Input -->
      <div id="stepContact" class="hidden space-y-4">
        <div>
          <label id="contactLabel" class="text-[13px] text-gray-400 mb-2 block ml-1 font-medium">Email Address</label>
          <input id="contactInput" type="email" placeholder="name@example.com" class="input-resend">
          <p id="contactHint" class="text-[12px] text-gray-600 mt-2 ml-1">We'll send you a secure code.</p>
        </div>
        <button id="btnSendOtp" class="btn-google">Send Code</button>
        <button id="btnBackToProviders" class="w-full text-[14px] text-gray-500 hover:text-white py-2 transition">
          ‚Üê Back
        </button>
      </div>

      <!-- Step 3: OTP Verification -->
      <div id="stepOtp" class="hidden space-y-5 text-center">
        <div class="space-y-3">
          <input id="otpInput" type="text" maxlength="6" placeholder="000000" class="input-resend text-center text-2xl tracking-[0.5em] font-mono py-4">
          <p class="text-[13px] text-gray-500">Sent to <span id="displayEmail" class="text-white font-medium">email</span></p>
        </div>
        
        <button id="btnVerifyOtp" class="btn-google">Verify Code</button>
        
        <div class="flex items-center justify-between px-2">
          <span id="timer" class="text-[13px] text-gray-600 font-mono">60</span>
          <button id="btnResendOtp" class="text-[13px] text-gray-500 hover:text-white transition" disabled>Resend Code</button>
        </div>
      </div>

      <!-- Step 4: Username Login -->
      <div id="stepUsernameLogin" class="hidden space-y-4">
        <input id="loginUsername" type="text" placeholder="Username" class="input-resend">
        <input id="loginPassword" type="password" placeholder="Password" class="input-resend">
        
        <button id="btnUsernameLogin" class="btn-google">Sign In</button>
        <button id="btnBackFromUsername" class="w-full text-[14px] text-gray-500 hover:text-white py-2 transition">
          ‚Üê Back
        </button>
      </div>

      <!-- Step 5: Registration -->
      <div id="stepRegister" class="hidden space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <input id="firstName" placeholder="First Name" class="input-resend">
          <input id="lastName" placeholder="Last Name" class="input-resend">
        </div>
        
        <div>
          <input id="username" placeholder="Username" class="input-resend">
          <p id="usernameHint" class="text-[11px] text-gray-500 mt-1.5 ml-1"></p>
        </div>

        <input id="brotherName" placeholder="Security Answer (Who is Bro?)" class="input-resend">

        <div class="relative">
          <input id="password" type="password" placeholder="Password" class="input-resend pr-10">
          <button type="button" id="togglePassword" class="absolute right-3 top-3.5 text-gray-500 hover:text-white text-lg">
            üëÅÔ∏è
          </button>
        </div>
        
        <div class="relative">
          <input id="passwordConfirm" type="password" placeholder="Confirm Password" class="input-resend pr-10">
          <button type="button" id="togglePasswordConfirm" class="absolute right-3 top-3.5 text-gray-500 hover:text-white text-lg">
            üëÅÔ∏è
          </button>
        </div>

        <button id="btnRegister" class="btn-google mt-3">Create Account</button>
      </div>

      <!-- Footer -->
      <div class="mt-10 text-center text-[12px] text-gray-600 leading-relaxed">
        By signing up, you agree to our 
        <a href="#" class="text-gray-500 underline hover:text-gray-400">Terms</a>, 
        <a href="#" class="text-gray-500 underline hover:text-gray-400">Acceptable Use</a>, and 
        <a href="#" class="text-gray-500 underline hover:text-gray-400">Privacy Policy</a>.
      </div>

    </div>
  </main>

  <!-- Toast Notification -->
  <div id="toast" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 px-5 py-3 bg-white text-black text-sm font-medium rounded-full shadow-2xl z-50"></div>

  <!-- JavaScript Logic -->
   </script>
  
  <script>
    // GLOBAL STATE
    let currentProvider = null;
    let contactValue = null;
    let timerInterval = null;

    // Helper
    function $(id) {
      return document.getElementById(id);
    }

    // API Base URL
    const API_BASE = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000' 
      : 'https://imran-square-studio.onrender.com';

    // Toast Notification - GLOBAL (so PWA code can access it)
    function showToast(msg, timeout = 3000) {
      const el = $('toast');
      if (!el) {
        alert(msg);
        return;
      }
      el.textContent = msg;
      el.classList.remove('hidden');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => {
        el.classList.add('hidden');
      }, timeout);
    }

    // Show/Hide Steps
    function showStep(stepId) {
      const allIds = ['stepProviders', 'stepContact', 'stepOtp', 'stepRegister', 'stepUsernameLogin'];
      allIds.forEach(id => {
        const el = $(id);
        if (el) el.classList.add('hidden');
      });
      const target = $(stepId);
      if (target) target.classList.remove('hidden');
    }

    // Update Title
    function setStepTitle(title, subtitle) {
      const wrapper = $('stepTitle');
      if (!wrapper) return;
      const h1 = wrapper.querySelector('h1');
      const p = wrapper.querySelector('p');
      if (h1) h1.textContent = title;
      if (p) p.textContent = subtitle;
    }

    // Timer
    function startTimer(seconds = 60) {
      const timer = $('timer');
      const btnResendOtp = $('btnResendOtp');
      if (!timer) return;
      
      let timeLeft = seconds;
      timer.textContent = `${timeLeft}`;
      if (btnResendOtp) btnResendOtp.disabled = true;
      
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft--;
        timer.textContent = `${timeLeft}`;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          if (btnResendOtp) btnResendOtp.disabled = false;
        }
      }, 1000);
    }

    // Registration Helpers
    function getAllUsers() {
      return JSON.parse(localStorage.getItem('imranUsers') || '[]');
    }

    function isUsernameAvailable(username) {
      if (!username) return false;
      const list = getAllUsers();
      return !list.some(u => (u.username || '').toLowerCase() === username.toLowerCase());
    }

    function validateRegisterForm() {
      const first = $('firstName').value.trim();
      const last = $('lastName').value.trim();
      const user = $('username').value.trim();
      const bro = $('brotherName').value.trim();
      const pass = $('password').value;
      const pass2 = $('passwordConfirm').value;

      let ok = true;

      if (!first || !last) ok = false;
      if (!/^[a-z0-9_]{3,}$/.test(user)) ok = false;

      if (!user || !isUsernameAvailable(user)) {
        ok = false;
        const hint = $('usernameHint');
        if (user) {
          hint.textContent = 'This username is already taken.';
          hint.classList.remove('text-gray-500');
          hint.classList.add('text-red-400');
        } else {
          hint.textContent = 'This must be unique.';
          hint.classList.remove('text-red-400');
          hint.classList.add('text-gray-500');
        }
      } else {
        const hint = $('usernameHint');
        hint.textContent = 'Great, this username is available.';
        hint.classList.remove('text-red-400');
        hint.classList.add('text-green-400');
      }

      if (bro !== 'IMRAN KHAN') ok = false;
      if (!pass || pass.length < 8 || pass !== pass2) ok = false;

      const btnReg = $('btnRegister');
      if (btnReg) {
        if (ok) {
          btnReg.classList.remove('opacity-60', 'cursor-not-allowed');
        } else {
          btnReg.classList.add('opacity-60', 'cursor-not-allowed');
        }
      }

      return ok;
    }

    // DOM Ready
    document.addEventListener('DOMContentLoaded', function () {
      console.log('‚úÖ DOM Ready');

      // All your existing event listeners...
      // (Google Sign-in, Login, Username, OTP, Registration, etc.)
      // ... (tumhara pura existing code yahan rahega)

      console.log('‚úÖ All handlers initialized');
    });

    // ===== PWA INSTALL LOGIC (Outside DOMContentLoaded) =====
    let deferredPrompt;

    // Listen for install prompt
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('üí° PWA Install prompt available');
      e.preventDefault();
      deferredPrompt = e;
      
      const installBtn = $('pwaInstallBtn');
      if (installBtn) {
        installBtn.classList.add('visible');
        console.log('‚úÖ Install button visible');
      }
    });

    // Track PWA installation
    window.addEventListener('appinstalled', () => {
      console.log('üéâ PWA installed on device');
      const installBtn = $('pwaInstallBtn');
      if (installBtn) {
        installBtn.classList.remove('visible');
      }
      showToast('üéâ App installed! Open from home screen.');
    });

    // Handle install button click (when DOM is ready)
    window.addEventListener('DOMContentLoaded', () => {
      const installBtn = $('pwaInstallBtn');
      
      if (installBtn) {
        installBtn.addEventListener('click', async () => {
          console.log('üîò Install button clicked');
          
          if (!deferredPrompt) {
            console.log('‚ö†Ô∏è Install prompt not available');
            
            // iOS check
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (isIOS) {
              showToast('On iOS: Tap Share ‚Üí Add to Home Screen');
            } else {
              showToast('App is already installed or browser does not support installation.');
            }
            return;
          }
          
          // Show the install prompt
          deferredPrompt.prompt();
          
          // Wait for user response
          const { outcome } = await deferredPrompt.userChoice;
          console.log(`üë§ User response: ${outcome}`);
          
          if (outcome === 'accepted') {
            console.log('‚úÖ PWA installed successfully');
            showToast('‚úÖ App installed successfully!');
          } else {
            console.log('‚ùå User cancelled installation');
          }
          
          // Clear the saved prompt
          deferredPrompt = null;
          installBtn.classList.remove('visible');
        });
      }

      // Hide button if already in standalone mode
      if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('üì± Running in standalone mode');
        if (installBtn) {
          installBtn.style.display = 'none';
        }
      }

      // iOS detection - show button always
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator.standalone);

      if (isIOS && !isInStandaloneMode && installBtn) {
        console.log('üì± iOS detected - showing install button');
        installBtn.classList.add('visible');
      }
    });

    // PWA Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(reg => console.log('‚úÖ SW registered:', reg.scope))
          .catch(err => console.error('‚ùå SW failed:', err));
      });
    }
  </script>
</body>
</html>
