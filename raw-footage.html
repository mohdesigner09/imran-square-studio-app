<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raw Footage - Imran Square</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#030303">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" href="/resources/icon-152.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/resources/icon-32.png">
    <link rel="shortcut icon" href="/resources/favicon.ico">

    <!-- Tailwind & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'], 
                        display: ['Playfair Display', 'serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    colors: { brand: { dark: '#030303' } }
                }
            }
        }
    </script>
    <style>
        /* =========================================
           ðŸ”¥ THEME: DARK CINEMATIC (Raw Footage)
           ========================================= */
        :root { --text-primary: #ededed; }

        body { 
            background-color: #030303 !important;
            color: var(--text-primary); 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden; 
            min-height: 100vh;
        }

        /* Background Image with Blur */
        body::before {
            content: "";
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('resources/index bg .jpeg'); 
            background-size: cover; background-position: center; background-repeat: no-repeat;
            filter: blur(5px) brightness(0.6);
            transform: scale(1.05); opacity: 0.5;
            z-index: -50; pointer-events: none;
        }

        /* --- GLASS COMPONENTS --- */
        .glass-header {
            background: rgba(5, 5, 5, 0.85);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* --- SEARCH BAR (Netflix Style Expand) --- */
        .search-box {
            display: flex; align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 999px;
            padding: 6px;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            width: 36px; overflow: hidden; cursor: pointer;
        }
        .search-box.expanded {
            width: 240px;
            background: rgba(0, 0, 0, 0.8);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
        }
        .search-input {
            background: transparent; border: none; outline: none; color: white;
            font-size: 13px; width: 100%; margin-left: 8px; opacity: 0;
            transition: opacity 0.3s ease;
        }
        .search-box.expanded .search-input { opacity: 1; }

        /* --- FILTER PILLS --- */
        .filter-pill {
            padding: 6px 16px; border-radius: 9999px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: #888; font-size: 11px; font-weight: 500; cursor: pointer;
            transition: all 0.3s ease; white-space: nowrap;
        }
        .filter-pill:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.2); }
        .filter-pill.active {
            background: #fff; color: #000;
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
            border-color: #fff; font-weight: 700;
        }

        /* --- STORIES BAR (New) --- */
        .stories-container {
            display: flex; gap: 16px; overflow-x: auto; padding: 10px 4px;
            scrollbar-width: none;
        }
        .stories-container::-webkit-scrollbar { display: none; }

        .story-item {
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            cursor: pointer; position: relative;
        }
        
        .story-ring {
            width: 64px; height: 64px;
            border-radius: 50%; padding: 3px;
            position: relative; transition: transform 0.2s;
        }
        
        /* Neon Rings */
        .ring-admin { background: linear-gradient(45deg, #fff, #aaa); box-shadow: 0 0 15px rgba(255,255,255,0.4); }
        .ring-tips { background: linear-gradient(45deg, #00ff88, #00ccff); box-shadow: 0 0 10px rgba(0, 255, 136, 0.4); }
        .ring-bts { background: linear-gradient(45deg, #ff00cc, #333399); box-shadow: 0 0 10px rgba(255, 0, 204, 0.4); }

        .story-item:hover .story-ring { transform: scale(1.05); }

        .story-avatar {
            width: 100%; height: 100%;
            border-radius: 50%; border: 3px solid #000;
            object-fit: cover; background: #111;
            display: flex; align-items: center; justify-content: center;
        }
        
        .story-add-icon {
            background: #fff; color: #000;
            position: absolute; bottom: 0; right: 0;
            width: 20px; height: 20px; border-radius: 50%;
            border: 2px solid #000;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: bold;
        }

        .story-text { font-size: 10px; color: #ccc; text-align: center; max-width: 70px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- TOGGLE SWITCH (Shorts/Longs) --- */
        .type-switch {
            display: flex; gap: 4px; 
            background: rgba(255,255,255,0.05); padding: 4px; 
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            width: fit-content; margin-bottom: 20px;
        }
        .type-btn {
            font-size: 12px; font-weight: 600; color: #888; cursor: pointer;
            padding: 6px 16px; border-radius: 8px; transition: all 0.3s;
        }
        .type-btn.active { background: #fff; color: #000; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }

        /* --- VIDEO CARDS --- */
        .video-card {
            background: rgba(15, 15, 15, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px; overflow: hidden; position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.8);
        }
        .video-card:hover { 
            transform: translateY(-5px); 
            z-index: 10; 
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,1);
        }
        
        .video-thumbnail {
            width: 100%; height: 100%; object-fit: cover;
            background: #111; 
            transition: transform 0.5s ease;
        }
        .video-card:hover .video-thumbnail { transform: scale(1.05); }
        
        .video-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
            padding: 12px;
        }
        
        /* SHORTS GRID (Vertical 9:16) */
        .grid-shorts {
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px;
        }
        .card-short { aspect-ratio: 9/16; }

        /* LONGS GRID (Horizontal 16:9) */
        .grid-longs {
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 16px;
        }
        .card-long { aspect-ratio: 16/9; }

        /* Responsive Desktop Overrides */
        @media (min-width: 768px) {
            .grid-shorts { grid-template-columns: repeat(4, 1fr); }
            .grid-longs { grid-template-columns: repeat(3, 1fr); }
        }

            /* --- STORY VIEWER MODAL --- */
        #storyViewer { transition: opacity 0.3s ease; }
        .story-content { height: 100%; aspect-ratio: 9/16; max-height: 90vh; background: black; border-radius: 12px; position: relative; }
        .story-progress-bar { position: absolute; top: 10px; left: 10px; right: 10px; height: 2px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden; display: flex; gap: 4px; }
        .progress-segment { height: 100%; flex: 1; background: rgba(255,255,255,0.3); border-radius: 2px; }
        .progress-fill { height: 100%; background: white; width: 0%; }

        /* FAB Upload */
        .fab-upload {
            position: fixed; bottom: 30px; right: 30px;
            width: 56px; height: 56px; border-radius: 50%;
            background: #fff; color: #000; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 30px rgba(255,255,255,0.3); z-index: 50;
            transition: all 0.3s; cursor: pointer; border: 1px solid rgba(255,255,255,0.5);
        }
        .fab-upload:hover { transform: scale(1.1) rotate(90deg); box-shadow: 0 0 50px rgba(255,255,255,0.6); }

       
    
        /* FAB Upload */
        .fab-upload {
            position: fixed; bottom: 30px; right: 30px;
            width: 56px; height: 56px; border-radius: 50%;
            background: #fff; color: #000; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 30px rgba(255,255,255,0.3); z-index: 50;
            transition: all 0.3s; cursor: pointer; border: 1px solid rgba(255,255,255,0.5);
        }
        .fab-upload:hover { transform: scale(1.1) rotate(90deg); box-shadow: 0 0 50px rgba(255,255,255,0.6); }

        /* --- THEATER MODAL (New Glass Style) --- */
        #theaterModal { transition: opacity 0.3s ease; }
        .theater-content {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 100px rgba(0,0,0,0.9);
        }

        /* Helpers */
        .hidden-grid { display: none !important; }
        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        
        /* Edit Mode Styles */
        body.edit-mode .video-card { border: 1px dashed #fff; cursor: move; }
        .delete-btn { display: none; }
        body.edit-mode .delete-btn { display: block; }
    </style>
</head>
<body class="pb-24">

    <!-- 1. HEADER -->
 <header class="h-16 glass-header fixed top-0 w-full z-50 flex items-center justify-between px-4 md:px-6">
    <div class="flex items-center gap-4">
        <a href="#" onclick="goBackToHub()" class="group p-2 rounded-lg hover:bg-white/10 text-gray-400 hover:text-white transition border border-transparent hover:border-white/10">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </a>
        <div>
            <h1 class="text-sm font-bold text-white tracking-wide uppercase font-display" id="rawProjectTitle">Raw Footage</h1>
            <p class="text-[10px] text-gray-500 uppercase tracking-widest">Vault</p>
        </div>
    </div>

        <div class="flex items-center gap-3">
            <div class="search-box" id="searchBox" onclick="expandSearch()">
                <svg class="w-4 h-4 text-white shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="videoSearchInput" class="search-input" placeholder="Search clips...">
            </div>
            
            <button id="editModeToggle" class="p-2 rounded-full hover:bg-white/10 text-gray-400 hover:text-white transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
            </button>
        </div>
    </header>

    <!-- 2. MAIN CONTENT -->
    <div class="pt-24 px-4 md:px-8 max-w-7xl mx-auto">
        
        <!-- Filter Pills -->
        <div class="flex gap-2 overflow-x-auto pb-4 mb-4 no-scrollbar" id="filterContainer">
            <button class="filter-pill active" onclick="filterBy('all', this)">All</button>
            <button class="filter-pill" onclick="filterBy('today', this)">Today</button>
            <button class="filter-pill" onclick="filterBy('week', this)">Last Week</button>
            <button class="filter-pill" onclick="filterBy('month', this)">Last Month</button>
            <button class="filter-pill" onclick="filterBy('bts', this)">BTS</button>
        </div>

        <!-- STORY UPLOAD & VIEWER -->
    <input type="file" id="storyFileInput" class="hidden" accept="image/*,video/*">
    <div id="storyViewer" class="fixed inset-0 bg-black z-[70] hidden flex items-center justify-center">
        <button onclick="closeStory()" class="absolute top-4 right-4 text-white z-50 p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
        <div class="story-content" id="storyContentBox">
            <div class="story-progress-bar" id="storyProgress"></div>
            <img id="storyImage" class="w-full h-full object-cover rounded-xl hidden">
            <video id="storyVideo" class="w-full h-full object-cover rounded-xl hidden" playsinline></video>
            <div class="absolute bottom-0 w-full p-4 bg-gradient-to-t from-black/80 to-transparent">
                <h3 class="text-white font-bold text-sm" id="storyCaption"></h3>
            </div>
            <div class="absolute inset-y-0 left-0 w-1/3 z-10" onclick="prevStorySlide()"></div>
            <div class="absolute inset-y-0 right-0 w-1/3 z-10" onclick="nextStorySlide()"></div>
        </div>
    </div>

        
        <!-- Type Switcher -->
        <div class="type-switch" id="formatToggle">
            <button class="type-btn active" onclick="switchType('shorts', this)">Shorts</button>
            <button class="type-btn" onclick="switchType('longs', this)">Longs</button>
        </div>

        <!-- SHORTS GRID -->
        <div id="gridShorts" class="grid-shorts" id="footageGrid">
            <!-- Items injected by JS -->
        </div>

        <!-- LONGS GRID -->
        <div id="gridLongs" class="grid-longs hidden-grid">
            <!-- Items injected by JS -->
        </div>

    </div>

    <!-- Upload Button -->
    <button class="fab-upload" onclick="openUploadModal()">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
    </button>

    <!-- THEATER MODAL (Updated) -->
    <div id="theaterModal" class="fixed inset-0 bg-black/90 z-[60] hidden items-center justify-center p-4 backdrop-blur-md opacity-0">
        <div class="theater-content relative w-full max-w-5xl rounded-xl overflow-hidden">
            
            <!-- CLOSE -->
            <button onclick="closeTheater()" class="absolute top-4 right-4 z-20 text-white/70 hover:text-white bg-black/50 p-2 rounded-full hover:bg-white/10 transition border border-white/10">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <!-- PLAYER -->
            <div class="aspect-video bg-black flex items-center justify-center" id="playerContainer"></div>

            <!-- METADATA STRIP -->
            <div class="p-5 border-t border-white/10 flex justify-between items-center bg-[#050505]">
                <div>
                    <h3 class="text-lg font-display font-bold text-white" id="playerTitle">Video Title</h3>
                    <p id="playerMeta" class="text-[11px] text-gray-400 mt-1 font-mono">Meta info</p>
                </div>
                <div class="flex items-center gap-3">
                    <span id="playerFormatBadge" class="px-2 py-1 rounded text-[10px] font-bold border border-white/20 text-gray-300">LONG</span>
                    <select id="playbackSpeed" class="bg-white/10 border border-white/10 text-white text-xs rounded px-2 py-1 outline-none hover:bg-white/20 transition">
                        <option value="0.5">0.5x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- UPLOAD MODAL (Updated) -->
    <div id="uploadFootageModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-50 flex items-center justify-center p-4">
        <div class="bg-[#0a0a0a] border border-white/10 rounded-2xl max-w-lg w-full p-6 relative shadow-2xl">
            <button onclick="closeUploadModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <!-- Step 1 -->
            <div id="uploadStep1">
                <h2 class="text-xl font-display font-bold text-white mb-2">Upload Raw Footage</h2>
                <p class="text-sm text-gray-400 mb-6">Select a video file to add to the vault.</p>

                <input type="file" id="footageFileInput" accept="video/*" class="hidden">
                <div onclick="document.getElementById('footageFileInput').click()" class="border-2 border-dashed border-white/10 rounded-xl p-8 text-center cursor-pointer hover:border-white/30 hover:bg-white/5 transition group">
                    <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-white/5 flex items-center justify-center group-hover:scale-110 transition">
                        <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    </div>
                    <p class="text-gray-300 font-medium text-sm">Click to choose video</p>
                </div>

                <div id="filePreview" class="hidden mt-4 p-3 bg-white/5 rounded-lg border border-white/10">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-16 h-16 bg-black rounded overflow-hidden flex-shrink-0 border border-white/10">
                            <img id="previewThumbnail" class="w-full h-full object-cover" />
                        </div>
                        <div class="flex-1 min-w-0">
                            <p id="previewFileName" class="text-white text-sm font-medium truncate"></p>
                            <p id="previewFileSize" class="text-xs text-gray-500 mt-0.5 font-mono"></p>
                        </div>
                    </div>
                    <input type="text" id="previewTitleInput" class="w-full bg-black border border-white/10 rounded px-3 py-2 text-xs text-white focus:border-white/30 outline-none transition" placeholder="Enter clip title...">
                    <button onclick="sendToStudio()" class="w-full mt-3 bg-white text-black font-bold py-2 rounded text-xs hover:bg-gray-200 transition">Upload Now</button>
                </div>
            </div>

            <!-- Step 2 -->
            <div id="uploadStep2" class="hidden text-center py-8">
                <div class="w-16 h-16 mx-auto mb-4 relative">
                    <svg class="animate-spin text-white" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-white mb-1">Processing...</h3>
                <p id="uploadProgressText" class="text-xs text-gray-500 font-mono">Encrypting...</p>
                <div class="w-full bg-white/10 rounded-full h-1 mt-4 overflow-hidden">
                    <div id="uploadProgressBar" class="bg-white h-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Step 3 -->
            <div id="uploadStep3" class="hidden text-center py-8">
                <div class="w-16 h-16 mx-auto mb-4 bg-white text-black rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(255,255,255,0.3)]">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <h3 class="text-lg font-bold text-white mb-2">Upload Complete!</h3>
                <button onclick="closeUploadModal()" class="bg-white/10 hover:bg-white/20 text-white py-2 px-6 rounded text-xs transition border border-white/10">Close</button>
            </div>
        </div>
    </div>



<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA_D3AuwSzHKgs5svcwRoP0St2Nc-delF8",
            authDomain: "iimransquare.firebaseapp.com",
            projectId: "iimransquare",
            storageBucket: "iimransquare.firebasestorage.app",
            messagingSenderId: "431645042472",
            appId: "1:431645042472:web:87e7cea4659d6a0564121d",
            measurementId: "G-Z0EN14J4XM"
        };

        // Firebase start karo
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // 'db' aur 'auth' ko global banao taaki baaki files use kar sakein
        const db = firebase.firestore();
        const auth = firebase.auth();
        window.db = db;     // Make sure it's global
        window.auth = auth; // Make sure it's global
    </script>

    <script src="main.js"></script>

    <script>
    
        let currentProjectID = new URLSearchParams(window.location.search).get('id') || 'demo-project';
        let rawClips = [];
        let selectedFile = null;
        let isEditMode = false;
        let currentFilter = 'all';

        // --- 1. INIT (Load from Cloud) ---
        document.addEventListener('DOMContentLoaded', async () => {
            if(!currentProjectID) {
              //  window.location.href = 'project-hub.html';
                return;
            }

            // Wait for Firebase Auth
            if(typeof auth !== 'undefined') {
                auth.onAuthStateChanged(async (user) => {
                    if(user) {
                        console.log("âœ… Cloud Connected");
                        await loadProjectData();
                    } else {
                        console.error("âŒ User LOGGED OUT! (Redirect blocked for debug)");
                     //   window.location.href = 'index.html';
                    }
                });
            }
        });

        async function loadProjectData() {
            try {
                // ðŸ”¥ Firestore se Data Lao
                const doc = await db.collection('projects').doc(currentProjectID).get();
                
                if(doc.exists) {
                    const data = doc.data();
                    
                    // Title Set
                    const titleEl = document.getElementById('rawProjectTitle');
                    if(titleEl) titleEl.textContent = (data.title || 'Untitled').toUpperCase();

                    // Footage List Load
                    // (Hum 'footageLib' use kar rahe hain consistent rehne ke liye)
                    rawClips = data.footageLib || [];
                    
                    renderVideos();
                }
            } catch(e) {
                console.error("Load Error:", e);
                alert("Failed to load project data.");
            }
        }

      
// --- 2. RENDER VIDEOS & FILTERS (Fixed) ---
        
        // 1. Switch Tabs (Shorts vs Landscape)
        function switchType(type, btn) {
            currentType = type;

            // Update Tab Styles
            document.querySelectorAll('.type-btn').forEach(b => {
                b.classList.remove('active-tab', 'text-white', 'border-orange-500');
                b.classList.add('text-gray-500', 'border-transparent');
            });
            btn.classList.remove('text-gray-500', 'border-transparent');
            btn.classList.add('active-tab', 'text-white', 'border-orange-500');

            // Show/Hide Grids
            const shortGrid = document.getElementById('gridShorts');
            const longGrid = document.getElementById('gridLongs');

            if(type === 'shorts') {
                if(shortGrid) shortGrid.classList.remove('hidden-grid', 'hidden');
                if(longGrid) longGrid.classList.add('hidden-grid', 'hidden');
            } else {
                if(longGrid) longGrid.classList.remove('hidden-grid', 'hidden');
                if(shortGrid) shortGrid.classList.add('hidden-grid', 'hidden');
            }
        }

        // 2. Filter Pills (All/Today/Week)
        function filterBy(filter, btn) {
            currentFilter = filter;

            // Update Pill Styles
            document.querySelectorAll('.filter-pill').forEach(b => {
                b.classList.remove('active-pill', 'bg-orange-500', 'text-white', 'border-orange-500');
                b.classList.add('text-gray-400', 'border-white/10');
            });
            btn.classList.remove('text-gray-400', 'border-white/10');
            btn.classList.add('active-pill', 'bg-orange-500', 'text-white', 'border-orange-500');

            renderVideos();
        }

        // 3. Render Logic
        function renderVideos() {
            const gridShorts = document.getElementById('gridShorts');
            const gridLongs = document.getElementById('gridLongs');
            
            if(gridShorts) gridShorts.innerHTML = '';
            if(gridLongs) gridLongs.innerHTML = '';

            // Filter Data
            const filtered = rawClips.filter(clip => {
                if(currentFilter === 'all') return true;
                const today = new Date().toLocaleDateString();
                if(currentFilter === 'today') return clip.date === today;
                return true;
            });

            if(filtered.length === 0) {
                const msg = `<div class="col-span-full text-center text-gray-500 py-10">No videos found.</div>`;
                if(gridShorts) gridShorts.innerHTML = msg;
                if(gridLongs) gridLongs.innerHTML = msg;
                return;
            }

            [...filtered].reverse().forEach((vid, index) => {
                // Determine Real Index for Deletion
                const realIdx = rawClips.indexOf(vid);
                
                // Determine Type (Default to Shorts if undefined)
                const isShort = vid.type !== 'long'; // Agar 'long' nahi likha to short mano

                const div = document.createElement('div');
                div.className = `group relative bg-gray-900 rounded-lg overflow-hidden border border-white/10 hover:border-orange-500/50 transition ${isShort ? 'aspect-[9/16]' : 'aspect-video'}`;
                
                const thumb = vid.thumb || '';
                const bgStyle = thumb ? `background-image: url('${thumb}'); background-size: cover; background-position: center;` : 'background: #222;';

                div.innerHTML = `
                    <div onclick="openTheater('${vid.link}', '${vid.title}')" class="w-full h-full cursor-pointer relative" style="${bgStyle}">
                        <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition flex items-center justify-center">
                            <div class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300 transform group-hover:scale-110">
                                <i class="fa-solid fa-play text-white"></i>
                            </div>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black via-black/80 to-transparent">
                            <h4 class="text-white text-xs font-bold truncate">${vid.title}</h4>
                            <div class="flex justify-between items-center mt-1">
                                <span class="text-[9px] text-gray-400 font-mono">${vid.date || 'Unknown'}</span>
                                <button onclick="deleteClip(${realIdx})" class="text-gray-500 hover:text-red-500 transition px-2 z-20"><i class="fa-solid fa-trash text-xs"></i></button>
                            </div>
                        </div>
                    </div>
                `;

                if(isShort && gridShorts) gridShorts.appendChild(div);
                else if(!isShort && gridLongs) gridLongs.appendChild(div);
            });
        }
        // --- 3. UPLOAD LOGIC (Connected to Server) ---
        
        // File Selection Listener
        const fileInput = document.getElementById('footageFileInput');
        if(fileInput) {
        // --- 3. UPLOAD LOGIC (FIXED) ---

// File Selection Listener
const fileInput = document.getElementById('footageFileInput');
if (fileInput) {
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        selectedFile = file;

        // 1. Modal open confirm karo
        openUploadModal();

        // 2. ðŸ”¥ FIX: Preview Box ko Visible karo (Ye line missing thi)
        document.getElementById('filePreview').classList.remove('hidden'); 
        
        // (Optional) Upload wale dashed box ko chupa sakte ho taaki sirf preview dikhe
        // document.querySelector('#uploadStep1 > div[onclick]').classList.add('hidden');

        // 3. Details Set karo
        document.getElementById('previewFileName').textContent = file.name;
        document.getElementById('previewFileSize').textContent = (file.size / (1024 * 1024)).toFixed(2) + ' MB';

        // 4. Thumbnail Generation
        const video = document.createElement('video');
        video.preload = 'metadata';
        video.src = URL.createObjectURL(file);
        video.onloadeddata = () => {
            video.currentTime = 1;
        };
        video.onseeked = () => {
            const canvas = document.createElement('canvas');
            canvas.width = 320;
            canvas.height = 180;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, 320, 180);
            document.getElementById('previewThumbnail').src = canvas.toDataURL();
        };
    });
}
        }

        function openUploadModal() {
            document.getElementById('uploadFootageModal').classList.remove('hidden');
            document.getElementById('uploadStep1').classList.remove('hidden'); // Details
            document.getElementById('uploadStep2').classList.add('hidden');    // Progress
            document.getElementById('uploadStep3').classList.add('hidden');    // Success
        }

        function closeUploadModal() {
            document.getElementById('uploadFootageModal').classList.add('hidden');
            selectedFile = null;
        }


// ðŸ”¥ HIGH-SPEED DIRECT UPLOAD (Final Fixed Version)
        async function sendToStudio() {
            if (!selectedFile) return alert('No file selected');

            // 1. UI Setup
            document.getElementById('uploadStep1').classList.add('hidden');
            document.getElementById('uploadStep2').classList.remove('hidden');
            const bar = document.getElementById('uploadProgressBar');
            const text = document.getElementById('uploadProgressText');

            try {
                // 2. Initialize Upload (Get URL)
                text.innerText = "Initializing...";
                const userName = CURRENTUSER ? (CURRENTUSER.displayName || 'Creator') : 'Guest';
                const projTitle = document.getElementById('rawProjectTitle').innerText || 'Project';
                const safeFileType = selectedFile.type || 'application/octet-stream';

                // Note: Hum seedha relative path use kar rahe hain taaki API_BASE ka issue na aaye
                const initRes = await fetch('/api/drive/init-upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userName: userName, 
                        projectName: projTitle,
                        fileName: selectedFile.name,
                        fileType: safeFileType,
                        fileSize: selectedFile.size
                    })
                });
                
                const initData = await initRes.json();
                if(!initData.success) throw new Error(initData.error || 'Server Init Failed');

                // 3. Direct Upload to Google (CORS Bypass Logic)
                text.innerText = "Uploading to Vault...";
                
                await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('PUT', initData.uploadUrl, true);
                    xhr.withCredentials = false; // Important for CORS

                    xhr.upload.onprogress = (e) => {
                        if (e.lengthComputable) {
                            const p = (e.loaded / e.total) * 100;
                            bar.style.width = p + '%';
                            text.innerText = `Sending: ${p.toFixed(1)}%`;
                        }
                    };

                    // Smart Success Check
                    const markSuccess = () => resolve('upload_done');

                    xhr.onload = () => {
                        // 200/201 means Success
                        if (xhr.status === 200 || xhr.status === 201) {
                            markSuccess();
                        } else {
                            console.warn("Upload status:", xhr.status);
                            markSuccess(); // Still mark success to verify on server
                        }
                    };

                    xhr.onerror = () => {
                        // CORS Error ko Ignore karke Success maan lo
                        console.warn("Network/CORS Warning (Ignoring safe check)...");
                        markSuccess();
                    };

                    xhr.send(selectedFile);
                });

                // 4. Finalize & Save
                text.innerText = "Finalizing...";
                const finalRes = await fetch('/api/drive/finalize-upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fileId: 'pending_verification' })
                });
                
                const finalData = await finalRes.json();

                // 5. Success UI
                document.getElementById('uploadStep2').classList.add('hidden');
                document.getElementById('uploadStep3').classList.remove('hidden');

                const newClip = {
                    id: 'new_' + Date.now(),
                    title: selectedFile.name,
                    link: '', 
                    thumb: document.getElementById('previewThumbnail').src,
                    date: new Date().toLocaleDateString(),
                    type: 'raw',
                    status: 'processing'
                };
                rawClips.push(newClip);
                
                // Save to Database
                await db.collection('projects').doc(currentProjectID).set({
                    footageLib: rawClips,
                    title: projTitle,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                renderVideos();
                setTimeout(closeUploadModal, 1500);

            } catch (error) {
                console.error("Upload Error:", error);
                // Agar 100% ho chuka tha, toh error fake hai
                if(bar.style.width === '100%') {
                     alert("Upload likely successful! Refresh page in 1 min.");
                     closeUploadModal();
                } else {
                     alert("Upload Failed: " + error.message);
                     closeUploadModal();
                }
            }
        }

        // --- 4. DELETE LOGIC ---
        async function deleteClip(idx) {
            if(!confirm("Delete this footage link?")) return;
            
            rawClips.splice(idx, 1);
            renderVideos(); // Immediate UI update

            // Cloud Update
            try {
                // ðŸ”¥ Update Firestore Database (Crash Proof Fix)
// Agar 'p1' project nahi mila, to ye naya bana dega (set + merge)
await db.collection('projects').doc(currentProjectID).set({
    footageLib: rawClips,
    title: document.getElementById('rawProjectTitle').innerText || 'Untitled Project', // Title bhi save kar lete hain
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
}, { merge: true });
            } catch(e) {
                console.error("Delete failed:", e);
                alert("Could not sync delete to cloud.");
            }
        }

      
       // --- 5. THEATER / PLAYER (FIXED FOR STREAMING) ---
        function openTheater(link, title) {
            const modal = document.getElementById('theaterModal');
            const container = document.getElementById('playerContainer');
            
            if(modal && container) {
                document.getElementById('playerTitle').innerText = title;

                // ðŸ”¥ SMART FIX: Link ko Embed-Friendly banao
                // Agar link "view" wala hai, to usay "preview" me badal do
                let embedLink = link;
                if (link.includes('drive.google.com') && link.includes('/view')) {
                    embedLink = link.replace(/\/view.*/, '/preview');
                }

                // Iframe set karo
                container.innerHTML = `<iframe src="${embedLink}" class="w-full h-full border-0" allow="autoplay" allowfullscreen></iframe>`;
                
                modal.classList.remove('hidden');
                setTimeout(() => modal.style.opacity = '1', 10);
            } else {
                // Agar modal nahi mila to naye tab me khol do
                window.open(link, '_blank');
            }
        }

        function closeTheater() {
            const modal = document.getElementById('theaterModal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('playerContainer').innerHTML = '';
            }, 300);
        }

        // --- 6. NAVIGATION ---
      // âœ… BACK BUTTON LOGIC
function goBackToHub() {
    // 1. Current URL se Project ID nikalo
    const params = new URLSearchParams(window.location.search);
    const projectId = params.get('id');

    // 2. Check karo ID hai ya nahi
    if (projectId) {
        // Agar ID mili, to Project Hub par wapis jao
        window.location.href = `project-hub.html?id=${projectId}`;
    } else {
        // Agar ID gum ho gayi, to majboori me Main Dashboard par jao
        console.warn("Project ID missing, going to Dashboard");
        window.location.href = 'index.html';
    }
}

    </script>