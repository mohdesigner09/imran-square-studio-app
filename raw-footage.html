<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raw Footage - Imran Square</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#030303">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" href="/resources/icon-152.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/resources/icon-32.png">
    <link rel="shortcut icon" href="/resources/favicon.ico">

    <!-- Tailwind & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'], 
                        display: ['Playfair Display', 'serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    colors: { brand: { dark: '#030303' } }
                }
            }
        }
    </script>
    <style>
        /* =========================================
           üî• THEME: DARK CINEMATIC (Raw Footage)
           ========================================= */
        :root { --text-primary: #ededed; }

        body { 
            background-color: #030303 !important;
            color: var(--text-primary); 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden; 
            min-height: 100vh;
        }

        /* Background Image with Blur */
        body::before {
            content: "";
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('resources/index bg .jpeg'); 
            background-size: cover; background-position: center; background-repeat: no-repeat;
            filter: blur(5px) brightness(0.6);
            transform: scale(1.05); opacity: 0.5;
            z-index: -50; pointer-events: none;
        }

        /* --- GLASS COMPONENTS --- */
        .glass-header {
            background: rgba(5, 5, 5, 0.85);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* --- SEARCH BAR (Netflix Style Expand) --- */
        .search-box {
            display: flex; align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 999px;
            padding: 6px;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            width: 36px; overflow: hidden; cursor: pointer;
        }
        .search-box.expanded {
            width: 240px;
            background: rgba(0, 0, 0, 0.8);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
        }
        .search-input {
            background: transparent; border: none; outline: none; color: white;
            font-size: 13px; width: 100%; margin-left: 8px; opacity: 0;
            transition: opacity 0.3s ease;
        }
        .search-box.expanded .search-input { opacity: 1; }

        /* --- FILTER PILLS --- */
        .filter-pill {
            padding: 6px 16px; border-radius: 9999px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: #888; font-size: 11px; font-weight: 500; cursor: pointer;
            transition: all 0.3s ease; white-space: nowrap;
        }
        .filter-pill:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.2); }
        .filter-pill.active {
            background: #fff; color: #000;
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
            border-color: #fff; font-weight: 700;
        }

        /* --- STORIES BAR (New) --- */
        .stories-container {
            display: flex; gap: 16px; overflow-x: auto; padding: 10px 4px;
            scrollbar-width: none;
        }
        .stories-container::-webkit-scrollbar { display: none; }

        .story-item {
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            cursor: pointer; position: relative;
        }
        
        .story-ring {
            width: 64px; height: 64px;
            border-radius: 50%; padding: 3px;
            position: relative; transition: transform 0.2s;
        }
        
        /* Neon Rings */
        .ring-admin { background: linear-gradient(45deg, #fff, #aaa); box-shadow: 0 0 15px rgba(255,255,255,0.4); }
        .ring-tips { background: linear-gradient(45deg, #00ff88, #00ccff); box-shadow: 0 0 10px rgba(0, 255, 136, 0.4); }
        .ring-bts { background: linear-gradient(45deg, #ff00cc, #333399); box-shadow: 0 0 10px rgba(255, 0, 204, 0.4); }

        .story-item:hover .story-ring { transform: scale(1.05); }

        .story-avatar {
            width: 100%; height: 100%;
            border-radius: 50%; border: 3px solid #000;
            object-fit: cover; background: #111;
            display: flex; align-items: center; justify-content: center;
        }
        
        .story-add-icon {
            background: #fff; color: #000;
            position: absolute; bottom: 0; right: 0;
            width: 20px; height: 20px; border-radius: 50%;
            border: 2px solid #000;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: bold;
        }

        .story-text { font-size: 10px; color: #ccc; text-align: center; max-width: 70px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- TOGGLE SWITCH (Shorts/Longs) --- */
        .type-switch {
            display: flex; gap: 4px; 
            background: rgba(255,255,255,0.05); padding: 4px; 
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            width: fit-content; margin-bottom: 20px;
        }
        .type-btn {
            font-size: 12px; font-weight: 600; color: #888; cursor: pointer;
            padding: 6px 16px; border-radius: 8px; transition: all 0.3s;
        }
        .type-btn.active { background: #fff; color: #000; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }

        /* --- VIDEO CARDS --- */
        .video-card {
            background: rgba(15, 15, 15, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px; overflow: hidden; position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.8);
        }
        .video-card:hover { 
            transform: translateY(-5px); 
            z-index: 10; 
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,1);
        }
        
        .video-thumbnail {
            width: 100%; height: 100%; object-fit: cover;
            background: #111; 
            transition: transform 0.5s ease;
        }
        .video-card:hover .video-thumbnail { transform: scale(1.05); }
        
        .video-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
            padding: 12px;
        }
        
        /* SHORTS GRID (Vertical 9:16) */
        .grid-shorts {
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px;
        }
        .card-short { aspect-ratio: 9/16; }

        /* LONGS GRID (Horizontal 16:9) */
        .grid-longs {
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 16px;
        }
        .card-long { aspect-ratio: 16/9; }

        /* Responsive Desktop Overrides */
        @media (min-width: 768px) {
            .grid-shorts { grid-template-columns: repeat(4, 1fr); }
            .grid-longs { grid-template-columns: repeat(3, 1fr); }
        }

            /* --- STORY VIEWER MODAL --- */
        #storyViewer { transition: opacity 0.3s ease; }
        .story-content { height: 100%; aspect-ratio: 9/16; max-height: 90vh; background: black; border-radius: 12px; position: relative; }
        .story-progress-bar { position: absolute; top: 10px; left: 10px; right: 10px; height: 2px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden; display: flex; gap: 4px; }
        .progress-segment { height: 100%; flex: 1; background: rgba(255,255,255,0.3); border-radius: 2px; }
        .progress-fill { height: 100%; background: white; width: 0%; }

        /* FAB Upload */
        .fab-upload {
            position: fixed; bottom: 30px; right: 30px;
            width: 56px; height: 56px; border-radius: 50%;
            background: #fff; color: #000; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 30px rgba(255,255,255,0.3); z-index: 50;
            transition: all 0.3s; cursor: pointer; border: 1px solid rgba(255,255,255,0.5);
        }
        .fab-upload:hover { transform: scale(1.1) rotate(90deg); box-shadow: 0 0 50px rgba(255,255,255,0.6); }

       
    
        /* FAB Upload */
        .fab-upload {
            position: fixed; bottom: 30px; right: 30px;
            width: 56px; height: 56px; border-radius: 50%;
            background: #fff; color: #000; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 30px rgba(255,255,255,0.3); z-index: 50;
            transition: all 0.3s; cursor: pointer; border: 1px solid rgba(255,255,255,0.5);
        }
        .fab-upload:hover { transform: scale(1.1) rotate(90deg); box-shadow: 0 0 50px rgba(255,255,255,0.6); }

        /* --- THEATER MODAL (New Glass Style) --- */
        #theaterModal { transition: opacity 0.3s ease; }
        .theater-content {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 100px rgba(0,0,0,0.9);
        }

        /* Helpers */
        .hidden-grid { display: none !important; }
        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        
        /* Edit Mode Styles */
        body.edit-mode .video-card { border: 1px dashed #fff; cursor: move; }
        .delete-btn { display: none; }
        body.edit-mode .delete-btn { display: block; }
    </style>
</head>
<body class="pb-24">

    <!-- 1. HEADER -->
 <header class="h-16 glass-header fixed top-0 w-full z-50 flex items-center justify-between px-4 md:px-6">
    <div class="flex items-center gap-4">
        <a href="#" onclick="goBackToHub()" class="group p-2 rounded-lg hover:bg-white/10 text-gray-400 hover:text-white transition border border-transparent hover:border-white/10">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </a>
        <div>
            <h1 class="text-sm font-bold text-white tracking-wide uppercase font-display" id="rawProjectTitle">Raw Footage</h1>
            <p class="text-[10px] text-gray-500 uppercase tracking-widest">Vault</p>
        </div>
    </div>

        <div class="flex items-center gap-3">
            <div class="search-box" id="searchBox" onclick="expandSearch()">
                <svg class="w-4 h-4 text-white shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="videoSearchInput" class="search-input" placeholder="Search clips...">
            </div>
            
            <button id="editModeToggle" class="p-2 rounded-full hover:bg-white/10 text-gray-400 hover:text-white transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
            </button>
        </div>
    </header>

    <!-- 2. MAIN CONTENT -->
    <div class="pt-24 px-4 md:px-8 max-w-7xl mx-auto">
        
        <!-- Filter Pills -->
        <div class="flex gap-2 overflow-x-auto pb-4 mb-4 no-scrollbar" id="filterContainer">
            <button class="filter-pill active" onclick="filterBy('all', this)">All</button>
            <button class="filter-pill" onclick="filterBy('today', this)">Today</button>
            <button class="filter-pill" onclick="filterBy('week', this)">Last Week</button>
            <button class="filter-pill" onclick="filterBy('month', this)">Last Month</button>
            <button class="filter-pill" onclick="filterBy('bts', this)">BTS</button>
        </div>

        <!-- STORY UPLOAD & VIEWER -->
    <input type="file" id="storyFileInput" class="hidden" accept="image/*,video/*">
    <div id="storyViewer" class="fixed inset-0 bg-black z-[70] hidden flex items-center justify-center">
        <button onclick="closeStory()" class="absolute top-4 right-4 text-white z-50 p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
        <div class="story-content" id="storyContentBox">
            <div class="story-progress-bar" id="storyProgress"></div>
            <img id="storyImage" class="w-full h-full object-cover rounded-xl hidden">
            <video id="storyVideo" class="w-full h-full object-cover rounded-xl hidden" playsinline></video>
            <div class="absolute bottom-0 w-full p-4 bg-gradient-to-t from-black/80 to-transparent">
                <h3 class="text-white font-bold text-sm" id="storyCaption"></h3>
            </div>
            <div class="absolute inset-y-0 left-0 w-1/3 z-10" onclick="prevStorySlide()"></div>
            <div class="absolute inset-y-0 right-0 w-1/3 z-10" onclick="nextStorySlide()"></div>
        </div>
    </div>

        
       <div class="mt-8 mb-24"> <div class="flex gap-4 mb-6 border-b border-white/10 pb-4">
        <button onclick="switchType('shorts', this)" class="type-btn text-gray-400 hover:text-white font-bold pb-2 transition border-b-2 border-transparent hover:border-white/20">
            Shorts / Reels
        </button>
        <button onclick="switchType('long', this)" class="type-btn active text-white font-bold pb-2 border-b-2 border-orange-500 transition">
            Long Videos
        </button>
    </div>

    <div id="gridShorts" class="hidden grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
        </div>

    <div id="gridLongs" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>

</div>

    <!-- Upload Button -->
    <button class="fab-upload" onclick="openUploadModal()">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
    </button>

    <!-- THEATER MODAL (Updated) -->
    <div id="theaterModal" class="fixed inset-0 bg-black/90 z-[60] hidden items-center justify-center p-4 backdrop-blur-md opacity-0">
        <div class="theater-content relative w-full max-w-5xl rounded-xl overflow-hidden">
            
            <!-- CLOSE -->
            <button onclick="closeTheater()" class="absolute top-4 right-4 z-20 text-white/70 hover:text-white bg-black/50 p-2 rounded-full hover:bg-white/10 transition border border-white/10">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <!-- PLAYER -->
            <div class="aspect-video bg-black flex items-center justify-center" id="playerContainer"></div>

            <!-- METADATA STRIP -->
            <div class="p-5 border-t border-white/10 flex justify-between items-center bg-[#050505]">
                <div>
                    <h3 class="text-lg font-display font-bold text-white" id="playerTitle">Video Title</h3>
                    <p id="playerMeta" class="text-[11px] text-gray-400 mt-1 font-mono">Meta info</p>
                </div>
                <div class="flex items-center gap-3">
                    <span id="playerFormatBadge" class="px-2 py-1 rounded text-[10px] font-bold border border-white/20 text-gray-300">LONG</span>
                    <select id="playbackSpeed" class="bg-white/10 border border-white/10 text-white text-xs rounded px-2 py-1 outline-none hover:bg-white/20 transition">
                        <option value="0.5">0.5x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- UPLOAD MODAL (Updated) -->
<div id="uploadFootageModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-50 flex items-center justify-center p-4">
    <div class="bg-[#0a0a0a] border border-white/10 rounded-2xl max-w-lg w-full p-6 relative shadow-2xl">
        
        <button onclick="closeUploadModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white transition z-10">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
<div id="uploadStep1">
    <h2 class="text-xl font-display font-bold text-white mb-2">Upload Footage</h2>
    <p class="text-sm text-gray-400 mb-6">Select a video to upload. We will auto-detect if it's a Short or Long video.</p>

    <input type="file" id="fileInput" accept="video/*" class="hidden">
    
    <div onclick="document.getElementById('fileInput').click()" class="border-2 border-dashed border-white/10 rounded-xl p-8 text-center cursor-pointer hover:border-orange-500/50 hover:bg-white/5 transition group">
        <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-white/5 flex items-center justify-center group-hover:scale-110 transition">
            <svg class="w-6 h-6 text-gray-300 group-hover:text-orange-500 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
        </div>
        <p class="text-gray-300 font-medium text-sm">Click to choose video</p>
    </div>

    <div id="filePreview" class="hidden mt-4">
        <div class="p-3 bg-white/5 rounded-lg border border-white/10 flex items-center gap-3 mb-4">
            <div class="w-16 h-9 bg-black rounded overflow-hidden flex-shrink-0 border border-white/10">
                <img id="previewThumbnail" class="w-full h-full object-cover opacity-80" />
            </div>
            <div class="flex-1 min-w-0 text-left">
                <p id="previewFileName" class="text-white text-sm font-medium truncate"></p>
                <span id="detectedBadge" class="inline-block mt-1 px-2 py-0.5 rounded text-[10px] font-bold bg-gray-700 text-gray-300">Detecting...</span>
            </div>
        </div>
        <button onclick="sendToStudio()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2.5 rounded-lg transition text-sm">
            Start Upload
        </button>
    </div>
    
    <p id="text" class="mt-3 text-center text-gray-500 text-xs font-mono h-4"></p>
</div>

        <div id="uploadStep2" class="hidden text-center py-8">
            <div class="w-16 h-16 mx-auto mb-4 relative">
                <svg class="animate-spin text-orange-500" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-bold text-white mb-1">Uploading to Vault...</h3>
            <p class="text-xs text-gray-500 font-mono">Do not close this window</p>
        </div>

        <div id="uploadStep3" class="hidden text-center py-8">
            <div class="w-16 h-16 mx-auto mb-4 bg-green-500/20 text-green-400 rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(74,222,128,0.2)]">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h3 class="text-lg font-bold text-white mb-2">Upload Complete!</h3>
            <p class="text-sm text-gray-400 mb-6">Your footage has been securely stored.</p>
            <button onclick="closeUploadModal()" class="bg-white/10 hover:bg-white/20 text-white py-2 px-8 rounded-lg text-sm transition border border-white/10">Close</button>
        </div>

    </div>
</div>



<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA_D3AuwSzHKgs5svcwRoP0St2Nc-delF8",
            authDomain: "iimransquare.firebaseapp.com",
            projectId: "iimransquare",
            storageBucket: "iimransquare.firebasestorage.app",
            messagingSenderId: "431645042472",
            appId: "1:431645042472:web:87e7cea4659d6a0564121d",
            measurementId: "G-Z0EN14J4XM"
        };

        // Firebase start karo
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // 'db' aur 'auth' ko global banao taaki baaki files use kar sakein
        const db = firebase.firestore();
        const auth = firebase.auth();
        window.db = db;     // Make sure it's global
        window.auth = auth; // Make sure it's global
    </script>

   
<script>
    // ==========================================
    // üß† IMMORTAL MEMORY ENGINE (v8.0)
    // ==========================================
    const PROJECT_ID = new URLSearchParams(window.location.search).get('id');
    const CACHE_KEY = `project_data_${PROJECT_ID}`; // Har project ki alag memory
    
    let rawClips = [];
    let selectedFile = null;
    let currentUser = null;
    let detectedType = 'long';

    if (!PROJECT_ID) {
        alert("‚ö†Ô∏è No Project ID.");
        window.location.href = 'index.html';
    }

    // ==========================================
    // 1. INSTANT LOAD (Internet ki zaroorat nahi)
    // ==========================================
    document.addEventListener('DOMContentLoaded', () => {
        console.log("üöÄ Engine Starting...");

        // A. Cache se Data Uthao (0.1 Second mein load hoga)
        const cachedData = localStorage.getItem(CACHE_KEY);
        if (cachedData) {
            console.log("‚ö° Loaded from Memory (Instant)");
            rawClips = JSON.parse(cachedData);
            renderVideos(); // Turant dikhao
        }

        // B. Background mein User Check karo
        if (typeof firebase !== 'undefined' && firebase.auth) {
            firebase.auth().onAuthStateChanged(async (user) => {
                if (user) {
                    console.log("‚úÖ Online Connected:", user.email);
                    currentUser = { uid: user.uid, email: user.email };
                    // Ab Database se latest data check karo (Sync)
                    await syncWithDatabase(); 
                }
            });
        }
    });

    // ==========================================
    // 2. DATABASE SYNC (Background Process)
    // ==========================================
    async function syncWithDatabase() {
        if (!window.db) return;
        try {
            const doc = await window.db.collection('projects').doc(PROJECT_ID).get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('rawProjectTitle').innerText = (data.title || 'Untitled').toUpperCase();
                
                // Server se naya data lo
                const serverClips = data.footageLib || [];
                
                // CLEANING: Agar server par koi ganda link hai, use hatao
                const cleanClips = serverClips.map(clip => {
                    if(clip.thumb && clip.thumb.startsWith('blob:')) 
                        clip.thumb = "https://placehold.co/320x180/1a1a1a/FFFFFF/png?text=VIDEO";
                    return clip;
                });

                // Update RAM & Cache
                rawClips = cleanClips;
                localStorage.setItem(CACHE_KEY, JSON.stringify(rawClips)); // Save for next refresh
                renderVideos();
            } else {
                // First Time Setup
                await window.db.collection('projects').doc(PROJECT_ID).set({
                    title: 'New Project', footageLib: []
                }, { merge: true });
            }
        } catch (e) { console.error("Sync Error:", e); }
    }

    // ==========================================
    // 3. UPLOAD LOGIC (Save to Memory + Cloud)
    // ==========================================
    const fileInput = document.getElementById('fileInput');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            selectedFile = file;
            document.getElementById('filePreview').classList.remove('hidden');
            document.getElementById('previewFileName').innerText = file.name;
            
            // Auto-Detect Logic
            const video = document.createElement('video');
            video.preload = 'metadata';
            video.src = URL.createObjectURL(file);
            video.onloadedmetadata = function() {
                window.URL.revokeObjectURL(video.src);
                if (video.videoHeight > video.videoWidth) {
                    detectedType = 'shorts';
                    document.getElementById('detectedBadge').innerText = "Detected: SHORT";
                    document.getElementById('detectedBadge').className = "inline-block mt-1 px-2 py-0.5 rounded text-[10px] font-bold bg-purple-600 text-white";
                } else {
                    detectedType = 'long';
                    document.getElementById('detectedBadge').innerText = "Detected: LONG";
                    document.getElementById('detectedBadge').className = "inline-block mt-1 px-2 py-0.5 rounded text-[10px] font-bold bg-blue-600 text-white";
                }
            }
        });
    }

    async function sendToStudio() {
        if (!selectedFile) return alert("Select a file!");
        const uName = currentUser ? currentUser.email : "Guest";
        const statusText = document.getElementById('text');
        
        statusText.innerText = "Step 1: Connecting...";
        
        try {
            // Get Link
            const response = await fetch('/api/drive/init-upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userName: uName, projectName: "Raw_Footage",
                    fileName: selectedFile.name, fileType: selectedFile.type || 'video/mp4'
                })
            });
            const data = await response.json();
            if (!data.success) throw new Error(data.error);

            // Upload
            statusText.innerText = "Step 2: Sending File...";
            const xhr = new XMLHttpRequest();
            xhr.open("PUT", data.uploadUrl, true);
            
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = ((e.loaded / e.total) * 100).toFixed(0);
                    statusText.innerText = `Uploading: ${percent}%`;
                }
            };

            // üî• IMMORTAL SAVE FUNCTION
            const saveForever = async () => {
                statusText.innerText = "Step 3: Saving...";
                
                const newVideoData = {
                    title: selectedFile.name,
                    link: data.viewLink,
                    fileId: data.fileId,
                    thumb: "https://placehold.co/320x180/1a1a1a/FFFFFF/png?text=VIDEO", 
                    type: detectedType,
                    uploadedBy: uName,
                    uploadDate: new Date().toISOString()
                };

                // 1. MEMORY SAVE (Instant update - User khush)
                rawClips.push(newVideoData);
                localStorage.setItem(CACHE_KEY, JSON.stringify(rawClips)); // Cache Updated
                switchType(detectedType);
                
                // UI Close
                document.getElementById('uploadStep2').classList.add('hidden');
                document.getElementById('uploadStep3').classList.remove('hidden');

                // 2. CLOUD SAVE (Background - Agar fail hua tab bhi memory me rahega)
                try {
                    await window.db.collection('projects').doc(PROJECT_ID).set({
                        footageLib: firebase.firestore.FieldValue.arrayUnion(newVideoData)
                    }, { merge: true });
                    console.log("‚úÖ Cloud Synced");
                } catch (e) {
                    console.error("Cloud Error (But Local Saved):", e);
                    alert("Saved locally! Will sync when internet is better.");
                }
            };

            xhr.onload = () => { if(xhr.status < 400) saveForever(); else statusText.innerText = "Error"; };
            
            xhr.onerror = async () => {
                 // CORS Check
                 try {
                     const check = await fetch('/api/drive/finalize-upload', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ fileId: data.fileId })
                     });
                     const res = await check.json();
                     if(res.success || res.size > 0) saveForever();
                     else throw new Error("Failed");
                 } catch(e) { alert("Upload Failed"); }
            };

            document.getElementById('uploadStep1').classList.add('hidden');
            document.getElementById('uploadStep2').classList.remove('hidden');
            xhr.send(selectedFile);
        } catch (error) { alert(error.message); }
    }

    // ==========================================
    // 4. THE MAGIC PLAYER (Smart Embed)
    // ==========================================
    function openTheater(link, title) {
        const modal = document.getElementById('theaterModal');
        if (!modal) return;
        
        document.getElementById('playerTitle').innerText = title || "Video";
        
        // Convert to Preview Link
        let embedLink = link;
        if (link.includes('drive.google.com')) {
            embedLink = link.replace(/\/view.*/, '/preview');
            embedLink = embedLink.replace(/\/edit.*/, '/preview');
        }

        console.log("‚ñ∂Ô∏è Loading:", embedLink);

        // üî• CREATIVE PART: Iframe with 'sandbox' to prevent Google blocking
        // Hum Google ko bol rahe hain ki ye ek isolated frame hai
        const iframeCode = `
            <iframe 
                src="${embedLink}" 
                class="w-full h-full border-0 rounded-lg bg-black" 
                allow="autoplay"
                sandbox="allow-scripts allow-same-origin allow-presentation">
            </iframe>
        `;

        document.getElementById('playerContainer').innerHTML = iframeCode;
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
    }

    function closeTheater() {
        const modal = document.getElementById('theaterModal');
        modal.classList.add('opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('playerContainer').innerHTML = '';
        }, 300);
    }

    // ==========================================
    // 5. UI HELPERS
    // ==========================================
    function switchType(type) {
        const shortGrid = document.getElementById('gridShorts');
        const longGrid = document.getElementById('gridLongs');
        const btnShorts = document.querySelector("button[onclick*='shorts']");
        const btnLong = document.querySelector("button[onclick*='long']");

        if (type === 'shorts') {
            shortGrid.classList.remove('hidden');
            longGrid.classList.add('hidden');
            if(btnShorts) btnShorts.className = "type-btn active text-white font-bold pb-2 border-b-2 border-orange-500 transition";
            if(btnLong) btnLong.className = "type-btn text-gray-400 hover:text-white font-bold pb-2 transition border-b-2 border-transparent";
        } else {
            longGrid.classList.remove('hidden');
            shortGrid.classList.add('hidden');
            if(btnLong) btnLong.className = "type-btn active text-white font-bold pb-2 border-b-2 border-orange-500 transition";
            if(btnShorts) btnShorts.className = "type-btn text-gray-400 hover:text-white font-bold pb-2 transition border-b-2 border-transparent";
        }
        renderVideos();
    }

    function renderVideos() {
        const gridShorts = document.getElementById('gridShorts');
        const gridLongs = document.getElementById('gridLongs');
        if (!gridShorts || !gridLongs) return;
        
        gridShorts.innerHTML = '';
        gridLongs.innerHTML = '';

        if (rawClips.length === 0) {
            gridLongs.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">No videos yet.</div>';
            return;
        }

        rawClips.forEach((vid, idx) => {
            const div = document.createElement('div');
            const aspectRatio = vid.type === 'shorts' ? 'aspect-[9/16]' : 'aspect-video';
            
            // Clean Thumb
            let displayThumb = vid.thumb;
            if(!displayThumb || displayThumb.startsWith('blob:')) displayThumb = "https://placehold.co/320x180/1a1a1a/FFFFFF/png?text=VIDEO";

            div.className = `group relative bg-[#1a1a1a] rounded-xl overflow-hidden border border-white/10 hover:border-orange-500/50 transition shadow-lg ${aspectRatio}`;
            
            div.innerHTML = `
                <div onclick="openTheater('${vid.link}', '${vid.title}')" class="w-full h-full cursor-pointer relative group">
                    <img src="${displayThumb}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition duration-500">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="w-12 h-12 bg-black/50 backdrop-blur-sm rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transform scale-50 group-hover:scale-100 transition duration-300 border border-white/20">
                            <svg class="w-5 h-5 text-white ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        </div>
                    </div>
                    <div class="absolute top-2 right-2 px-2 py-0.5 bg-black/60 backdrop-blur-md rounded text-[10px] text-white font-bold uppercase border border-white/10">
                        ${vid.type === 'shorts' ? 'SHORT' : 'VIDEO'}
                    </div>
                    <div class="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black via-black/80 to-transparent p-3 pt-6">
                        <h4 class="text-white text-sm font-medium truncate">${vid.title}</h4>
                        <button onclick="event.stopPropagation(); deleteClip(${idx})" class="text-gray-500 hover:text-red-500 text-xs mt-1">Delete</button>
                    </div>
                </div>`;
            
            if (vid.type === 'shorts') gridShorts.appendChild(div);
            else gridLongs.appendChild(div);
        });
    }

    function openUploadModal() {
        document.getElementById('uploadFootageModal').classList.remove('hidden');
        document.getElementById('uploadStep1').classList.remove('hidden');
        document.getElementById('uploadStep2').classList.add('hidden');
        document.getElementById('uploadStep3').classList.add('hidden');
        document.getElementById('filePreview').classList.add('hidden');
    }
    function closeUploadModal() {
        document.getElementById('uploadFootageModal').classList.add('hidden');
        selectedFile = null;
    }
    async function deleteClip(idx) {
        if(!confirm("Delete?")) return;
        rawClips.splice(idx, 1);
        localStorage.setItem(CACHE_KEY, JSON.stringify(rawClips)); // Memory update
        try {
            await window.db.collection('projects').doc(PROJECT_ID).set({ footageLib: rawClips }, {merge: true});
            renderVideos();
        } catch(e) {}
    }
</script>
</body>
</html>