<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raw Footage - Imran Square</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#030303">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" href="/resources/icon-152.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/resources/icon-32.png">
    <link rel="shortcut icon" href="/resources/favicon.ico">

    <!-- Tailwind & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'], 
                        display: ['Playfair Display', 'serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    colors: { brand: { dark: '#030303' } }
                }
            }
        }
    </script>
    <style>
        /* =========================================
           ðŸ”¥ THEME: DARK CINEMATIC (Raw Footage)
           ========================================= */
        :root { --text-primary: #ededed; }

        body { 
            background-color: #030303 !important;
            color: var(--text-primary); 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden; 
            min-height: 100vh;
        }

        /* Background Image with Blur */
        body::before {
            content: "";
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('resources/index bg .jpeg'); 
            background-size: cover; background-position: center; background-repeat: no-repeat;
            filter: blur(5px) brightness(0.6);
            transform: scale(1.05); opacity: 0.5;
            z-index: -50; pointer-events: none;
        }

        /* --- GLASS COMPONENTS --- */
        .glass-header {
            background: rgba(5, 5, 5, 0.85);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* --- SEARCH BAR (Netflix Style Expand) --- */
        .search-box {
            display: flex; align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 999px;
            padding: 6px;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            width: 36px; overflow: hidden; cursor: pointer;
        }
        .search-box.expanded {
            width: 240px;
            background: rgba(0, 0, 0, 0.8);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
        }
        .search-input {
            background: transparent; border: none; outline: none; color: white;
            font-size: 13px; width: 100%; margin-left: 8px; opacity: 0;
            transition: opacity 0.3s ease;
        }
        .search-box.expanded .search-input { opacity: 1; }

        /* --- FILTER PILLS --- */
        .filter-pill {
            padding: 6px 16px; border-radius: 9999px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: #888; font-size: 11px; font-weight: 500; cursor: pointer;
            transition: all 0.3s ease; white-space: nowrap;
        }
        .filter-pill:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.2); }
        .filter-pill.active {
            background: #fff; color: #000;
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
            border-color: #fff; font-weight: 700;
        }

        /* --- STORIES BAR (New) --- */
        .stories-container {
            display: flex; gap: 16px; overflow-x: auto; padding: 10px 4px;
            scrollbar-width: none;
        }
        .stories-container::-webkit-scrollbar { display: none; }

        .story-item {
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            cursor: pointer; position: relative;
        }
        
        .story-ring {
            width: 64px; height: 64px;
            border-radius: 50%; padding: 3px;
            position: relative; transition: transform 0.2s;
        }
        
        /* Neon Rings */
        .ring-admin { background: linear-gradient(45deg, #fff, #aaa); box-shadow: 0 0 15px rgba(255,255,255,0.4); }
        .ring-tips { background: linear-gradient(45deg, #00ff88, #00ccff); box-shadow: 0 0 10px rgba(0, 255, 136, 0.4); }
        .ring-bts { background: linear-gradient(45deg, #ff00cc, #333399); box-shadow: 0 0 10px rgba(255, 0, 204, 0.4); }

        .story-item:hover .story-ring { transform: scale(1.05); }

        .story-avatar {
            width: 100%; height: 100%;
            border-radius: 50%; border: 3px solid #000;
            object-fit: cover; background: #111;
            display: flex; align-items: center; justify-content: center;
        }
        
        .story-add-icon {
            background: #fff; color: #000;
            position: absolute; bottom: 0; right: 0;
            width: 20px; height: 20px; border-radius: 50%;
            border: 2px solid #000;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: bold;
        }

        .story-text { font-size: 10px; color: #ccc; text-align: center; max-width: 70px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- TOGGLE SWITCH (Shorts/Longs) --- */
        .type-switch {
            display: flex; gap: 4px; 
            background: rgba(255,255,255,0.05); padding: 4px; 
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            width: fit-content; margin-bottom: 20px;
        }
        .type-btn {
            font-size: 12px; font-weight: 600; color: #888; cursor: pointer;
            padding: 6px 16px; border-radius: 8px; transition: all 0.3s;
        }
        .type-btn.active { background: #fff; color: #000; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }

        /* --- VIDEO CARDS --- */
        .video-card {
            background: rgba(15, 15, 15, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px; overflow: hidden; position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.8);
        }
        .video-card:hover { 
            transform: translateY(-5px); 
            z-index: 10; 
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,1);
        }
        
        .video-thumbnail {
            width: 100%; height: 100%; object-fit: cover;
            background: #111; 
            transition: transform 0.5s ease;
        }
        .video-card:hover .video-thumbnail { transform: scale(1.05); }
        
        .video-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
            padding: 12px;
        }
        
        /* SHORTS GRID (Vertical 9:16) */
        .grid-shorts {
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px;
        }
        .card-short { aspect-ratio: 9/16; }

        /* LONGS GRID (Horizontal 16:9) */
        .grid-longs {
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 16px;
        }
        .card-long { aspect-ratio: 16/9; }

        /* Responsive Desktop Overrides */
        @media (min-width: 768px) {
            .grid-shorts { grid-template-columns: repeat(4, 1fr); }
            .grid-longs { grid-template-columns: repeat(3, 1fr); }
        }

            /* --- STORY VIEWER MODAL --- */
        #storyViewer { transition: opacity 0.3s ease; }
        .story-content { height: 100%; aspect-ratio: 9/16; max-height: 90vh; background: black; border-radius: 12px; position: relative; }
        .story-progress-bar { position: absolute; top: 10px; left: 10px; right: 10px; height: 2px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden; display: flex; gap: 4px; }
        .progress-segment { height: 100%; flex: 1; background: rgba(255,255,255,0.3); border-radius: 2px; }
        .progress-fill { height: 100%; background: white; width: 0%; }

        /* FAB Upload */
        .fab-upload {
            position: fixed; bottom: 30px; right: 30px;
            width: 56px; height: 56px; border-radius: 50%;
            background: #fff; color: #000; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 30px rgba(255,255,255,0.3); z-index: 50;
            transition: all 0.3s; cursor: pointer; border: 1px solid rgba(255,255,255,0.5);
        }
        .fab-upload:hover { transform: scale(1.1) rotate(90deg); box-shadow: 0 0 50px rgba(255,255,255,0.6); }

       
    
        /* FAB Upload */
        .fab-upload {
            position: fixed; bottom: 30px; right: 30px;
            width: 56px; height: 56px; border-radius: 50%;
            background: #fff; color: #000; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 30px rgba(255,255,255,0.3); z-index: 50;
            transition: all 0.3s; cursor: pointer; border: 1px solid rgba(255,255,255,0.5);
        }
        .fab-upload:hover { transform: scale(1.1) rotate(90deg); box-shadow: 0 0 50px rgba(255,255,255,0.6); }

        /* --- THEATER MODAL (New Glass Style) --- */
        #theaterModal { transition: opacity 0.3s ease; }
        .theater-content {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 100px rgba(0,0,0,0.9);
        }

        /* Helpers */
        .hidden-grid { display: none !important; }
        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        
        /* Edit Mode Styles */
        body.edit-mode .video-card { border: 1px dashed #fff; cursor: move; }
        .delete-btn { display: none; }
        body.edit-mode .delete-btn { display: block; }
    </style>
</head>
<body class="pb-24">

    <!-- 1. HEADER -->
 <header class="h-16 glass-header fixed top-0 w-full z-50 flex items-center justify-between px-4 md:px-6">
    <div class="flex items-center gap-4">
        <a href="#" onclick="goBackToHub()" class="group p-2 rounded-lg hover:bg-white/10 text-gray-400 hover:text-white transition border border-transparent hover:border-white/10">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </a>
        <div>
            <h1 class="text-sm font-bold text-white tracking-wide uppercase font-display" id="rawProjectTitle">Raw Footage</h1>
            <p class="text-[10px] text-gray-500 uppercase tracking-widest">Vault</p>
        </div>
    </div>

        <div class="flex items-center gap-3">
            <div class="search-box" id="searchBox" onclick="expandSearch()">
                <svg class="w-4 h-4 text-white shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="videoSearchInput" class="search-input" placeholder="Search clips...">
            </div>
            
            <button id="editModeToggle" class="p-2 rounded-full hover:bg-white/10 text-gray-400 hover:text-white transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
            </button>
        </div>
    </header>

    <!-- 2. MAIN CONTENT -->
    <div class="pt-24 px-4 md:px-8 max-w-7xl mx-auto">
        
        <!-- Filter Pills -->
        <div class="flex gap-2 overflow-x-auto pb-4 mb-4 no-scrollbar" id="filterContainer">
            <button class="filter-pill active" onclick="filterBy('all', this)">All</button>
            <button class="filter-pill" onclick="filterBy('today', this)">Today</button>
            <button class="filter-pill" onclick="filterBy('week', this)">Last Week</button>
            <button class="filter-pill" onclick="filterBy('month', this)">Last Month</button>
            <button class="filter-pill" onclick="filterBy('bts', this)">BTS</button>
        </div>

        <!-- STORY UPLOAD & VIEWER -->
    <input type="file" id="storyFileInput" class="hidden" accept="image/*,video/*">
    <div id="storyViewer" class="fixed inset-0 bg-black z-[70] hidden flex items-center justify-center">
        <button onclick="closeStory()" class="absolute top-4 right-4 text-white z-50 p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
        <div class="story-content" id="storyContentBox">
            <div class="story-progress-bar" id="storyProgress"></div>
            <img id="storyImage" class="w-full h-full object-cover rounded-xl hidden">
            <video id="storyVideo" class="w-full h-full object-cover rounded-xl hidden" playsinline></video>
            <div class="absolute bottom-0 w-full p-4 bg-gradient-to-t from-black/80 to-transparent">
                <h3 class="text-white font-bold text-sm" id="storyCaption"></h3>
            </div>
            <div class="absolute inset-y-0 left-0 w-1/3 z-10" onclick="prevStorySlide()"></div>
            <div class="absolute inset-y-0 right-0 w-1/3 z-10" onclick="nextStorySlide()"></div>
        </div>
    </div>

        
        <!-- Type Switcher -->
        <div class="type-switch" id="formatToggle">
            <button class="type-btn active" onclick="switchType('shorts', this)">Shorts</button>
            <button class="type-btn" onclick="switchType('longs', this)">Longs</button>
        </div>

        <!-- SHORTS GRID -->
        <div id="gridShorts" class="grid-shorts" id="footageGrid">
            <!-- Items injected by JS -->
        </div>

        <!-- LONGS GRID -->
        <div id="gridLongs" class="grid-longs hidden-grid">
            <!-- Items injected by JS -->
        </div>

    </div>

    <!-- Upload Button -->
    <button class="fab-upload" onclick="openUploadModal()">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
    </button>

    <!-- THEATER MODAL (Updated) -->
    <div id="theaterModal" class="fixed inset-0 bg-black/90 z-[60] hidden items-center justify-center p-4 backdrop-blur-md opacity-0">
        <div class="theater-content relative w-full max-w-5xl rounded-xl overflow-hidden">
            
            <!-- CLOSE -->
            <button onclick="closeTheater()" class="absolute top-4 right-4 z-20 text-white/70 hover:text-white bg-black/50 p-2 rounded-full hover:bg-white/10 transition border border-white/10">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <!-- PLAYER -->
            <div class="aspect-video bg-black flex items-center justify-center" id="playerContainer"></div>

            <!-- METADATA STRIP -->
            <div class="p-5 border-t border-white/10 flex justify-between items-center bg-[#050505]">
                <div>
                    <h3 class="text-lg font-display font-bold text-white" id="playerTitle">Video Title</h3>
                    <p id="playerMeta" class="text-[11px] text-gray-400 mt-1 font-mono">Meta info</p>
                </div>
                <div class="flex items-center gap-3">
                    <span id="playerFormatBadge" class="px-2 py-1 rounded text-[10px] font-bold border border-white/20 text-gray-300">LONG</span>
                    <select id="playbackSpeed" class="bg-white/10 border border-white/10 text-white text-xs rounded px-2 py-1 outline-none hover:bg-white/20 transition">
                        <option value="0.5">0.5x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- UPLOAD MODAL (Updated) -->
    <div id="uploadFootageModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-50 flex items-center justify-center p-4">
        <div class="bg-[#0a0a0a] border border-white/10 rounded-2xl max-w-lg w-full p-6 relative shadow-2xl">
            <button onclick="closeUploadModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <!-- Step 1 -->
            <div id="uploadStep1">
                <h2 class="text-xl font-display font-bold text-white mb-2">Upload Raw Footage</h2>
                <p class="text-sm text-gray-400 mb-6">Select a video file to add to the vault.</p>

                <input type="file" id="footageFileInput" accept="video/*" class="hidden">
                <div onclick="document.getElementById('footageFileInput').click()" class="border-2 border-dashed border-white/10 rounded-xl p-8 text-center cursor-pointer hover:border-white/30 hover:bg-white/5 transition group">
                    <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-white/5 flex items-center justify-center group-hover:scale-110 transition">
                        <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    </div>
                    <p class="text-gray-300 font-medium text-sm">Click to choose video</p>
                </div>

                <div id="filePreview" class="hidden mt-4 p-3 bg-white/5 rounded-lg border border-white/10">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-16 h-16 bg-black rounded overflow-hidden flex-shrink-0 border border-white/10">
                            <img id="previewThumbnail" class="w-full h-full object-cover" />
                        </div>
                        <div class="flex-1 min-w-0">
                            <p id="previewFileName" class="text-white text-sm font-medium truncate"></p>
                            <p id="previewFileSize" class="text-xs text-gray-500 mt-0.5 font-mono"></p>
                        </div>
                    </div>
                    <input type="text" id="previewTitleInput" class="w-full bg-black border border-white/10 rounded px-3 py-2 text-xs text-white focus:border-white/30 outline-none transition" placeholder="Enter clip title...">
                    <button onclick="sendToStudio()" class="w-full mt-3 bg-white text-black font-bold py-2 rounded text-xs hover:bg-gray-200 transition">Upload Now</button>
                </div>
            </div>

            <!-- Step 2 -->
            <div id="uploadStep2" class="hidden text-center py-8">
                <div class="w-16 h-16 mx-auto mb-4 relative">
                    <svg class="animate-spin text-white" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-white mb-1">Processing...</h3>
                <p id="uploadProgressText" class="text-xs text-gray-500 font-mono">Encrypting...</p>
                <div class="w-full bg-white/10 rounded-full h-1 mt-4 overflow-hidden">
                    <div id="uploadProgressBar" class="bg-white h-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Step 3 -->
            <div id="uploadStep3" class="hidden text-center py-8">
                <div class="w-16 h-16 mx-auto mb-4 bg-white text-black rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(255,255,255,0.3)]">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <h3 class="text-lg font-bold text-white mb-2">Upload Complete!</h3>
                <button onclick="closeUploadModal()" class="bg-white/10 hover:bg-white/20 text-white py-2 px-6 rounded text-xs transition border border-white/10">Close</button>
            </div>
        </div>
    </div>



<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA_D3AuwSzHKgs5svcwRoP0St2Nc-delF8",
            authDomain: "iimransquare.firebaseapp.com",
            projectId: "iimransquare",
            storageBucket: "iimransquare.firebasestorage.app",
            messagingSenderId: "431645042472",
            appId: "1:431645042472:web:87e7cea4659d6a0564121d",
            measurementId: "G-Z0EN14J4XM"
        };

        // Firebase start karo
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // 'db' aur 'auth' ko global banao taaki baaki files use kar sakein
        const db = firebase.firestore();
        const auth = firebase.auth();
        window.db = db;     // Make sure it's global
        window.auth = auth; // Make sure it's global
    </script>

    <script src="main.js"></script>

 <script>
    // ========================================
    // ðŸ”¥ CONFIGURATION
    // ========================================
    let currentProjectID = new URLSearchParams(window.location.search).get('id') || 'demo-project';
    let rawClips = [];
    let selectedFile = null;
    let currentUser = null;
    let isAuthReady = false;

    // ========================================
    // ðŸ”¥ AUTH CHECK (No Auto-Redirect)
    // ========================================
    document.addEventListener('DOMContentLoaded', async () => {
        console.log("ðŸš€ Page Loaded");

        // Method 1: Check localStorage first (Instant)
        const storedUser = localStorage.getItem('user');
        if (storedUser) {
            try {
                currentUser = JSON.parse(storedUser);
                isAuthReady = true;
                console.log("âœ… User from LocalStorage:", currentUser.email);
                await loadProjectData();
            } catch (e) {
                console.error("âŒ LocalStorage parse error");
            }
        }

        // Method 2: Firebase Auth (Async backup)
        if (typeof firebase !== 'undefined' && firebase.auth) {
            firebase.auth().onAuthStateChanged(async (user) => {
                if (user) {
                    console.log("âœ… Firebase Auth Active:", user.email);
                    
                    currentUser = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || user.email.split('@')[0],
                        photoURL: user.photoURL
                    };
                    
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    isAuthReady = true;
                    
                    if (!storedUser) {
                        await loadProjectData();
                    }
                } else {
                    console.warn("âš ï¸ No Firebase session");
                    
                    // âœ… FIXED: Only redirect if localStorage also empty
                    if (!storedUser) {
                        console.error("âŒ No stored user found");
                        setTimeout(() => {
                            if (confirm("Session expired. Redirect to login?")) {
                                window.location.href = 'login.html';
                            }
                        }, 1000);
                    }
                }
            });
        }
    });

    // ========================================
    // ðŸ”¥ LOAD PROJECT
    // ========================================
    async function loadProjectData() {
        if (!currentProjectID) return;

        try {
            const doc = await db.collection('projects').doc(currentProjectID).get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('rawProjectTitle').textContent = (data.title || 'Untitled').toUpperCase();
                rawClips = data.footageLib || [];
                renderVideos();
                console.log("âœ… Project Loaded");
            }
        } catch (e) {
            console.error("âŒ Load Error:", e);
        }
    }

    // ========================================
    // ðŸ”¥ FILE PREVIEW
    // ========================================
    const fileInput = document.getElementById('footageFileInput');
    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            selectedFile = file;
            document.getElementById('filePreview').classList.remove('hidden');
            document.getElementById('previewFileName').textContent = file.name;
            document.getElementById('previewFileSize').textContent = (file.size / (1024 * 1024)).toFixed(2) + ' MB';

            // Thumbnail
            const video = document.createElement('video');
            video.preload = 'metadata';
            video.src = URL.createObjectURL(file);
            video.onloadeddata = () => video.currentTime = 1;
            video.onseeked = () => {
                const canvas = document.createElement('canvas');
                canvas.width = 320;
                canvas.height = 180;
                canvas.getContext('2d').drawImage(video, 0, 0, 320, 180);
                document.getElementById('previewThumbnail').src = canvas.toDataURL();
                URL.revokeObjectURL(video.src);
            };
        });
    }

    // ========================================
    // ðŸ”¥ DIRECT-TO-DRIVE UPLOAD (Free Tier)
    // ========================================
    async function sendToStudio() {
        console.log("ðŸŽ¬ Upload Started");

        if (!isAuthReady || !currentUser) {
            alert("â³ Authentication in progress. Please wait and try again.");
            return;
        }

        const file = selectedFile || document.getElementById('footageFileInput').files[0];
        if (!file) {
            alert("No file selected!");
            return;
        }

        // UI: Show progress
        document.getElementById('uploadStep1').classList.add('hidden');
        document.getElementById('uploadStep2').classList.remove('hidden');

        const bar = document.getElementById('uploadProgressBar');
        const text = document.getElementById('uploadProgressText');

        try {
            // ============================================
            // STEP 1: Get Resumable Upload URL from Server
            // ============================================
            text.innerText = "Initializing...";
            bar.style.width = '5%';
            
            const initResponse = await fetch('/api/drive/init-upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userName: currentUser.displayName,
                    projectName: document.getElementById('rawProjectTitle')?.innerText || "Project",
                    fileName: file.name,
                    fileType: file.type
                })
            });

            if (!initResponse.ok) {
                throw new Error(`Server error: ${initResponse.status}`);
            }

            const initData = await initResponse.json();
            
            if (!initData.success) {
                throw new Error(initData.error || "Init failed");
            }

            console.log("âœ… Got resumable URI");
            bar.style.width = '10%';

            // ============================================
            // STEP 2: Direct Upload to Google Drive
            // (Bypasses server to avoid Render timeout)
            // ============================================
            text.innerText = "Uploading to Drive...";

            await new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                
                // ðŸ”¥ CRITICAL: PUT request to Google's resumable URI
                xhr.open("PUT", initData.uploadUrl, true);
                xhr.setRequestHeader("Content-Type", file.type);

                // Progress tracking
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.floor((e.loaded / e.total) * 100);
                        bar.style.width = (10 + percent * 0.85) + '%';
                        text.innerText = `Uploading... ${percent}%`;
                    }
                };

                xhr.onload = () => {
                    if (xhr.status === 200 || xhr.status === 201) {
                        console.log("âœ… Upload complete!");
                        resolve();
                    } else {
                        reject(new Error(`Drive error: ${xhr.status}`));
                    }
                };

                xhr.onerror = () => reject(new Error("Network error"));

                xhr.send(file);
            });

            bar.style.width = '95%';

            // ============================================
            // STEP 3: Save Metadata to Firestore
            // ============================================
            text.innerText = "Saving metadata...";
            
            const newClip = {
                id: initData.fileId,
                title: file.name,
                link: initData.viewLink,
                thumb: document.getElementById('previewThumbnail').src,
                date: new Date().toLocaleDateString(),
                type: 'raw'
            };
            
            rawClips.push(newClip);
            
            await db.collection('projects').doc(currentProjectID).update({
                footageLib: rawClips
            });

            bar.style.width = '100%';
            console.log("âœ… Complete!");
            
            renderVideos();

            // Show success screen
            document.getElementById('uploadStep2').classList.add('hidden');
            document.getElementById('uploadStep3').classList.remove('hidden');

            setTimeout(() => {
                closeUploadModal();
                selectedFile = null;
            }, 2000);

        } catch (error) {
            console.error("âŒ Upload failed:", error);
            alert("Upload failed: " + error.message);
            
            document.getElementById('uploadStep2').classList.add('hidden');
            document.getElementById('uploadStep1').classList.remove('hidden');
        }
    }

    // ========================================
    // ðŸ”¥ UI HELPERS
    // ========================================
    function openUploadModal() {
        if (!isAuthReady) {
            alert("Please wait for authentication...");
            return;
        }
        document.getElementById('uploadFootageModal').classList.remove('hidden');
        document.getElementById('uploadStep1').classList.remove('hidden');
        document.getElementById('uploadStep2').classList.add('hidden');
        document.getElementById('uploadStep3').classList.add('hidden');
        document.getElementById('filePreview').classList.add('hidden');
    }

    function closeUploadModal() {
        document.getElementById('uploadFootageModal').classList.add('hidden');
        selectedFile = null;
    }

    function switchType(type, btn) {
        currentType = type;
        document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const shortGrid = document.getElementById('gridShorts');
        const longGrid = document.getElementById('gridLongs');
        
        if (type === 'shorts') {
            shortGrid.classList.remove('hidden-grid', 'hidden');
            longGrid.classList.add('hidden-grid', 'hidden');
        } else {
            longGrid.classList.remove('hidden-grid', 'hidden');
            shortGrid.classList.add('hidden-grid', 'hidden');
        }
        renderVideos();
    }

    function renderVideos() {
        const gridShorts = document.getElementById('gridShorts');
        const gridLongs = document.getElementById('gridLongs');
        if (!gridShorts || !gridLongs) return;
        
        gridShorts.innerHTML = '';
        gridLongs.innerHTML = '';

        if (rawClips.length === 0) {
            gridShorts.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">No videos yet</div>';
            return;
        }

        rawClips.forEach((vid, idx) => {
            const div = document.createElement('div');
            div.className = `group relative bg-gray-900 rounded-lg overflow-hidden border border-white/10 hover:border-orange-500/50 transition ${vid.type === 'shorts' ? 'aspect-[9/16]' : 'aspect-video'}`;
            div.innerHTML = `
                <div onclick="openTheater('${vid.link}', '${vid.title}')" class="w-full h-full cursor-pointer relative" style="background-image: url('${vid.thumb}'); background-size: cover;">
                    <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                        <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.333-5.89a1.5 1.5 0 000-2.538L6.3 2.841z"/></svg>
                    </div>
                    <div class="absolute bottom-0 p-2 w-full bg-black/60">
                        <h4 class="text-white text-[10px] truncate">${vid.title}</h4>
                        <button onclick="event.stopPropagation(); deleteClip(${idx})" class="text-red-500 text-[10px] mt-1">Delete</button>
                    </div>
                </div>`;
            
            if (vid.type === 'shorts') gridShorts.appendChild(div);
            else gridLongs.appendChild(div);
        });
    }

    function openTheater(link, title) {
        const modal = document.getElementById('theaterModal');
        if (!modal) return;
        document.getElementById('playerTitle').innerText = title;
        let embedLink = link.includes('/view') ? link.replace(/\/view.*/, '/preview') : link;
        document.getElementById('playerContainer').innerHTML = `<iframe src="${embedLink}" class="w-full h-full border-0" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
        modal.classList.remove('hidden');
        setTimeout(() => modal.style.opacity = '1', 10);
    }

    function closeTheater() {
        const modal = document.getElementById('theaterModal');
        if (!modal) return;
        modal.style.opacity = '0';
        setTimeout(() => {
            modal.classList.add('hidden');
            document.getElementById('playerContainer').innerHTML = '';
        }, 300);
    }

    async function deleteClip(idx) {
        if (!confirm("Delete?")) return;
        rawClips.splice(idx, 1);
        await db.collection('projects').doc(currentProjectID).update({ footageLib: rawClips });
        renderVideos();
    }

    function goBackToHub() {
        window.location.href = currentProjectID ? `project-hub.html?id=${currentProjectID}` : 'index.html';
    }
</script>
