<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raw Footage - Imran Square</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#030303">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" href="/resources/icon-152.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/resources/icon-32.png">
    <link rel="shortcut icon" href="/resources/favicon.ico">

    <!-- Tailwind & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'], 
                        display: ['Playfair Display', 'serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    colors: { brand: { dark: '#030303' } }
                }
            }
        }
    </script>
    <style>
        /* =========================================
           ðŸ”¥ THEME: DARK CINEMATIC (Raw Footage)
           ========================================= */
        :root { --text-primary: #ededed; }

        body { 
            background-color: #030303 !important;
            color: var(--text-primary); 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden; 
            min-height: 100vh;
        }

        /* Background Image with Blur */
        body::before {
            content: "";
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('resources/index bg .jpeg'); 
            background-size: cover; background-position: center; background-repeat: no-repeat;
            filter: blur(5px) brightness(0.6);
            transform: scale(1.05); opacity: 0.5;
            z-index: -50; pointer-events: none;
        }

        /* --- GLASS COMPONENTS --- */
        .glass-header {
            background: rgba(5, 5, 5, 0.85);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* --- SEARCH BAR (Netflix Style Expand) --- */
        .search-box {
            display: flex; align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 999px;
            padding: 6px;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            width: 36px; overflow: hidden; cursor: pointer;
        }
        .search-box.expanded {
            width: 240px;
            background: rgba(0, 0, 0, 0.8);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
        }
        .search-input {
            background: transparent; border: none; outline: none; color: white;
            font-size: 13px; width: 100%; margin-left: 8px; opacity: 0;
            transition: opacity 0.3s ease;
        }
        .search-box.expanded .search-input { opacity: 1; }

        /* --- FILTER PILLS --- */
        .filter-pill {
            padding: 6px 16px; border-radius: 9999px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: #888; font-size: 11px; font-weight: 500; cursor: pointer;
            transition: all 0.3s ease; white-space: nowrap;
        }
        .filter-pill:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.2); }
        .filter-pill.active {
            background: #fff; color: #000;
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
            border-color: #fff; font-weight: 700;
        }

        /* --- STORIES BAR (New) --- */
        .stories-container {
            display: flex; gap: 16px; overflow-x: auto; padding: 10px 4px;
            scrollbar-width: none;
        }
        .stories-container::-webkit-scrollbar { display: none; }

        .story-item {
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            cursor: pointer; position: relative;
        }
        
        .story-ring {
            width: 64px; height: 64px;
            border-radius: 50%; padding: 3px;
            position: relative; transition: transform 0.2s;
        }
        
        /* Neon Rings */
        .ring-admin { background: linear-gradient(45deg, #fff, #aaa); box-shadow: 0 0 15px rgba(255,255,255,0.4); }
        .ring-tips { background: linear-gradient(45deg, #00ff88, #00ccff); box-shadow: 0 0 10px rgba(0, 255, 136, 0.4); }
        .ring-bts { background: linear-gradient(45deg, #ff00cc, #333399); box-shadow: 0 0 10px rgba(255, 0, 204, 0.4); }

        .story-item:hover .story-ring { transform: scale(1.05); }

        .story-avatar {
            width: 100%; height: 100%;
            border-radius: 50%; border: 3px solid #000;
            object-fit: cover; background: #111;
            display: flex; align-items: center; justify-content: center;
        }
        
        .story-add-icon {
            background: #fff; color: #000;
            position: absolute; bottom: 0; right: 0;
            width: 20px; height: 20px; border-radius: 50%;
            border: 2px solid #000;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: bold;
        }

        .story-text { font-size: 10px; color: #ccc; text-align: center; max-width: 70px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- TOGGLE SWITCH (Shorts/Longs) --- */
        .type-switch {
            display: flex; gap: 4px; 
            background: rgba(255,255,255,0.05); padding: 4px; 
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            width: fit-content; margin-bottom: 20px;
        }
        .type-btn {
            font-size: 12px; font-weight: 600; color: #888; cursor: pointer;
            padding: 6px 16px; border-radius: 8px; transition: all 0.3s;
        }
        .type-btn.active { background: #fff; color: #000; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }

        /* --- VIDEO CARDS --- */
        .video-card {
            background: rgba(15, 15, 15, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px; overflow: hidden; position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.8);
        }
        .video-card:hover { 
            transform: translateY(-5px); 
            z-index: 10; 
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,1);
        }
        
        .video-thumbnail {
            width: 100%; height: 100%; object-fit: cover;
            background: #111; 
            transition: transform 0.5s ease;
        }
        .video-card:hover .video-thumbnail { transform: scale(1.05); }
        
        .video-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
            padding: 12px;
        }
        
        /* SHORTS GRID (Vertical 9:16) */
        .grid-shorts {
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px;
        }
        .card-short { aspect-ratio: 9/16; }

        /* LONGS GRID (Horizontal 16:9) */
        .grid-longs {
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 16px;
        }
        .card-long { aspect-ratio: 16/9; }

        /* Responsive Desktop Overrides */
        @media (min-width: 768px) {
            .grid-shorts { grid-template-columns: repeat(4, 1fr); }
            .grid-longs { grid-template-columns: repeat(3, 1fr); }
        }

            /* --- STORY VIEWER MODAL --- */
        #storyViewer { transition: opacity 0.3s ease; }
        .story-content { height: 100%; aspect-ratio: 9/16; max-height: 90vh; background: black; border-radius: 12px; position: relative; }
        .story-progress-bar { position: absolute; top: 10px; left: 10px; right: 10px; height: 2px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden; display: flex; gap: 4px; }
        .progress-segment { height: 100%; flex: 1; background: rgba(255,255,255,0.3); border-radius: 2px; }
        .progress-fill { height: 100%; background: white; width: 0%; }

      /* âœ¨ NEON GLASS FAB */
.fab-upload {
    position: fixed; bottom: 30px; right: 30px;
    width: 60px; height: 60px; border-radius: 50%;
    /* Glass Effect */
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    display: flex; align-items: center; justify-content: center;
    /* Neon Glow */
    box-shadow: 0 0 20px rgba(255, 100, 0, 0.4), inset 0 0 10px rgba(255, 255, 255, 0.1);
    z-index: 50; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.fab-upload:hover { 
    transform: scale(1.1) rotate(90deg); 
    background: linear-gradient(135deg, #ff6b00, #ff2200); /* Orange to Red */
    box-shadow: 0 0 40px rgba(255, 80, 0, 0.8);
    border-color: transparent;
}

        /* --- THEATER MODAL (New Glass Style) --- */
        #theaterModal { transition: opacity 0.3s ease; }
        .theater-content {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 100px rgba(0,0,0,0.9);
        }

        /* Helpers */
        .hidden-grid { display: none !important; }
        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        
        /* Edit Mode Styles */
        body.edit-mode .video-card { border: 1px dashed #fff; cursor: move; }
        .delete-btn { display: none; }
        body.edit-mode .delete-btn { display: block; }
    </style>
</head>
<body class="pb-24">

    <!-- 1. HEADER -->
<header class="h-16 glass-header fixed top-0 w-full z-50 flex items-center justify-between px-4 md:px-6">
        
        <div class="flex items-center gap-4 flex-shrink-0">
            <button onclick="goBackToHub()" class="group p-2 rounded-lg hover:bg-white/10 text-gray-400 hover:text-white transition border border-transparent hover:border-white/10">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <div class="flex flex-col justify-center">
                <h1 class="text-sm font-bold text-white tracking-wide uppercase font-display whitespace-nowrap" id="rawProjectTitle">Raw Footage</h1>
                <p class="text-[10px] text-gray-500 uppercase tracking-widest whitespace-nowrap">Vault</p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <div class="search-box" id="searchBox" onclick="expandSearch()">
                <svg class="w-4 h-4 text-white shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="videoSearchInput" class="search-input" placeholder="Search clips...">
            </div>
            
            <div class="flex items-center gap-2">
                <div id="editControlsContainer">
                    <button onclick="toggleEditMode()" class="p-2 rounded-full hover:bg-white/10 text-gray-400 hover:text-white transition" title="Edit Videos">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 2. MAIN CONTENT -->
    <div class="pt-24 px-4 md:px-8 max-w-7xl mx-auto">
        
        <!-- Filter Pills -->
        <div class="flex gap-2 overflow-x-auto pb-4 mb-4 no-scrollbar" id="filterContainer">
            <button class="filter-pill active" onclick="filterBy('all', this)">All</button>
            <button class="filter-pill" onclick="filterBy('today', this)">Today</button>
            <button class="filter-pill" onclick="filterBy('week', this)">Last Week</button>
            <button class="filter-pill" onclick="filterBy('month', this)">Last Month</button>
            <button class="filter-pill" onclick="filterBy('bts', this)">BTS</button>
        </div>

        <!-- STORY UPLOAD & VIEWER -->
    <input type="file" id="storyFileInput" class="hidden" accept="image/*,video/*">
    <div id="storyViewer" class="fixed inset-0 bg-black z-[70] hidden flex items-center justify-center">
        <button onclick="closeStory()" class="absolute top-4 right-4 text-white z-50 p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
        <div class="story-content" id="storyContentBox">
            <div class="story-progress-bar" id="storyProgress"></div>
            <img id="storyImage" class="w-full h-full object-cover rounded-xl hidden">
            <video id="storyVideo" class="w-full h-full object-cover rounded-xl hidden" playsinline></video>
            <div class="absolute bottom-0 w-full p-4 bg-gradient-to-t from-black/80 to-transparent">
                <h3 class="text-white font-bold text-sm" id="storyCaption"></h3>
            </div>
            <div class="absolute inset-y-0 left-0 w-1/3 z-10" onclick="prevStorySlide()"></div>
            <div class="absolute inset-y-0 right-0 w-1/3 z-10" onclick="nextStorySlide()"></div>
        </div>
    </div>

        
<div class="flex justify-center mb-8">
        <div class="bg-[#111] p-1.5 rounded-full border border-white/10 flex items-center shadow-inner relative">
            
            <button id="tab-shorts" onclick="switchType('shorts')" class="relative z-10 px-6 py-2 rounded-full text-xs font-bold uppercase tracking-wider transition-all duration-300 bg-white text-black shadow-lg transform scale-105">
                Shorts / Reels
            </button>
            
            <button id="tab-long" onclick="switchType('long')" class="relative z-10 px-6 py-2 rounded-full text-xs font-bold uppercase tracking-wider transition-all duration-300 text-gray-500 hover:text-white">
                Long Videos
            </button>

        </div>
    </div>
    
    <div id="gridShorts" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
    <div id="gridLongs" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

    <!-- Upload Button -->
    <button class="fab-upload" onclick="openUploadModal()">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
    </button>

<div id="theaterModal" class="fixed inset-0 bg-black/95 z-[999] hidden items-center justify-center backdrop-blur-md opacity-0 transition-opacity duration-300">
    
    <button onclick="closeTheater()" class="absolute top-6 right-6 z-[1000] text-white/70 hover:text-white bg-black/50 hover:bg-red-600 p-3 rounded-full transition border border-white/10 shadow-lg group">
        <svg class="w-6 h-6 group-hover:rotate-90 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
    </button>

    <div id="playerContainer" class="w-full h-full flex items-center justify-center relative p-4">
        </div>

</div>

    <!-- UPLOAD MODAL (Updated) -->
<div id="uploadFootageModal" class="hidden fixed inset-0 bg-black/95 backdrop-blur-md z-50 flex items-center justify-center p-4">
    <div class="bg-[#0a0a0a] border border-white/10 rounded-2xl max-w-2xl w-full p-6 relative shadow-2xl flex flex-col max-h-[90vh]">
        
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="text-xl font-display font-bold text-white">Upload to Vault</h2>
                <p class="text-xs text-gray-400">Select multiple clips, rename them, and upload.</p>
            </div>
            <button onclick="closeUploadModal()" class="text-gray-400 hover:text-white transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div id="uploadStep1" class="flex-1 overflow-y-auto pr-2 custom-scrollbar">
            
            <input type="file" id="fileInput" accept="video/*" multiple class="hidden">
            
            <div onclick="document.getElementById('fileInput').click()" class="border-2 border-dashed border-white/10 rounded-xl p-6 text-center cursor-pointer hover:border-orange-500/50 hover:bg-white/5 transition group mb-6">
                <div class="w-10 h-10 mx-auto mb-2 rounded-full bg-white/5 flex items-center justify-center group-hover:scale-110 transition">
                    <svg class="w-5 h-5 text-gray-300 group-hover:text-orange-500 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                </div>
                <p class="text-gray-300 font-medium text-sm">Click to select videos</p>
            </div>

            <div id="uploadList" class="flex flex-col gap-3">
                </div>

        </div>

        <div class="mt-4 pt-4 border-t border-white/10 flex justify-end gap-3">
            <button onclick="closeUploadModal()" class="px-4 py-2 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-white/5 transition">Cancel</button>
            <button onclick="startBatchUpload()" id="btnStartUpload" class="hidden px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-lg text-sm transition flex items-center gap-2">
                <span>Start Upload</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
            </button>
        </div>

    </div>
</div>
    
    <p id="text" class="mt-3 text-center text-gray-500 text-xs font-mono h-4"></p>
</div>

        <div id="uploadStep2" class="hidden text-center py-8">
            <div class="w-16 h-16 mx-auto mb-4 relative">
                <svg class="animate-spin text-orange-500" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-bold text-white mb-1">Uploading to Vault...</h3>
            <p class="text-xs text-gray-500 font-mono">Do not close this window</p>
        </div>

        <div id="uploadStep3" class="hidden text-center py-8">
            <div class="w-16 h-16 mx-auto mb-4 bg-green-500/20 text-green-400 rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(74,222,128,0.2)]">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h3 class="text-lg font-bold text-white mb-2">Upload Complete!</h3>
            <p class="text-sm text-gray-400 mb-6">Your footage has been securely stored.</p>
            <button onclick="closeUploadModal()" class="bg-white/10 hover:bg-white/20 text-white py-2 px-8 rounded-lg text-sm transition border border-white/10">Close</button>
        </div>

    </div>
</div>

<div id="editControlModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
    <div class="bg-[#1a1a1a] border border-gray-800 rounded-xl w-full max-w-md p-6 relative shadow-2xl">
        
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <svg class="w-5 h-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                Edit Video
            </h3>
            <button onclick="closeEditModal()" class="text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="mb-6">
            <label class="text-xs text-gray-500 uppercase tracking-widest font-bold mb-2 block">Video Title</label>
            <input type="text" id="editVideoTitle" class="w-full bg-black border border-gray-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none transition-all" placeholder="Enter video title...">
        </div>

        <div class="flex gap-3">
            <button id="btnSaveRename" onclick="saveVideoRename()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all flex justify-center items-center gap-2">
                <span>Save Changes</span>
            </button>
            <button onclick="deleteVideoPermanently()" class="flex-1 bg-red-600/10 hover:bg-red-600 border border-red-600/50 text-red-500 hover:text-white font-bold py-3 rounded-lg transition-all flex justify-center items-center gap-2 group">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                <span>Delete</span>
            </button>
        </div>

        <input type="hidden" id="editVideoId">
    </div>
</div>


<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA_D3AuwSzHKgs5svcwRoP0St2Nc-delF8",
            authDomain: "iimransquare.firebaseapp.com",
            projectId: "iimransquare",
            storageBucket: "iimransquare.firebasestorage.app",
            messagingSenderId: "431645042472",
            appId: "1:431645042472:web:87e7cea4659d6a0564121d",
            measurementId: "G-Z0EN14J4XM"
        };

        // Firebase start karo
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // 'db' aur 'auth' ko global banao taaki baaki files use kar sakein
        const db = firebase.firestore();
        const auth = firebase.auth();
        window.db = db;     // Make sure it's global
        window.auth = auth; // Make sure it's global
    </script>

   
<script>

// ðŸ“¸ THUMBNAIL GENERATOR (Fixed for Small/Short Videos)
    function generateVideoThumbnail(file) {
        return new Promise((resolve) => {
            const video = document.createElement('video');
            video.src = URL.createObjectURL(file);
            video.muted = true;
            video.playsInline = true;
            video.preload = 'auto'; // Force load data
            
            // Timeout: 3 sec mein na bane to null
            const timeout = setTimeout(() => resolve(null), 3000);

            // 1. Jab Video Data Load ho jaye (Metadata nahi, asli Data)
            video.onloadeddata = () => {
                // Logic: Agar video 2 second se chhoti hai, to shuru ka frame lo
                // Agar badi hai, to 1 second aage ka frame lo
                const seekTime = video.duration < 2 ? 0.0 : 1.0;
                video.currentTime = seekTime;
            };

            // 2. Seek hone ke baad (Frame Ready)
            video.onseeked = () => {
                // ðŸ›‘ Thoda sa wait karo taaki frame paint ho jaye (Crucial for small files)
                setTimeout(() => {
                    clearTimeout(timeout);
                    try {
                        const valWidth = video.videoWidth;
                        const valHeight = video.videoHeight;
                        
                        // Agar dimensions 0 hain (Corrupt file), to fail karo
                        if(valWidth === 0 || valHeight === 0) {
                            resolve(null);
                            return;
                        }

                        // Smart Scaling (Vertical/Horizontal)
                        const maxDimension = 320;
                        let newWidth, newHeight;

                        if (valWidth > valHeight) {
                            // Horizontal
                            newWidth = maxDimension;
                            newHeight = (valHeight / valWidth) * maxDimension;
                        } else {
                            // Vertical
                            newHeight = maxDimension;
                            newWidth = (valWidth / valHeight) * maxDimension;
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = newWidth;
                        canvas.height = newHeight;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0, newWidth, newHeight);
                        
                        // High Quality JPEG
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(dataUrl);

                    } catch (e) {
                        console.error("Thumbnail Error:", e);
                        resolve(null);
                    }
                }, 200); // 200ms delay for small files to render
            };

            video.onerror = () => {
                clearTimeout(timeout);
                resolve(null);
            };
        });
    }

       // ==========================================
    // ðŸŽ¨ TITAN UI ENGINE (v15.0 - Final Fix)
    // ==========================================
    const PROJECT_ID = new URLSearchParams(window.location.search).get('id');
    let currentUser = null;
    let selectedFile = null;
    let currentRawClips = [];
    let renderedClips = [];   // DISPLAY DATA (Filtered copy)
    
    // Filter & Search State
    let activeCategory = 'all';
    let searchQuery = '';
    let isEditMode = false;



    if (!PROJECT_ID) {
        alert("âš ï¸ No Project ID.");
        window.location.href = 'index.html';
    }

    // 1. STARTUP
    document.addEventListener('DOMContentLoaded', () => {
        console.log("ðŸ”µ UI Engine Starting...");
        if (typeof firebase !== 'undefined' && firebase.auth) {
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    currentUser = { uid: user.uid, email: user.email };
                    initLiveSync();
                }
            });
        }
    });

    // 2. LIVE SYNC (Database to UI)
    function initLiveSync() {
        if (!window.db) return;
        window.db.collection('projects').doc(PROJECT_ID)
            .onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('rawProjectTitle').innerText = (data.title || 'Untitled').toUpperCase();
                    
                    // Data Cleaning
                    let clips = data.footageLib || [];
                    currentRawClips = clips.map(clip => {
                        if(clip.thumb && clip.thumb.startsWith('blob:')) 
                            clip.thumb = "https://placehold.co/320x180/1a1a1a/FFFFFF/png?text=VIDEO";
                        return clip;
                    });

                    console.log(`âœ… Loaded ${currentRawClips.length} videos`);
                    // Force Render current tab
                    switchType(currentTab); 
                }
            });
    }

  
   // 3. TAB SWITCHER (Professional Style)
    function switchType(type) {
        currentTab = type;
        
        const btnShorts = document.getElementById('tab-shorts');
        const btnLong = document.getElementById('tab-long');
        const gridShorts = document.getElementById('gridShorts');
        const gridLongs = document.getElementById('gridLongs');

        if (!btnShorts || !btnLong) return;

        // Common Active/Inactive Classes
        const activeClass = "bg-white text-black shadow-lg transform scale-105";
        const inactiveClass = "text-gray-500 hover:text-white bg-transparent shadow-none transform scale-100";

        if (type === 'shorts') {
            // UI
            gridShorts.classList.remove('hidden');
            gridLongs.classList.add('hidden');
            
            // Buttons Styling
            btnShorts.className = `relative z-10 px-6 py-2 rounded-full text-xs font-bold uppercase tracking-wider transition-all duration-300 ${activeClass}`;
            btnLong.className = `relative z-10 px-6 py-2 rounded-full text-xs font-bold uppercase tracking-wider transition-all duration-300 ${inactiveClass}`;
        } else {
            // UI
            gridLongs.classList.remove('hidden');
            gridShorts.classList.add('hidden');
            
            // Buttons Styling
            btnLong.className = `relative z-10 px-6 py-2 rounded-full text-xs font-bold uppercase tracking-wider transition-all duration-300 ${activeClass}`;
            btnShorts.className = `relative z-10 px-6 py-2 rounded-full text-xs font-bold uppercase tracking-wider transition-all duration-300 ${inactiveClass}`;
        }

        // Render Data (Important for filters)
        renderVideos();
    }

// 4. RENDERER (Updated for Search & Filters)
    function renderVideos() {
        const gridShorts = document.getElementById('gridShorts');
        const gridLongs = document.getElementById('gridLongs');
        
        gridShorts.innerHTML = '';
        gridLongs.innerHTML = '';

        // âœ… CHANGE 1: Ab hum 'renderedClips' (Filtered List) check karenge
        if (renderedClips.length === 0) {
            // Agar search kar rahe hain to "No results", nahi to "No videos"
            const msg = searchQuery ? `No results for "${searchQuery}"` : 'No videos found.';
            
            // Jis tab mein hain wahan message dikhao
            if(currentTab === 'shorts') {
                gridShorts.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10 text-sm font-mono">${msg}</div>`;
            } else {
                gridLongs.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10 text-sm font-mono">${msg}</div>`;
            }
            return;
        }

        // âœ… CHANGE 2: Loop bhi ab 'renderedClips' par chalega
        renderedClips.forEach((vid, idx) => {
            const div = document.createElement('div');
            // Decide aspect ratio
            const isShort = vid.type === 'shorts';
            const aspectRatio = isShort ? 'aspect-[9/16]' : 'aspect-video';
            const displayThumb = vid.thumb || "https://placehold.co/320x180/1a1a1a/FFFFFF/png?text=VIDEO"; 

            // ðŸ”¥ EDIT MODE LOGIC
            let titleHTML = '';
            let deleteBtnHTML = '';
            let borderClass = '';

            if (isEditMode) {
                // EDIT MODE ON
                borderClass = 'border-blue-500/50 shadow-[0_0_15px_rgba(59,130,246,0.3)]';
                titleHTML = `
                    <input type="text" 
                           value="${vid.title}" 
                           onblur="saveInlineRename('${vid.fileId}', this.value)" 
                           onkeypress="handleEnter(event, '${vid.fileId}', this.value)"
                           onclick="event.stopPropagation()"
                           class="w-full bg-black/50 border border-blue-400 text-white text-sm px-2 py-1 rounded focus:outline-none focus:bg-black transition"
                    >`;
                
                deleteBtnHTML = `
                    <button onclick="event.stopPropagation(); deleteVideoPermanently('${vid.fileId}')" class="text-red-500 hover:text-white hover:bg-red-600 p-1.5 rounded transition shadow-lg border border-red-500/30 ml-2" title="Delete Forever">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>`;
            } else {
                // NORMAL MODE
                borderClass = 'border-white/10 hover:border-orange-500/50';
                titleHTML = `<h4 class="text-white text-sm font-medium truncate">${vid.title}</h4>`;
                deleteBtnHTML = ''; 
            }

            // MAIN CARD HTML
            div.className = `group relative bg-[#1a1a1a] rounded-xl overflow-hidden border transition shadow-lg ${aspectRatio} ${borderClass}`;
            
            div.innerHTML = `
                <div onclick="${isEditMode ? '' : `openTheater('${vid.link}', '${vid.title}', '${vid.fileId}')`}" class="w-full h-full cursor-pointer relative group">
                    <img src="${displayThumb}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition duration-500">
                    
                    <div class="absolute top-2 right-2 px-2 py-0.5 bg-black/60 backdrop-blur-md rounded text-[10px] text-white font-bold uppercase border border-white/10">
                        ${vid.type === 'shorts' ? 'SHORT' : 'VIDEO'}
                    </div>

                    <div class="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black via-black/90 to-transparent p-3 pt-8">
                        <div class="flex items-center justify-between gap-2">
                            <div class="flex-1 min-w-0">
                                ${titleHTML}
                            </div>
                            ${deleteBtnHTML}
                        </div>
                        
                        ${!isEditMode ? '<div class="text-[10px] text-gray-400 mt-1">Synced</div>' : ''}
                    </div>
                </div>`;
            
            // Correct Placement
            if (vid.type === 'shorts') {
                gridShorts.appendChild(div);
            } else {
                gridLongs.appendChild(div);
            }
        });
    }

// ==========================================
    // 5. 
    // ==========================================
    
    let uploadQueue = [];
    let currentTab = 'shorts'; // âœ… DEFAULT ACTIVE TAB CHANGED TO SHORTS

    // A. File Selection Listener
    const fileInput = document.getElementById('fileInput');
    if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect);
    }

 // A. FILE SELECT (With Thumbnail Promise Tracker)
    async function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        const btn = document.getElementById('btnStartUpload');
        if(btn) btn.classList.remove('hidden');

        for (const file of files) {
            const queueId = Date.now() + Math.random().toString(36).substr(2, 9);
            
            // 1. Thumbnail Generation Start karo (Promise Store karo)
            const thumbPromise = generateVideoThumbnail(file);

            const queueItem = {
                id: queueId,
                file: file,
                customTitle: file.name.split('.').slice(0, -1).join('.'),
                status: 'pending',
                detectedType: 'long', // Default
                thumbPromise: thumbPromise, // ðŸ”¥ Store Promise (Wait karne ke liye)
                thumbData: null 
            };
            
            uploadQueue.push(queueItem);
            
            // UI Render
            renderUploadList(); 

            // Background mein jab thumb ready ho, to UI update kar dena (List ke liye)
            thumbPromise.then(base64 => {
                const item = uploadQueue.find(i => i.id === queueId);
                if(item) {
                    item.thumbData = base64;
                    // Detect Type based on dimensions (Agar generator ne detect kiya ho)
                    // Note: generateVideoThumbnail can be updated to return dims too, 
                    // but for now let's stick to base64 to keep it simple.
                }
            });
        }
    }

    // B. Render List & Detect Dimensions
    function renderUploadList() {
        const list = document.getElementById('uploadList');
        list.innerHTML = '';

        uploadQueue.forEach((item) => {
            const div = document.createElement('div');
            div.className = "flex items-center gap-3 bg-white/5 p-3 rounded-lg border border-white/10 relative overflow-hidden group";
            div.id = `row-${item.id}`;

            const videoUrl = URL.createObjectURL(item.file);

            div.innerHTML = `
                <div class="w-16 h-10 bg-black rounded overflow-hidden flex-shrink-0 relative border border-white/10">
                    <video src="${videoUrl}" 
                           class="w-full h-full object-cover opacity-80" 
                           onloadedmetadata="detectVideoType('${item.id}', this)"
                           onloadeddata="this.currentTime=1"></video>
                </div>

                <div class="flex-1 min-w-0 z-10">
                    <input type="text" 
                        value="${item.customTitle}" 
                        onchange="updateQueueTitle('${item.id}', this.value)"
                        class="bg-transparent border-b border-transparent hover:border-white/20 focus:border-orange-500 text-white text-sm font-medium w-full outline-none px-1 py-0.5 transition placeholder-gray-600"
                        placeholder="Enter Video Title">
                    
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-[10px] text-gray-500 font-mono">${(item.file.size / (1024*1024)).toFixed(1)} MB</span>
                        <div class="flex gap-2">
                            <span id="type-badge-${item.id}" class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-gray-700 text-gray-300">DETECTING...</span>
                            <span id="status-${item.id}" class="text-[10px] font-bold text-gray-400">READY</span>
                        </div>
                    </div>
                </div>

                <button onclick="removeFromQueue('${item.id}')" class="text-gray-600 hover:text-red-500 z-10 p-2" title="Remove">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>

                <div id="progress-${item.id}" class="absolute bottom-0 left-0 h-0.5 bg-orange-500 transition-all duration-300 z-0" style="width: 0%"></div>
            `;
            list.appendChild(div);
        });
    }

    // ðŸ§  BRAIN OF THE SYSTEM: Detect Vertical vs Horizontal
    function detectVideoType(id, videoEl) {
        const item = uploadQueue.find(i => i.id === id);
        if (!item) return;

        const width = videoEl.videoWidth;
        const height = videoEl.videoHeight;
        const badge = document.getElementById(`type-badge-${id}`);

        // Logic: Agar Height zyada hai Width se = Vertical (Shorts)
        if (height > width) {
            item.detectedType = 'shorts';
            if(badge) {
                badge.innerText = "SHORT";
                badge.className = "text-[9px] font-bold px-1.5 py-0.5 rounded bg-purple-600 text-white";
            }
        } else {
            item.detectedType = 'long';
            if(badge) {
                badge.innerText = "LONG";
                badge.className = "text-[9px] font-bold px-1.5 py-0.5 rounded bg-blue-600 text-white";
            }
        }
        console.log(`ðŸ§  Analyzed ${item.file.name}: ${width}x${height} -> ${item.detectedType.toUpperCase()}`);
    }

    function updateQueueTitle(id, newTitle) {
        const item = uploadQueue.find(i => i.id === id);
        if(item) item.customTitle = newTitle || item.file.name;
    }

    function removeFromQueue(id) {
        uploadQueue = uploadQueue.filter(i => i.id !== id);
        renderUploadList();
        if(uploadQueue.length === 0) document.getElementById('btnStartUpload').classList.add('hidden');
    }

    // C. START BATCH UPLOAD
    async function startBatchUpload() {
        const btn = document.getElementById('btnStartUpload');
        btn.disabled = true;
        btn.innerHTML = `<svg class="animate-spin w-4 h-4 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...`;

        for (const item of uploadQueue) {
            if (item.status === 'done') continue;
            await uploadSingleFile(item);
        }

        btn.disabled = false;
        btn.innerHTML = "Upload Complete";
        setTimeout(() => {
            if(uploadQueue.every(i => i.status === 'done')) {
                closeUploadModal();
                uploadQueue = [];
                document.getElementById('uploadList').innerHTML = '';
                btn.classList.add('hidden');
                btn.innerHTML = `<span>Start Upload</span>`;
            }
        }, 1500);
    }

    // D. SINGLE UPLOAD
    function uploadSingleFile(item) {
        return new Promise(async (resolve) => {
            const statusEl = document.getElementById(`status-${item.id}`);
            const progressEl = document.getElementById(`progress-${item.id}`);
            const row = document.getElementById(`row-${item.id}`);

            item.status = 'uploading';
            statusEl.innerText = "INIT...";
            statusEl.className = "text-[10px] font-bold text-orange-400 animate-pulse";

            const uName = currentUser ? currentUser.email : "Guest";

            try {
                const response = await fetch('/api/drive/init-upload', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userName: uName, 
                        projectName: "Raw_Footage", 
                        fileName: item.file.name,
                        fileType: item.file.type 
                    })
                });
                const data = await response.json();
                if(!data.success) throw new Error("Init Failed");

                const xhr = new XMLHttpRequest();
                xhr.open("PUT", data.uploadUrl, true);
                xhr.setRequestHeader("Content-Type", item.file.type);

                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 100;
                        progressEl.style.width = `${percent}%`;
                        statusEl.innerText = `${Math.round(percent)}%`;
                    }
                };

                xhr.onload = async () => {
                    if (xhr.status === 200 || xhr.status === 201 || xhr.status === 308) {
                        await finalizeBatchSuccess(item, data, uName);
                        resolve();
                    } else {
                        await verifyAndFinalizeBatch(item, data, uName);
                        resolve();
                    }
                };
                xhr.onerror = async () => {
                    await verifyAndFinalizeBatch(item, data, uName);
                    resolve();
                };
                xhr.send(item.file);

            } catch (error) {
                console.error(error);
                statusEl.innerText = "FAILED";
                statusEl.className = "text-[10px] font-bold text-red-500";
                item.status = 'error';
                resolve();
            }
        });
    }

// E. FINALIZE (Wait for Thumbnail & Save)
    async function finalizeBatchSuccess(item, data, uName) {
        const statusEl = document.getElementById(`status-${item.id}`);
        const row = document.getElementById(`row-${item.id}`);
        
        statusEl.innerText = "FINALIZING...";
        statusEl.className = "text-[10px] font-bold text-blue-400 animate-pulse";
        
        const finalTitle = item.customTitle || item.file.name;
        const vType = item.detectedType || 'long';

        // ðŸ”¥ CRITICAL: Wait for Thumbnail Generation if not ready
        let finalThumb = item.thumbData;
        if (!finalThumb && item.thumbPromise) {
            try {
                console.log("ðŸ“¸ Waiting for thumbnail generator...");
                finalThumb = await item.thumbPromise; // RUKO ZARA!
            } catch (e) {
                console.error("Thumb Gen Error:", e);
            }
        }

        // Fallback agar abhi bhi fail hua
        if (!finalThumb) {
             finalThumb = vType === 'shorts' 
                ? "https://placehold.co/180x320/2a2a2a/FFFFFF/png?text=NO_PREVIEW" 
                : "https://placehold.co/320x180/1a1a1a/FFFFFF/png?text=NO_PREVIEW";
        }

        const newVid = {
            title: finalTitle, 
            link: data.viewLink || "",
            fileId: data.fileId,
            thumb: finalThumb, // âœ… Ab ye hamesha bhara hua hoga
            type: vType,
            uploadedBy: uName, 
            uploadDate: new Date().toISOString()
        };

        try {
            await window.db.collection('projects').doc(PROJECT_ID).set({
                footageLib: firebase.firestore.FieldValue.arrayUnion(newVid)
            }, { merge: true });

            // âœ… CHANGE: 'push' hata kar 'unshift' lagaya (Add to Top)
          
            currentRawClips.unshift(newVid); // <--- NAYA (Video Top pe aayegi)
            runFilters();
            
            // Auto Switch & Render
            if (vType === 'shorts' && currentTab !== 'shorts') {
                switchType('shorts');
            } else if (vType === 'long' && currentTab !== 'long') {
                switchType('long');
            } else {
                renderVideos();
            }

            item.status = 'done';
            statusEl.innerText = "DONE";
            statusEl.className = "text-[10px] font-bold text-green-500";
            row.classList.add('border-green-500/30', 'bg-green-500/5');

        } catch (error) {
            console.error("DB Error", error);
            statusEl.innerText = "DB ERROR";
            statusEl.className = "text-[10px] font-bold text-red-500";
        }
    }

    async function verifyAndFinalizeBatch(item, data, uName) {
        try {
            const res = await fetch('/api/drive/finalize-upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fileId: data.fileId })
            });
            const result = await res.json();
            if (result.success) {
                await finalizeBatchSuccess(item, data, uName);
            } else {
                throw new Error("Not Found");
            }
        } catch (e) {
            const statusEl = document.getElementById(`status-${item.id}`);
            statusEl.innerText = "NET ERR";
            statusEl.className = "text-[10px] font-bold text-red-500";
        }
    }




    // ðŸ’¾ LOAD DATA ON REFRESH
    async function loadProjectData() {
        console.log("ðŸ”„ Fetching videos from Database...");
        try {
            // Project ID verify karo
            if (!PROJECT_ID) {
                console.warn("No Project ID found.");
                return;
            }

            const doc = await window.db.collection('projects').doc(PROJECT_ID).get();
            if (doc.exists) {
                const data = doc.data();
                if (data.footageLib && Array.isArray(data.footageLib)) {
                    // Global variable update karo
                    // âœ… SORTING LOGIC: Newest Date First
                // Agar date nahi hai (purani video), to wo neeche jayegi
                let rawData = data.footageLib || [];
                currentRawClips = rawData.sort((a, b) => {
                    return new Date(b.uploadDate || 0) - new Date(a.uploadDate || 0);
                });
                  
                    // Grid Refresh karo
                    console.log(`âœ… Loaded ${currentRawClips.length} videos.`);
                    runFilters(); // Ye renderedClips ko set karega aur renderVideos call karega
                     updateStats();
                }
            } else {
                console.log("No saved data found for this project.");
            }
        } catch (error) {
            console.error("Error loading data:", error);
        }
    }

    // ðŸ”¥ PAGE LOAD TRIGGER
    // Ye line script ke end mein add karein taaki refresh par code chale
    window.addEventListener('DOMContentLoaded', () => {
        // Auth check ke baad load karo (thoda delay safe rehta hai)
        setTimeout(loadProjectData, 1000);
    });

   

// ðŸŽ¥ OPEN THEATER (Clean & Direct)
    async function openTheater(link, title, fileId) {
        const modal = document.getElementById('theaterModal');
        if (!modal) return;

        // 1. ID Validation
        let finalId = fileId;
        if (!finalId && link) {
            if(link.includes('/d/')) finalId = link.split('/d/')[1].split('/')[0];
            else if(link.includes('id=')) finalId = link.split('id=')[1].split('&')[0];
        }
        if (!finalId || finalId === 'undefined') return alert("Invalid Video ID");

        // 2. Cleanup Old
        if (window.currentPlayer) {
            window.currentPlayer.destroy();
            window.currentPlayer = null;
        }
        document.getElementById('playerContainer').innerHTML = '';

        // 3. CSS Injection (Vertical/Fit Fix)
        if (!document.getElementById('plyr-custom-css')) {
            const style = document.createElement('style');
            style.id = 'plyr-custom-css';
            style.innerHTML = `
                /* Player ko poora faila do */
                #playerContainer { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
                .plyr { width: 100%; height: 100%; }
                
                /* Video ko original ratio maintain karne do (Vertical Shorts Vertical hi rahenge) */
                video { object-fit: contain; max-height: 95vh; max-width: 100%; width: auto; height: auto; }
                
                /* Iframe Fix */
                iframe.universal-player { width: 100%; height: 95vh; border: none; }
            `;
            document.head.appendChild(style);
        }

        // 4. Loading State
        const playerContainer = document.getElementById('playerContainer');
        playerContainer.innerHTML = `
            <div class="flex flex-col items-center gap-3">
                <svg class="animate-spin h-12 w-12 text-blue-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            </div>`;
        
        // Show Modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);

        try {
            // 5. Source Fetch
            const res = await fetch(`/api/drive/get-video-source/${finalId}`);
            const data = await res.json();
            if(!data.success) throw new Error("Source Failed");

            // 6. Inject Video (No Extra Buttons/Text)
            playerContainer.innerHTML = `
                <div class="w-full h-full flex items-center justify-center relative group">
                    <video id="cinemaPlayer" playsinline controls crossorigin>
                        <source src="${data.url}" type="video/mp4" />
                    </video>

                    <button onclick="switchToUniversalPlayer('${finalId}')" class="absolute top-4 left-4 z-[50] bg-white/10 hover:bg-blue-600 text-white text-[10px] font-bold px-3 py-1.5 rounded backdrop-blur-md border border-white/20 transition opacity-0 group-hover:opacity-100 duration-300">
                        Fix Playback
                    </button>
                </div>
            `;

            // 7. Init Plyr
            window.currentPlayer = new Plyr('#cinemaPlayer', {
                autoplay: true,
                controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen', 'settings'],
                ratio: null, // Critical for Vertical Videos
                keyboard: { focused: true, global: true }
            });

            window.currentPlayer.on('ready', () => {
                window.currentPlayer.play().catch(() => {});
            });

            window.currentPlayer.on('error', () => {
                if(confirm("Video load error. Switch to Universal Player?")) switchToUniversalPlayer(finalId);
            });

        } catch (error) {
            console.error(error);
            playerContainer.innerHTML = `<div class="text-red-500">Error: ${error.message}</div>`;
        }
    }

    /// ðŸ”„ UNIVERSAL PLAYER (Backup Mode)
    function switchToUniversalPlayer(fileId) {
        // 1. Purana Plyr saaf karo
        if (window.currentPlayer) {
            try {
                window.currentPlayer.destroy();
            } catch (e) { console.log("Switch destroy error ignored"); }
            window.currentPlayer = null;
        }
        
        const container = document.getElementById('playerContainer');
        
        // 2. Iframe Inject karo
        // Note: Close button ab seedha 'closeTheater()' call karega
        container.innerHTML = `
            <div class="w-full h-full flex flex-col items-center justify-center bg-black relative">
                <p class="text-gray-500 text-[10px] absolute top-2 animate-pulse">Compatibility Mode Active</p>
                
                <iframe src="https://drive.google.com/file/d/${fileId}/preview" class="universal-player" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                
                <button onclick="closeTheater()" class="absolute top-4 right-4 bg-red-600 hover:bg-red-700 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg z-50 flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    Close
                </button>
            </div>
        `;
    }

// âŒ CLOSE THEATER (Master Close - Instant)
    function closeTheater() {
        const modal = document.getElementById('theaterModal');
        if (!modal) return;

        // 1. Sabse pehle user ke liye Modal gayab karo (Instant Feel)
        modal.classList.remove('opacity-100');
        modal.classList.add('opacity-0');
        modal.classList.add('hidden');
        modal.classList.remove('flex');

        // 2. Player Destroy karo (Agar Plyr chal raha hai)
        if (window.currentPlayer) {
            try {
                window.currentPlayer.destroy();
            } catch (e) { console.log("Player destroy error ignored"); }
            window.currentPlayer = null;
        }

        // 3. Container Khali karo (Iframe/Video sab uda do)
        // Ye step Iframe ko kill karega aur wo 401 Errors aana band ho jayenge
        const container = document.getElementById('playerContainer');
        if (container) container.innerHTML = ''; 
    }
    
   // âœ… MISSING FUNCTION ADDED HERE
    function openUploadModal() {
        const modal = document.getElementById('uploadFootageModal');
        if (modal) {
            modal.classList.remove('hidden');
            // Reset steps if needed
            document.getElementById('uploadStep1').classList.remove('hidden');
            document.getElementById('uploadStep2').classList.add('hidden');
            document.getElementById('uploadStep3').classList.add('hidden');
        } else {
            console.error("Error: Upload Modal ID not found!");
        }
    }

    function closeUploadModal() {
        document.getElementById('uploadFootageModal').classList.add('hidden');
    }
    
    async function deleteClip(idx) {
        if(!confirm("Delete?")) return;
        const newClips = [...currentRawClips];
        newClips.splice(idx, 1);
        await window.db.collection('projects').doc(PROJECT_ID).update({ footageLib: newClips });
    }

    // ðŸ”§ FIX PLAYBACK FUNCTION (Ye Missing Tha!)
    async function fixPlayback(fileId) {
        // Button ko dhoondo
        const btn = event.target.closest('button');
        if (!btn) return;

        const originalText = btn.innerHTML;
        btn.innerHTML = `
            <svg class="animate-spin w-3 h-3 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> 
            Fixing...`;
        btn.disabled = true;

        try {
            console.log(`ðŸ”§ Requesting Permission Fix for: ${fileId}`);
            
            // Server ko bolo: "Ise Public Karo!"
            const res = await fetch('/api/drive/repair-permissions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fileId: fileId })
            });
            
            const data = await res.json();
            
            if(data.success) {
                console.log("âœ… Fixed!");
                btn.innerHTML = "âœ… Fixed! Reloading...";
                btn.classList.remove('bg-red-600', 'border-red-400');
                btn.classList.add('bg-green-600', 'border-green-400');
                
                // Magic: Iframe ko reload karo bina page refresh kiye
                setTimeout(() => {
                    const iframe = document.querySelector('#playerContainer iframe');
                    if(iframe) {
                        iframe.src = iframe.src; // Reloads the video
                    }
                    
                    // Button reset
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        btn.classList.remove('bg-green-600', 'border-green-400');
                        btn.classList.add('bg-red-600', 'border-red-400');
                    }, 2000);
                }, 1000);
            } else {
                throw new Error(data.error || "Server refused fix.");
            }
        } catch(e) {
            console.error(e);
            alert("Fix Failed: " + e.message);
            btn.innerHTML = "âŒ Error";
            btn.disabled = false;
        }
    }




    // âœ… FIX 1: MISSING FUNCTION (Isse loading error khatam hoga)
    function updateStats() {
        // Filhal ye dummy hai taaki code crash na ho
        const total = currentRawClips.length;
        const shorts = currentRawClips.filter(v => v.type === 'shorts').length;
        console.log(`Stats Updated: Total ${total}, Shorts ${shorts}`);
        // Agar aapke pass stats ka HTML element hai to yahan update karein
    }

    // âœ… FIX 2: TOGGLE EDIT MODE (With Save Button)
    function toggleEditMode() {
        isEditMode = !isEditMode; // Switch
        
        const container = document.getElementById('editControlsContainer');
        
        if (isEditMode) {
            // SHOW SAVE BUTTON (Green)
            container.innerHTML = `
                <button onclick="saveAndExitEditMode()" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold px-4 py-2 rounded-full shadow-lg flex items-center gap-2 transition animate-pulse">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    Save Changes
                </button>
            `;
        } else {
            // SHOW EDIT ICON (Normal)
            container.innerHTML = `
                <button onclick="toggleEditMode()" class="p-2 rounded-full hover:bg-white/10 text-gray-400 hover:text-white transition" title="Edit Videos">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                </button>
            `;
        }

        renderVideos(); // UI Refresh to show/hide inputs
    }

    // âœ… NEW FUNCTION: Save & Exit
    function saveAndExitEditMode() {
        // Asli save "OnBlur" (Type karte hi) ho jata hai, 
        // ye button bas User Satisfaction aur Mode Close karne ke liye hai.
        toggleEditMode(); // Mode OFF karo
        alert("All changes saved successfully!");
    }

    // âœ… FIX 3: DELETE FUNCTION (Detailed Error Handling)
    async function deleteVideoPermanently(fileId) {
        if(!confirm("âš ï¸ PERMANENT DELETE WARNING:\n\nThis will remove the video from Drive and App forever.\nAre you sure?")) return;

        try {
            console.log("ðŸ—‘ï¸ Sending Delete Request for:", fileId);

            // A. Server Call
            const res = await fetch('/api/drive/delete-file', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fileId })
            });
            
            const data = await res.json();
            
            // Server Error Catch
            if(!res.ok || !data.success) {
                throw new Error(data.error || "Server responded with error");
            }

            // B. Local Update
            const updatedClips = currentRawClips.filter(c => c.fileId !== fileId);
            
            // C. Database Update
            await window.db.collection('projects').doc(PROJECT_ID).update({
                footageLib: updatedClips
            });

            // D. UI Refresh
            currentRawClips = updatedClips;
            runFilters(); // âœ… renderVideos ki jagah runFilters call karo
            updateStats();
            
            console.log("âœ… Deleted Successfully");

        } catch (error) {
            console.error("Delete Error:", error);
            alert("âŒ Delete Failed: " + error.message);
        }
    }

    // âœ… FIX 4: RENAME FUNCTION (Same as before, keep it)
    async function saveInlineRename(fileId, newName) {
        if (!newName || newName.trim() === "") return;
        const video = currentRawClips.find(v => v.fileId === fileId);
        if(video && video.title === newName) return;

        try {
            // Server Call
            await fetch('/api/drive/rename-file', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fileId, newName })
            });

            // Local & DB Update
            currentRawClips = currentRawClips.map(v => v.fileId === fileId ? {...v, title: newName} : v);
            await window.db.collection('projects').doc(PROJECT_ID).update({ footageLib: currentRawClips });
            console.log("âœ… Renamed");
        } catch (error) {
            console.error("Rename Error:", error);
        }
    }

    // ðŸ§  THE BRAIN: Filters + Search + Sorting
    function runFilters() {
        let results = [...currentRawClips]; // Copy master list

        // 1. Apply Time/Category Filters
        const now = new Date();
        if (activeCategory === 'today') {
            results = results.filter(v => new Date(v.uploadDate).toDateString() === now.toDateString());
        } else if (activeCategory === 'week') {
            const lastWeek = new Date();
            lastWeek.setDate(now.getDate() - 7);
            results = results.filter(v => new Date(v.uploadDate) >= lastWeek);
        } else if (activeCategory === 'month') {
            const lastMonth = new Date();
            lastMonth.setDate(now.getDate() - 30);
            results = results.filter(v => new Date(v.uploadDate) >= lastMonth);
        } else if (activeCategory === 'bts') {
            // BTS Logic: Title contains 'bts' (Case insensitive)
            results = results.filter(v => v.title.toLowerCase().includes('bts'));
        }

        // 2. Apply Search (Smart Ranking)
        if (searchQuery.trim() !== '') {
            const query = searchQuery.toLowerCase().trim();
            
            // Filter pehle karo
            results = results.filter(v => v.title.toLowerCase().includes(query));

            // FIR SORT KARO (Ranking Logic)
            results.sort((a, b) => {
                const titleA = a.title.toLowerCase();
                const titleB = b.title.toLowerCase();

                // Rule 1: Agar title query se START hota hai, to wo Top par (Highest Priority)
                const startA = titleA.startsWith(query);
                const startB = titleB.startsWith(query);
                
                if (startA && !startB) return -1; // A upar
                if (!startA && startB) return 1;  // B upar

                // Rule 2: Agar title exact match hai
                if (titleA === query) return -1;
                if (titleB === query) return 1;

                return 0; // Barabar
            });
        }

        // 3. Update Display & Render
        renderedClips = results;
        renderVideos(); // Screen update karo
    }


    // ðŸ” SEARCH FUNCTIONS
    
    // 1. Expand Search Bar (Netflix Style)
    function expandSearch() {
        const box = document.getElementById('searchBox');
        const input = document.getElementById('videoSearchInput');
        box.classList.add('expanded');
        input.focus();
    }

    // 2. Handle Typing (Real-time Filter)
    document.getElementById('videoSearchInput').addEventListener('input', (e) => {
        searchQuery = e.target.value; // Query update
        runFilters(); // ðŸ§  Brain ko chalao
    });

    // 3. Close Search if click outside
    document.addEventListener('click', (e) => {
        const box = document.getElementById('searchBox');
        // Agar click box ke bahar hua AND input khali hai
        if (!box.contains(e.target) && searchQuery === '') {
            box.classList.remove('expanded');
        }
    });


    // ðŸ’Š FILTER PILLS FUNCTION
    function filterBy(category, btnElement) {
        // 1. State Update
        activeCategory = category;

        // 2. UI Update (Highlight Active Pill)
        // Sabhi pills se 'active' class hatao
        document.querySelectorAll('.filter-pill').forEach(btn => {
            btn.classList.remove('active', 'bg-white', 'text-black', 'font-bold', 'box-shadow');
            // Reset style classes logic if needed based on your CSS
            btn.classList.remove('active'); 
        });
        
        // Clicked pill ko active karo
        btnElement.classList.add('active');

        // 3. Logic Run
        runFilters();
    }

// ðŸ”™ BACK BUTTON FUNCTION
    function goBackToHub() {
        // Project Hub par wapas jao
        window.location.href = 'project-hub.html';
    }
</script>
<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
</body>
</html>