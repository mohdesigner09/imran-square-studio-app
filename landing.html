<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Welcome - IMRAN SQUARE</title>

      <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#ff6b35">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="IMRAN SQUARE">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons for iOS -->
    <link rel="apple-touch-icon" href="/resources/icon-152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/resources/icon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/resources/icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/resources/icon-192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/resources/icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/resources/icon-16.png">
    <link rel="shortcut icon" href="/resources/favicon.ico">


  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      background: #050505;
      color: white;
      font-family: 'Inter', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    .hero-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 50% 30%, #151515 0%, #000000 100%);
      z-index: 0;
    }
    .film-grain {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0.04;
      z-index: 1;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    }

  
  </style>
</head>


<body class="relative min-h-screen bg-black text-white">
  <div class="hero-bg"></div>
  <div class="film-grain"></div>

   <header class="sticky top-0 z-50 backdrop-blur-xl bg-black/50 border-b border-white/10">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        
        <!-- Logo -->
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-lg bg-orange-500/20 border border-orange-500/50 flex items-center justify-center">
            <span class="text-orange-400 font-bold text-sm">IS</span>
          </div>
          <div class="hidden md:block">
            <p class="text-xs tracking-[0.25em] text-orange-400 font-semibold">IMRAN SQUARE</p>
            <p class="text-[9px] tracking-wider text-gray-500">DOCUMENTARY STUDIO</p>
          </div>
        </div>
        
             <!-- Desktop Navigation -->
      <nav class="hidden md:flex items-center gap-4">
        <a href="#features" class="text-sm text-gray-300 hover:text-white transition">Features</a>
        <a href="#pricing" class="text-sm text-gray-300 hover:text-white transition">Pricing</a>
        
        <!-- Install Button (desktop only) -->
        <button id="pwaInstallBtn"
          class="hidden md:flex px-5 py-2 rounded-full bg-orange-600 text-white text-sm font-semibold hover:bg-orange-700 hover:shadow-lg transition-all items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
          </svg>
          Install App
        </button>

        <!-- Get Started Button (desktop only) -->
        <button id="signupBtn"
          class="hidden md:flex px-5 py-2 rounded-full bg-gradient-to-r from-orange-500 to-orange-600 text-white text-sm font-semibold hover:shadow-lg transition">
          Get Started
        </button>
      </nav>

      <!-- Mobile Menu Button (sirf ye rehne do) -->
      <button class="md:hidden p-2 text-white">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>

        
        <button id="pwaInstallBtn" class="px-5 py-2 rounded-full bg-orange-600 text-white text-sm font-semibold hover:bg-orange-700 transition flex items-center gap-2">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
    </svg>
    Install App
  </button>
  
  <button id="signupBtn" class="...">Get Started</button>
</nav>

        <!-- Mobile Menu Button -->
        <button class="md:hidden p-2 text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

   <div
    class="relative w-full max-w-md mx-auto md:ml-auto md:mr-16
           rounded-3xl bg-gradient-to-b from-white/5 to-black/80
           border border-white/10 shadow-[0_0_80px_rgba(0,0,0,0.8)]
           px-6 sm:px-8 py-7 space-y-6 z-10">
    
    <!-- Logo -->
    <div class="text-center space-y-1">
      <p class="text-[11px] tracking-[0.3em] text-orange-400">IMRAN SQUARE</p>
      <p class="text-[10px] tracking-[0.25em] text-gray-400">DOCUMENTARY CREATOR STUDIO</p>
    </div>

    <!-- Step title -->
    <div id="stepTitle" class="text-center space-y-1">
      <h1 class="text-lg font-semibold text-white">Sign in to continue</h1>
      <p class="text-[11px] text-gray-400">Choose a way to continue to your studio.</p>
    </div>

   <!-- STEP 1 PROVIDER OPTIONS -->
<div id="stepProviders" class="space-y-4">
  <!-- Primary sign-in / sign-up action -->
  <button
    id="btnGoogle"
    class="w-full px-4 py-2.5 rounded-full bg-white text-black text-sm font-medium hover:bg-gray-100 transition flex items-center justify-center gap-2"
  >
    <span>üîç</span><span>Sign in with Google</span>
  </button>

  <!-- Divider text -->
  <div class="pt-2">
    <p class="text-[11px] text-gray-400 text-center uppercase tracking-[0.18em]">
      Already have an account?
    </p>
  </div>

  <!-- Existing user login options -->
  <button
    id="btnLoginGoogle"
    class="w-full px-4 py-2.5 rounded-full bg-gray-800 text-white text-sm font-medium hover:bg-gray-700 transition"
  >
    Login with Google
  </button>

  <button
    id="btnUsername"
    class="w-full px-4 py-2.5 rounded-full bg-gray-800 text-white text-sm font-medium hover:bg-gray-700 transition"
  >
    Login with Username
  </button>
</div>

    <!-- STEP 2: CONTACT INPUT -->
    <div id="stepContact" class="hidden space-y-3">
      <label id="contactLabel" class="block text-sm text-gray-300">Email address</label>
      
      <input 
        id="contactInput"
        type="email" 
        placeholder="you@example.com"
        class="w-full px-4 py-2.5 rounded-full bg-gray-900 border border-gray-700 text-white text-sm focus:outline-none focus:border-gray-500"
      />
      
      <p id="contactHint" class="text-xs text-gray-400">
        A 6-digit code will be sent to this email address.
      </p>
      
      <button id="btnSendOtp" 
        class="w-full px-4 py-2.5 rounded-full bg-white text-black text-sm font-medium hover:bg-gray-100 transition"
      >
        Send code
      </button>
      
      <button id="btnBackToProviders" 
        class="w-full px-3 py-2 rounded-full border border-gray-700 text-xs text-gray-300 hover:bg-gray-800"
      >
        ‚Üê Back
      </button>
    </div>

    <!-- STEP 3: VERIFY OTP -->
    <div id="stepOtp" class="hidden space-y-3">
      <div class="text-center text-sm text-gray-400">
        OTP sent to <span id="displayEmail" class="text-white font-medium"></span>
      </div>
      
      <input 
        type="text" 
        id="otpInput" 
        placeholder="Enter 6-digit OTP"
        maxlength="6"
        class="w-full px-4 py-2.5 rounded-full bg-gray-900 border border-gray-700 text-white text-sm text-center tracking-widest focus:outline-none focus:border-gray-500"
      />
      
      <div class="text-center text-sm text-gray-400">
        Time remaining: <span id="timer" class="text-white font-medium">60</span>s
      </div>
      
      <button 
        id="btnVerifyOtp"
        class="w-full px-4 py-2.5 rounded-full bg-white text-black text-sm font-medium hover:bg-gray-100 transition"
      >
        Verify OTP
      </button>
      
      <button 
        id="btnResendOtp"
        class="w-full px-4 py-2.5 rounded-full bg-gray-800 text-white text-sm font-medium hover:bg-gray-700 transition"
      >
        Resend OTP
      </button>
    </div>

    <!-- STEP 4: REGISTRATION -->
 <div id="stepRegister" class="space-y-4 hidden text-sm">   <!--</div>-->
      <div class="space-y-2">
        <div class="flex gap-2">
          <div class="flex-1">
            <label class="block text-[11px] text-gray-400 mb-1">First name</label>
            <input id="firstName" class="w-full px-3 py-2 rounded-xl bg-black/50 border border-white/15 text-sm text-gray-100 focus:outline-none focus:border-orange-400">
          </div>
          <div class="flex-1">
            <label class="block text-[11px] text-gray-400 mb-1">Last name</label>
            <input id="lastName" class="w-full px-3 py-2 rounded-xl bg-black/50 border border-white/15 text-sm text-gray-100 focus:outline-none focus:border-orange-400">
          </div>
        </div>

        <div>
          <label class="block text-[11px] text-gray-400 mb-1">Username</label>
          <input id="username" class="w-full px-3 py-2 rounded-xl bg-black/50 border border-white/15 text-sm text-gray-100 focus:outline-none focus:border-orange-400">
          <p id="usernameHint" class="text-[10px] text-gray-500 mt-1">This must be unique.</p>
        </div>

        <div>
          <label class="block text-[11px] text-gray-400 mb-1">Brother's name (required)</label>
          <input id="brotherName" class="w-full px-3 py-2 rounded-xl bg-black/50 border border-white/15 text-sm text-gray-100 focus:outline-none focus:border-orange-400" placeholder="IMRAN KHAN">
          <p class="text-[10px] text-gray-500 mt-1">Must be exactly "IMRAN KHAN".</p>
        </div>

        <div class="flex gap-2">
          <div class="flex-1">
            <label class="block text-11px text-gray-400 mb-1">New password</label>
            <div class="relative">
              <input id="password" type="password" class="w-full px-3 py-2 pr-10 rounded-xl bg-black/50 border border-white/15 text-sm text-gray-100 focus:outline-none focus:border-orange-400">
              <button type="button" id="togglePassword" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-200 text-sm">
                üëÅÔ∏è
              </button>
            </div>
          </div>
          <div class="flex-1">
            <label class="block text-11px text-gray-400 mb-1">Confirm password</label>
            <div class="relative">
              <input id="passwordConfirm" type="password" class="w-full px-3 py-2 pr-10 rounded-xl bg-black/50 border border-white/15 text-sm text-gray-100 focus:outline-none focus:border-orange-400">
              <button type="button" id="togglePasswordConfirm" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-200 text-sm">
                üëÅÔ∏è
              </button>
            </div>
          </div>
        </div>

        <div>
          <label class="block text-[11px] text-gray-400 mb-1">Primary role (optional)</label>
          <select id="role" class="w-full px-3 py-2 rounded-xl bg-black/50 border border-white/15 text-[13px] text-gray-100 focus:outline-none focus:border-orange-400">
            <option value="">Select</option>
            <option value="director">Director</option>
            <option value="editor">Editor</option>
            <option value="colorist">Colorist</option>
            <option value="producer">Producer</option>
          </select>
        </div>
      </div>

      <button id="btnRegister" class="w-full px-4 py-2.5 rounded-full bg-orange-500/40 text-sm text-black/40 font-medium cursor-not-allowed transition">
        Complete setup
      </button>
      
      <button id="btnBackToLogin" class="w-full px-3 py-2 rounded-full border border-white/15 text-11px text-gray-300 hover:bg-white/5">
        ‚Üê Back to login
      </button>
    </div>

    <!-- STEP USERNAME LOGIN -->
<div id="stepUsernameLogin" class="hidden space-y-3">
  <label class="block text-sm text-gray-300">Username</label>
  <input
    id="loginUsername"
    type="text"
    placeholder="yourusername"
    class="w-full px-4 py-2.5 rounded-full bg-gray-900 border border-gray-700 text-white text-sm focus:outline-none focus:border-gray-500"
  />

  <label class="block text-sm text-gray-300 mt-2">Password</label>
  <input
    id="loginPassword"
    type="password"
    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
    class="w-full px-4 py-2.5 rounded-full bg-gray-900 border border-gray-700 text-white text-sm focus:outline-none focus:border-gray-500"
  />

  <button
    id="btnUsernameLogin"
    class="w-full px-4 py-2.5 rounded-full bg-white text-black text-sm font-medium hover:bg-gray-100 transition"
  >
    Sign in
  </button>

  <button
    id="btnBackFromUsername"
    class="w-full px-3 py-2 rounded-full border border-gray-700 text-xs text-gray-300 hover:bg-gray-800"
  >
    ‚Üê Back
  </button>
</div>

    <!-- Toast -->
    <div id="toast" class="hidden absolute -bottom-14 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full bg-white/90 text-xs text-black shadow-lg z-50">
      Welcome to IMRAN SQUARE.
    </div>
  </div>

  

<script>


// GLOBAL STATE
let currentProvider = null;
let contactValue = null;
let timerInterval = null;

// Simple helper like jQuery
function $(id) {
  return document.getElementById(id);
}

// API base URL - automatically uses current domain
const API_BASE = window.location.hostname === 'localhost' 
  ? 'http://localhost:3000' 
  : 'https://imran-square-studio.onrender.com';


// YAHAN YE 4 LINES ADD KARO üëá
const stepProviders = $('stepProviders');
const stepContact   = $('stepContact');
const stepOtp       = $('stepOtp');
const stepRegister  = $('stepRegister');


function showStep(stepId) {
  const allIds = [
    'stepProviders',
    'stepContact',
    'stepOtp',
    'stepRegister',
    'stepUsernameLogin'
  ];
  allIds.forEach(id => {
    const el = $(id);
    if (el) el.classList.add('hidden');
  });
  const target = $(stepId);
  if (target) target.classList.remove('hidden');
}






function setStepTitle(title, subtitle) {
  const wrapper = $('stepTitle');
  if (!wrapper) return;
  const h1 = wrapper.querySelector('h1');
  const p = wrapper.querySelector('p');
  if (h1) h1.textContent = title;
  if (p) p.textContent = subtitle;
}

function showToast(msg, timeout = 3000) {
  const el = $('toast');
  if (!el) {
    alert(msg);
    return;
  }
  el.textContent = msg;
  el.classList.remove('hidden');

  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(() => {
    el.classList.add('hidden');
  }, timeout);
}


function startTimer(seconds = 60) {
  const timer = $('timer');
  const btnResendOtp = $('btnResendOtp');
  
  if (!timer) return;
  
  let timeLeft = seconds;
  timer.textContent = `${timeLeft}`;
  
  if (btnResendOtp) btnResendOtp.disabled = true;
  
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeLeft--;
    timer.textContent = `${timeLeft}`;
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      if (btnResendOtp) btnResendOtp.disabled = false;
    }
  }, 1000);
}

// ===== REGISTRATION HELPERS =====
function getAllUsers() {
  return JSON.parse(localStorage.getItem('imranUsers') || '[]');
}

function isUsernameAvailable(username) {
  if (!username) return false;
  const list = getAllUsers();
  return !list.some(u => (u.username || '').toLowerCase() === username.toLowerCase());
}

function validateRegisterForm() {
  const first = $('firstName').value.trim();
  const last = $('lastName').value.trim();
  const user = $('username').value.trim();
  const bro = $('brotherName').value.trim();
  const pass = $('password').value;
  const pass2 = $('passwordConfirm').value;

  let ok = true;

  if (!first || !last) ok = false;
  if (!/^[a-z0-9_]{3,}$/.test(user)) ok = false;

  if (!user || !isUsernameAvailable(user)) {
    ok = false;
    const hint = $('usernameHint');
    if (user) {
      hint.textContent = 'This username is already taken.';
      hint.classList.remove('text-gray-500');
      hint.classList.add('text-red-400');
    } else {
      hint.textContent = 'This must be unique.';
      hint.classList.remove('text-red-400');
      hint.classList.add('text-gray-500');
    }
  } else {
    const hint = $('usernameHint');
    hint.textContent = 'Great, this username is available.';
    hint.classList.remove('text-red-400');
    hint.classList.add('text-green-400');
  }

  if (bro !== 'IMRAN KHAN') ok = false;
  if (!pass || pass.length < 8 || pass !== pass2) ok = false;

  const btnReg = $('btnRegister');
  if (btnReg) {
    if (ok) {
      btnReg.classList.remove('cursor-not-allowed', 'bg-orange-500/40', 'text-black/40');
      btnReg.classList.add('bg-orange-500', 'text-black');
    } else {
      btnReg.classList.add('cursor-not-allowed', 'bg-orange-500/40', 'text-black/40');
      btnReg.classList.remove('bg-orange-500', 'text-black');
    }
  }

  return ok;
}


// ===== DOM READY =====
document.addEventListener('DOMContentLoaded', function () {
  console.log('‚úÖ DOM Ready');

  // Default view on first load
  showStep('stepProviders');
  setStepTitle('Sign in to continue', 'Choose a way to continue to your studio.');

  // STEP SWITCHER
  function showStep(stepId) {
    const allIds = [
      'stepProviders',
      'stepContact',
      'stepOtp',
      'stepRegister',
      'stepUsernameLogin'
    ];
    allIds.forEach(id => {
      const el = $(id);
      if (el) el.classList.add('hidden');
    });
    const target = $(stepId);
    if (target) target.classList.remove('hidden');
  }

  // Primary Google sign-in (new or first-time users)
  const btnGoogle = $('btnGoogle');
  if (btnGoogle) {
    btnGoogle.addEventListener('click', () => {
      currentProvider = 'google';
      setStepTitle('Sign in with Google', 'We will send a one-time code to your Gmail.');
      $('contactLabel').textContent = 'Google email';
      $('contactInput').placeholder = 'you@gmail.com';
      $('contactHint').textContent = 'A 6-digit code will be sent to this Gmail address.';
      $('contactInput').value = '';
      showStep('stepContact');
    });
  }

  // Existing user: Login with Google (same OTP flow, different copy)
  const btnLoginGoogle = $('btnLoginGoogle');
  if (btnLoginGoogle) {
    btnLoginGoogle.addEventListener('click', () => {
      currentProvider = 'google';
      setStepTitle('Login with Google', 'Enter the Gmail linked to your IMRAN SQUARE account.');
      $('contactLabel').textContent = 'Google email';
      $('contactInput').placeholder = 'you@gmail.com';
      $('contactHint').textContent = 'You will receive a 6-digit login code.';
      $('contactInput').value = '';
      showStep('stepContact');
    });
  }
// Existing user: Login with Username button (providers screen)
const btnUsername = $('btnUsername');
if (btnUsername) {
  btnUsername.addEventListener('click', () => {
    setStepTitle('Login with username', 'Use your username and password to enter your studio.');
    showStep('stepUsernameLogin');
  });
}


// USERNAME + PASSWORD LOGIN SUBMIT
const btnUsernameLogin = $('btnUsernameLogin');
if (btnUsernameLogin) {
  btnUsernameLogin.addEventListener('click', async () => {
    const user = $('loginUsername').value.trim();
    const pass = $('loginPassword').value;

    if (!user || !pass) {
      alert('Enter username and password');
      return;
    }

    btnUsernameLogin.disabled = true;
    btnUsernameLogin.textContent = 'Signing in...';
    try {
      const res = await fetch(`${API_BASE}/api/login-username`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: user, password: pass })
      });


      const data = await res.json();
      console.log('USERNAME LOGIN RESPONSE:', data);

      if (!data.success || !data.user) {
        alert(data.message || 'Login failed');
        btnUsernameLogin.disabled = false;
        btnUsernameLogin.textContent = 'Sign in';
        return;
      }

      localStorage.setItem('imranUser', JSON.stringify(data.user));
      localStorage.setItem('userEmail', data.user.email);
      localStorage.setItem('userId', data.user.userId || '');

      window.location.href = 'index.html';
    } catch (err) {
      console.error('Username login error:', err);
      alert('Login error, please try again.');
      btnUsernameLogin.disabled = false;
      btnUsernameLogin.textContent = 'Sign in';
    }
  });
}



  // ---- Back button (from contact step) ----
  const btnBackToProviders = $('btnBackToProviders');
  if (btnBackToProviders) {
    btnBackToProviders.addEventListener('click', () => {
      currentProvider = null;
      contactValue = null;
      setStepTitle('Sign in to continue', 'Choose a way to continue to your studio.');
      showStep('stepProviders');
    });
  }

  // ---- SEND OTP ----
  const btnSendOtp = $('btnSendOtp');
  if (btnSendOtp) {
    btnSendOtp.addEventListener('click', async () => {
      if (!currentProvider) {
        alert('Choose a sign-in method first');
        return;
      }

      const contactInput = $('contactInput');
      const contact = contactInput ? contactInput.value.trim() : '';

      if (!contact) {
        alert('Please enter your email or phone number');
        return;
      }

      contactValue = contact;
      console.log('üìß CONTACT SAVED:', contactValue);

      btnSendOtp.disabled = true;
      btnSendOtp.textContent = 'Sending...';

       try {
        const res = await fetch(`${API_BASE}/api/send-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: contact })
        });


        const data = await res.json();
        console.log('‚úâÔ∏è SEND OTP RESPONSE:', data);

        if (!data.success) {
          alert(data.message || 'Failed to send OTP');
          btnSendOtp.disabled = false;
          btnSendOtp.textContent = 'Send code';
          return;
        }

        // success case:
showToast('OTP sent successfully');


        const displayEmail = $('displayEmail');
        if (displayEmail) displayEmail.textContent = contact;

        showToast('OTP sent successfully'); 
        
        showStep('stepOtp');
        setStepTitle('Check your inbox', `Enter the 6-digit code sent to ${contact}.`);
        $('otpInput').value = '';
        startTimer(60);

        btnSendOtp.disabled = false;
        btnSendOtp.textContent = 'Resend code';
      } catch (err) {
        console.error('‚ùå SEND OTP ERROR:', err);
        alert('Failed to send OTP. Please try again.');
        btnSendOtp.disabled = false;
        btnSendOtp.textContent = 'Send code';
      }
    });
  }

// ---- VERIFY OTP ----
const btnVerifyOtp = $('btnVerifyOtp');
if (btnVerifyOtp) {
  btnVerifyOtp.addEventListener('click', async () => {
    const code = $('otpInput').value.trim();
    console.log('DEBUG OTP:', { code, contactValue, currentProvider });

    if (!code || !contactValue) {
      alert('Enter the OTP first');
      return;
    }

    btnVerifyOtp.disabled = true;
    btnVerifyOtp.textContent = 'Verifying...';

  try {
  const res = await fetch(`${API_BASE}/api/verify-otp`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      email: contactValue,
      code
    })
  });


      const data = await res.json();
      console.log('VERIFY RESPONSE:', data);

      if (data.success) {
        const u = data.user;
        const isNew = data.isNew;

        if (!u) {
          alert('Login error. Please try again.');
          btnVerifyOtp.disabled = false;
          btnVerifyOtp.textContent = 'Verify OTP';
          return;
        }

        if (isNew) {
          // üÜï New user ‚Üí registration form
          console.log('‚úÖ OTP VERIFIED, NEW user ‚Üí registration');
          localStorage.setItem('userEmail', contactValue);
          setStepTitle('Complete your profile', 'Just a few details to set up your studio.');
          showStep('stepRegister');
        } else {
          // ‚úÖ Existing user ‚Üí direct dashboard
          console.log('‚úÖ OTP VERIFIED, EXISTING user ‚Üí dashboard');
        localStorage.setItem('imranUser', JSON.stringify(u));
localStorage.setItem('userEmail', u.email);
localStorage.setItem('userId', u.userId || '');
localStorage.setItem('imranWelcome', '1');   // <-- add

window.location.href = 'index.html';

        }
      } else {
        alert(data.message || 'Invalid OTP');
        btnVerifyOtp.disabled = false;
        btnVerifyOtp.textContent = 'Verify OTP';
      }
    } catch (err) {
      console.error('VERIFY ERROR:', err);
      alert('Verification failed');
      btnVerifyOtp.disabled = false;
      btnVerifyOtp.textContent = 'Verify OTP';
    }
  });
}


  // ---- RESEND OTP ----
  const btnResendOtp = $('btnResendOtp');
  if (btnResendOtp) {
    btnResendOtp.addEventListener('click', async () => {
      if (!contactValue || !currentProvider) {
        alert('Session expired. Please start again.');
        return;
      }

      btnResendOtp.disabled = true;
      btnResendOtp.textContent = 'Sending...';

        try {
        const res = await fetch(`${API_BASE}/api/send-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: contactValue })
        });


        const data = await res.json();
        if (data.success) {
          showToast('OTP resent successfully');
          startTimer(60);
        } else {
          alert(data.message || 'Failed to resend OTP');
        }
      } catch (err) {
        console.error(err);
        alert('Failed to resend OTP');
      } finally {
        btnResendOtp.disabled = false;
        btnResendOtp.textContent = 'Resend OTP';
      }
    });
  }

  // ---- REGISTRATION FORM VALIDATION ----
  ['firstName', 'lastName', 'username', 'brotherName', 'password', 'passwordConfirm'].forEach(id => {
    const el = $(id);
    if (el) el.addEventListener('input', validateRegisterForm);
  });

  // ---- COMPLETE REGISTRATION ----
  const btnRegister = $('btnRegister');
  if (btnRegister) {
    btnRegister.addEventListener('click', async () => {
      if (!validateRegisterForm()) {
        alert('Please complete all required fields correctly.');
        return;
      }

      const first = $('firstName').value.trim();
      const last = $('lastName').value.trim();
      const username = $('username').value.trim();
      const role = $('role').value || null;
      const email = localStorage.getItem('userEmail');

      if (!email) {
        alert('Email not found. Please login again.');
        return;
      }

      btnRegister.disabled = true;
      btnRegister.textContent = 'Creating account...';

      try {
        const res = await fetch(`${API_BASE}/api/complete-registration`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            email, 
            firstName: first, 
            lastName: last, 
            username, 
            role,
            password: $('password').value
          })
        });



        

        const data = await res.json();

 if (data.success && data.user) {
localStorage.setItem('imranUser', JSON.stringify(data.user));
localStorage.setItem('userEmail', data.user.email);
localStorage.setItem('userId', data.user.userId || '');
localStorage.setItem('imranWelcome', '1');   // <-- new

window.location.href = 'index.html';


}


          
         else {
          alert(data.message || 'Failed to complete registration');
          btnRegister.disabled = false;
          btnRegister.textContent = 'Complete setup';
        }
      } catch (err) {
        console.error('‚ùå Registration error:', err);
        alert('Failed to create account. Check console.');
        btnRegister.disabled = false;
        btnRegister.textContent = 'Complete setup';
      }
    });
  }

  // ---- PASSWORD TOGGLE ----
  const togglePassword = $('togglePassword');
  const passwordInput = $('password');
  if (togglePassword && passwordInput) {
    togglePassword.addEventListener('click', () => {
      const type = passwordInput.type === 'password' ? 'text' : 'password';
      passwordInput.type = type;
      togglePassword.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
    });
  }

  const togglePasswordConfirm = $('togglePasswordConfirm');
  const passwordConfirmInput = $('passwordConfirm');
  if (togglePasswordConfirm && passwordConfirmInput) {
    togglePasswordConfirm.addEventListener('click', () => {
      const type = passwordConfirmInput.type === 'password' ? 'text' : 'password';
      passwordConfirmInput.type = type;
      togglePasswordConfirm.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
    });
  }

  // ---- BACK TO LOGIN ----
 const btnBackToLogin = $('btnBackToLogin');
if (btnBackToLogin) {
  btnBackToLogin.addEventListener('click', () => {
    showStep('stepProviders');
    setStepTitle('Sign in to continue', 'Choose a way to continue to your studio.');
  });
}

  // ---- BACK FROM USERNAME LOGIN ----
  const btnBackFromUsername = $('btnBackFromUsername');
  if (btnBackFromUsername) {
    btnBackFromUsername.addEventListener('click', () => {
      showStep('stepProviders');
      setStepTitle('Sign in to continue', 'Choose a way to continue to your studio.');
    });
  }

  console.log('‚úÖ All handlers initialized');
});
  </script>

      <!-- PWA Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker
            .register('/service-worker.js')
            .then((registration) => {
              console.log('‚úÖ ServiceWorker registered:', registration.scope);
            })
            .catch((error) => {
              console.error('‚ùå ServiceWorker registration failed:', error);
            });
        });
      }
    </script>

    <!-- PWA Install Prompt Logic -->
    <script>
      let deferredPrompt;
      const installBtn = document.getElementById('pwaInstallBtn');

      // Listen for beforeinstallprompt event
      window.addEventListener('beforeinstallprompt', (e) => {
        console.log('üí° PWA Install prompt available');
        // Prevent the mini-infobar from appearing on mobile
        e.preventDefault();
        // Save the event for later use
        deferredPrompt = e;
        // Show install button
        if (installBtn) {
          installBtn.classList.remove('hidden');
          console.log('‚úÖ Install button visible');
        }
      });

      // Handle install button click
      if (installBtn) {
        installBtn.addEventListener('click', async () => {
          console.log('üîò Install button clicked');
          
          if (!deferredPrompt) {
            console.log('‚ö†Ô∏è Install prompt not available');
            alert('App is already installed or browser does not support PWA installation.');
            return;
          }
          
          // Show the install prompt
          deferredPrompt.prompt();
          
          // Wait for user response
          const { outcome } = await deferredPrompt.userChoice;
          console.log(`üë§ User response: ${outcome}`);
          
          if (outcome === 'accepted') {
            console.log('‚úÖ PWA installed successfully');
            // Show success message
            showToast('‚úÖ IMRAN SQUARE installed successfully!');
          } else {
            console.log('‚ùå User cancelled installation');
            showToast('Installation cancelled');
          }
          
          // Clear the saved prompt
          deferredPrompt = null;
          installBtn.classList.add('hidden');
        });
      }

      // Track PWA installation
      window.addEventListener('appinstalled', () => {
        console.log('üéâ PWA installed on device');
        if (installBtn) {
          installBtn.classList.add('hidden');
        }
        showToast('üéâ App installed! Open from home screen.');
      });

      // Detect if app is running in standalone mode (already installed)
      if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('üì± Running in standalone mode');
        if (installBtn) {
          installBtn.classList.add('hidden');
        }
      }

      // iOS detection and standalone check
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator.standalone);
      
      if (isIOS && !isInStandaloneMode) {
        console.log('üì± iOS detected - showing install button for manual instructions');
        // On iOS, show button that opens instructions modal
        if (installBtn) {
          installBtn.classList.remove('hidden');
          installBtn.innerHTML = `
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            Install on iOS
          `;
          // Override click to show iOS instructions
          installBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const modal = document.getElementById('iosInstallModal');
            if (modal) modal.classList.remove('hidden');
          }, { once: false });
        }
      }

      // Helper function for toast notifications
      function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full bg-white text-black text-sm font-medium shadow-2xl z-50 animate-bounce';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transition = 'opacity 0.3s';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
    </script>

<!-- iOS Install Instructions Modal -->
<div id="iosInstallModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-4">
  <div class="bg-gradient-to-b from-gray-900 to-black rounded-3xl max-w-md w-full p-8 border border-orange-500/30 shadow-2xl relative">
    
    <!-- Decorative glow -->
    <div class="absolute -inset-1 bg-gradient-to-r from-orange-500/20 to-orange-600/20 rounded-3xl blur-xl"></div>
    
    <!-- Content -->
    <div class="relative">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <div>
          <h3 class="text-xl font-bold text-white">Install on iPhone</h3>
          <p class="text-xs text-gray-400 mt-1">Add to your home screen</p>
        </div>
        <button id="closeIosModal" class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-gray-300 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <!-- Instructions -->
      <div class="space-y-4 text-gray-300 text-sm">
        
        <!-- Step 1 -->
        <div class="flex items-start gap-4 bg-white/5 p-4 rounded-xl border border-white/10">
          <div class="flex-shrink-0 w-8 h-8 rounded-full bg-orange-500 text-white font-bold flex items-center justify-center">1</div>
          <div class="flex-1">
            <p class="text-white font-semibold mb-2">Tap the Share button</p>
            <p class="text-xs text-gray-400">Look for the <strong>share icon</strong> at the bottom of Safari</p>
            <div class="mt-3 flex items-center justify-center bg-blue-500/10 p-3 rounded-lg">
              <svg class="w-8 h-8 text-blue-400" fill="currentColor" viewBox="0 0 24 24">
                <path d="M16 5l-1.42 1.42-1.59-1.59V16h-1.98V4.83L9.42 6.42 8 5l4-4 4 4zm4 5v11c0 1.1-.9 2-2 2H6c-1.11 0-2-.9-2-2V10c0-1.11.89-2 2-2h3v2H6v11h12V10h-3V8h3c1.1 0 2 .89 2 2z"/>
              </svg>
            </div>
          </div>
        </div>
        
        <!-- Step 2 -->
        <div class="flex items-start gap-4 bg-white/5 p-4 rounded-xl border border-white/10">
          <div class="flex-shrink-0 w-8 h-8 rounded-full bg-orange-500 text-white font-bold flex items-center justify-center">2</div>
          <div class="flex-1">
            <p class="text-white font-semibold mb-2">Select "Add to Home Screen"</p>
            <p class="text-xs text-gray-400">Scroll down in the share menu and tap this option</p>
          </div>
        </div>
        
        <!-- Step 3 -->
        <div class="flex items-start gap-4 bg-white/5 p-4 rounded-xl border border-white/10">
          <div class="flex-shrink-0 w-8 h-8 rounded-full bg-orange-500 text-white font-bold flex items-center justify-center">3</div>
          <div class="flex-1">
            <p class="text-white font-semibold mb-2">Tap "Add"</p>
            <p class="text-xs text-gray-400">Confirm by tapping <strong>Add</strong> in the top right corner</p>
          </div>
        </div>
        
      </div>
      
      <!-- Close Button -->
      <button id="iosModalGotIt" class="w-full mt-6 py-3 bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl text-white font-semibold hover:shadow-lg hover:scale-105 transition-all">
        Got it!
      </button>
    </div>
  </div>
</div>

<script>
  // iOS Install Modal Logic
  const iosModal = document.getElementById('iosInstallModal');
  const closeIosModal = document.getElementById('closeIosModal');
  const iosModalGotIt = document.getElementById('iosModalGotIt');
  
  // Close modal handlers
  if (closeIosModal) {
    closeIosModal.addEventListener('click', () => {
      if (iosModal) iosModal.classList.add('hidden');
    });
  }
  
  if (iosModalGotIt) {
    iosModalGotIt.addEventListener('click', () => {
      if (iosModal) iosModal.classList.add('hidden');
    });
  }
  
  // Close on outside click
  if (iosModal) {
    iosModal.addEventListener('click', (e) => {
      if (e.target === iosModal) {
        iosModal.classList.add('hidden');
      }
    });
  }
</script>

</body>
</html>
