<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Account – IMRAN SQUARE</title>

      <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#ff6b35">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="IMRAN SQUARE">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons for iOS -->
    <link rel="apple-touch-icon" href="/resources/icon-152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/resources/icon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/resources/icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/resources/icon-192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/resources/icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/resources/icon-16.png">
    <link rel="shortcut icon" href="/resources/favicon.ico">


  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { background:#050505; color:white; font-family:'Inter',sans-serif; }
    .glass { background:rgba(8,8,8,0.95); border:1px solid rgba(255,255,255,0.08); border-radius:18px; }
    .pill-tab-active { background:#f97316; color:#111827; }
    .pill-tab-inactive { background:transparent; color:#9ca3af; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Top bar -->
  <header class="w-full border-b border-white/10 px-6 py-3 flex items-center justify-between bg-black/60 backdrop-blur">
    <div class="flex items-center gap-2">
      <span class="text-xs tracking-[0.25em] uppercase text-orange-400">Imran Square</span>
      <span class="text-xs text-gray-500">• Account center</span>
    </div>
    <div class="flex items-center gap-3">
      <button id="backToDashboard" class="px-3 py-1.5 text-xs rounded-full border border-white/15 text-gray-200 hover:bg-white/10">
        ← Back to dashboard
      </button>
      <div id="topMiniAvatar" class="w-8 h-8 rounded-full border border-orange-400/60 bg-black/80 flex items-center justify-center text-xs text-orange-200 overflow-hidden">
        <span id="topMiniAvatarFallback">U</span>
        <img id="topMiniAvatarImg" src="" class="hidden w-full h-full object-cover" />
      </div>
    </div>
  </header>

  <!-- Main layout -->
  <main class="flex-1 flex px-6 py-4 gap-4">
    <!-- Sidebar -->
    <aside class="w-64 glass p-4 flex flex-col gap-4">
      <div>
        <p class="text-xs font-semibold text-gray-400 uppercase tracking-[0.2em] mb-2">Account</p>
        <div class="space-y-1 text-sm">
          <button data-tab="account" class="tab-btn w-full flex items-center justify-between px-3 py-2 rounded-lg bg-white/5 text-gray-100">
            <span>Account</span>
          </button>
          <button data-tab="preferences" class="tab-btn w-full flex items-center justify-between px-3 py-2 rounded-lg text-gray-400 hover:bg-white/5">
            <span>Preferences</span>
          </button>
        </div>
      </div>
    </aside>

    <!-- Content -->
    <section class="flex-1 glass p-5 overflow-y-auto">


      <!-- ACCOUNT TAB -->
<div id="tab-account" class="space-y-6">
  <div>
    <p class="text-xs uppercase tracking-[0.25em] text-orange-400 mb-1">Account</p>
    <h1 class="text-xl font-semibold text-white">Account</h1>
  </div>
<!-- Account page actions -->
<div class="flex justify-end gap-2 pt-4 border-t border-white/10 mt-4">
  <button id="btnAccountCancel" class="px-4 py-2 rounded-full border border-white/20 text-xs text-gray-200 hover:bg-white/10">
    Cancel
  </button>
  <button id="btnAccountSave" class="px-4 py-2 rounded-full bg-orange-500 text-xs text-black font-medium hover:bg-orange-400">
    Save changes
  </button>
</div>

  <!-- Top row: avatar + basic info -->
  <div class="flex gap-8">
    <!-- Avatar column -->
    <div class="flex flex-col items-center gap-3">
      <div class="w-16 h-16 rounded-full overflow-hidden border border-orange-400/70 bg-black/70 flex items-center justify-center">
        <img id="accAvatarImg" src="" class="w-full h-full object-cover hidden" />
        <span id="accAvatarFallback" class="text-lg font-semibold text-orange-300">U</span>
      </div>
      <button id="accChangeAvatar" class="text-[11px] px-3 py-1.5 rounded-full border border-white/20 text-gray-100 hover:bg-white/10">
        Change avatar
      </button>
      <input id="accAvatarInput" type="file" accept="image/*" class="hidden" />
    </div>

    <!-- Fields column -->
    <div class="flex-1 space-y-4 text-xs">
      <!-- Full name -->
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-400 mb-1">Full name</p>
          <p id="accFullName" class="text-gray-100">—</p>
        </div>
        <button id="btnChangeFullName" class="px-3 py-1.5 rounded-full border border-white/15 text-[11px] text-gray-100 hover:bg-white/10">
          Change full name
        </button>
      </div>

      <!-- Username -->
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-400 mb-1">Username</p>
          <p id="accUsername" class="text-gray-100">—</p>
        </div>
        <button id="btnChangeUsername" class="px-3 py-1.5 rounded-full border border-white/15 text-[11px] text-gray-100 hover:bg-white/10">
          Change username
        </button>
      </div>

      <!-- Email -->
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-400 mb-1">Email</p>
          <p id="accEmail" class="text-gray-100">—</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Your Subscription -->
  <section class="space-y-3 text-xs">
    <p class="text-gray-400 font-semibold">Your subscription</p>

    <div class="bg-white/5 border border-white/10 rounded-2xl p-4 flex items-center justify-between">
      <div>
        <p class="text-gray-300 mb-1">Thanks for using IMRAN SQUARE Studio!</p>
        <p class="text-[11px] text-gray-500">Explore future pro features and workflow boosts.</p>
      </div>
      <div class="flex gap-2">
        <button id="btnViewPlan" class="px-3 py-1.5 rounded-full border border-white/15 text-[11px] text-gray-100 hover:bg-white/10">
          View details
        </button>
        <button id="btnUpgradePlan" class="px-3 py-1.5 rounded-full bg-orange-500 text-[11px] text-black hover:bg-orange-400">
          Upgrade plan
        </button>
      </div>
    </div>

    <div class="bg-white/5 border border-white/10 rounded-2xl p-4 flex items-center justify-between">
      <div>
        <p class="text-gray-300 mb-1">Community & support</p>
        <p class="text-[11px] text-gray-500">Join our Discord server for updates and tips.</p>
      </div>
      <button id="btnGoDiscord" class="px-3 py-1.5 rounded-full border border-white/15 text-[11px] text-gray-100 hover:bg-white/10">
        Go to Discord
      </button>
    </div>
  </section>

  <!-- System -->
  <section class="space-y-3 text-xs">
    <p class="text-gray-400 font-semibold">System</p>

    <div class="bg-white/5 border border-white/10 rounded-2xl p-4 space-y-3">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-300 mb-0.5">Support</p>
          <p class="text-[11px] text-gray-500">Need help with IMRAN SQUARE Studio?</p>
        </div>
        <button id="btnContactSupport" class="px-3 py-1.5 rounded-full border border-white/15 text-[11px] text-gray-100 hover:bg-white/10">
          Contact
        </button>
      </div>

      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-300 mb-0.5">You are signed in as</p>
          <p id="accSignedInAs" class="text-[11px] text-gray-500">—</p>
        </div>
        <button id="btnSignOutSingle" class="px-3 py-1.5 rounded-full border border-white/15 text-[11px] text-gray-100 hover:bg-white/10">
          Sign out
        </button>
      </div>

      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-300 mb-0.5">Sign out of all sessions</p>
          <p class="text-[11px] text-gray-500">Devices or browsers where you are signed in.</p>
        </div>
        <button id="btnSignOutAll" class="px-3 py-1.5 rounded-full border border-white/15 text-[11px] text-gray-100 hover:bg-white/10">
          Sign out of all sessions
        </button>
      </div>

      <div class="flex items-center justify-between border-t border-white/10 pt-3 mt-2">
        <div>
          <p class="text-gray-300 mb-0.5">Delete account</p>
          <p class="text-[11px] text-gray-500">Permanently delete your account and data.</p>
        </div>
        <button id="btnDeleteAccount" class="px-3 py-1.5 rounded-full border border-red-500/60 text-[11px] text-red-300 hover:bg-red-500/10">
          Learn more
        </button>
      </div>
    </div>
  </section>
</div>


<!-- PREFERENCES TAB -->
<div id="tab-preferences" class="space-y-6 hidden">
  <div>
    <p class="text-xs uppercase tracking-[0.25em] text-orange-400 mb-1">Preferences</p>
    <h1 class="text-xl font-semibold text-white">Preferences</h1>
  </div>

  <button id="prefSignOut"
        class="px-3 py-1.5 rounded-full border border-white/15 text-[11px] text-gray-100 hover:bg-white/10">
  Sign out
</button>

  <!-- Appearance -->
  <section class="space-y-3 text-xs">
    <div class="bg-white/5 border border-white/10 rounded-2xl p-4 space-y-3">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-200 font-semibold mb-0.5">Appearance</p>
          <p class="text-[11px] text-gray-400">How IMRAN SQUARE looks on your device</p>
        </div>
        <select id="prefAppearance" class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/15 text-[11px] text-gray-200">
          <option value="dark">System (Dark)</option>
          <option value="light">Light</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Language -->
  <section class="space-y-3 text-xs">
    <div class="bg-white/5 border border-white/10 rounded-2xl p-4 space-y-3">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-200 font-semibold mb-0.5">Language</p>
          <p class="text-[11px] text-gray-400">The language used in the user interface</p>
        </div>
        <select id="prefLanguage" class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/15 text-[11px] text-gray-200">
          <option value="default">Default</option>
          <option value="en">English</option>
          <option value="hi">Hindi</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Preferred response language -->
  <section class="space-y-3 text-xs">
    <div class="bg-white/5 border border-white/10 rounded-2xl p-4 space-y-3">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-200 font-semibold mb-0.5">Preferred response language</p>
          <p class="text-[11px] text-gray-400">The language used for AI responses</p>
        </div>
        <select id="prefResponseLang" class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/15 text-[11px] text-gray-200">
          <option value="auto">Automatic (detect input)</option>
          <option value="en">English</option>
          <option value="hi">Hindi</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Autosuggest -->
  <section class="space-y-3 text-xs">
    <div class="bg-white/5 border border-white/10 rounded-2xl p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-200 font-semibold mb-0.5">Autosuggest</p>
          <p class="text-[11px] text-gray-400">Enable dropdown and tab-complete suggestions while typing a query</p>
        </div>
        <label class="relative inline-block w-10 h-5">
          <input type="checkbox" id="prefAutosuggest" checked class="sr-only peer">
          <span class="absolute cursor-pointer inset-0 bg-white/20 rounded-full peer-checked:bg-cyan-500 transition"></span>
          <span class="absolute left-1 top-1 bg-white w-3 h-3 rounded-full transition peer-checked:translate-x-5"></span>
        </label>
      </div>
    </div>
  </section>

  <!-- Homepage widgets -->
  <section class="space-y-3 text-xs">
    <div class="bg-white/5 border border-white/10 rounded-2xl p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-200 font-semibold mb-0.5">Homepage widgets</p>
          <p class="text-[11px] text-gray-400">Enable personalized widgets on the homepage</p>
        </div>
        <label class="relative inline-block w-10 h-5">
          <input type="checkbox" id="prefHomepageWidgets" checked class="sr-only peer">
          <span class="absolute cursor-pointer inset-0 bg-white/20 rounded-full peer-checked:bg-cyan-500 transition"></span>
          <span class="absolute left-1 top-1 bg-white w-3 h-3 rounded-full transition peer-checked:translate-x-5"></span>
        </label>
      </div>
    </div>
  </section>

  <!-- Artificial Intelligence -->
  <section class="space-y-3 text-xs">
    <p class="text-gray-400 font-semibold">Artificial Intelligence</p>

    <div class="bg-white/5 border border-white/10 rounded-2xl p-4 space-y-3">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-200 font-semibold mb-0.5">Model</p>
        </div>
        <button id="prefAIModel" class="px-3 py-1.5 rounded-full border border-white/15 text-[11px] text-gray-100 hover:bg-white/10">
          → Choose here
        </button>
      </div>

      <div class="flex items-center justify-between border-t border-white/10 pt-3">
        <div>
          <p class="text-gray-200 font-semibold mb-0.5">Image generation model</p>
        </div>
        <select id="prefImageModel" class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/15 text-[11px] text-gray-200">
          <option value="default">Default</option>
          <option value="advanced">Advanced</option>
        </select>
      </div>

      <div class="flex items-center justify-between border-t border-white/10 pt-3">
        <div>
          <p class="text-gray-200 font-semibold mb-0.5">Video generation model</p>
        </div>
        <button id="prefVideoModel" class="px-3 py-1.5 rounded-full border border-orange-500/60 text-[11px] text-orange-300 hover:bg-orange-500/10">
          Upgrade to Max
        </button>
      </div>

      <div class="flex items-center justify-between border-t border-white/10 pt-3">
        <div>
          <p class="text-gray-200 font-semibold mb-0.5">AI data retention</p>
          <p class="text-[11px] text-gray-400">AI Data Retention allows IMRAN SQUARE to use your searches to improve AI models. Turn this setting off if you wish to exclude your data from this process.</p>
        </div>
        <label class="relative inline-block w-10 h-5">
          <input type="checkbox" id="prefAIRetention" checked class="sr-only peer">
          <span class="absolute cursor-pointer inset-0 bg-white/20 rounded-full peer-checked:bg-cyan-500 transition"></span>
          <span class="absolute left-1 top-1 bg-white w-3 h-3 rounded-full transition peer-checked:translate-x-5"></span>
        </label>
      </div>
    </div>
  </section>

  <!-- Sidebar -->
  <section class="space-y-3 text-xs">
    <p class="text-gray-400 font-semibold">Sidebar</p>

    <div class="bg-white/5 border border-white/10 rounded-2xl p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-200 font-semibold mb-0.5">Customize sidebar items</p>
        </div>
        <button id="prefSidebarCustomize" class="px-3 py-1.5 rounded-full border border-white/15 text-[11px] text-gray-100 hover:bg-white/10">
          Customize
        </button>
      </div>
    </div>
  </section>

  <!-- Preferences page actions -->
  <div class="flex justify-end gap-2 pt-4 border-t border-white/10 mt-4">
    <button id="btnPreferencesCancel" class="px-4 py-2 rounded-full border border-white/20 text-xs text-gray-200 hover:bg-white/10">
      Cancel
    </button>
    <button id="btnPreferencesSave" class="px-4 py-2 rounded-full bg-orange-500 text-xs text-black font-medium hover:bg-orange-400">
      Save changes
    </button>
  </div>
</div>

    </section>
  </main>

 <script>
  // ---- Load current user from localStorage ----
  const RAW_USER = localStorage.getItem('imranUser');
  const CURRENT_USER = RAW_USER ? JSON.parse(RAW_USER) : null;
  let WORKING_USER = RAW_USER ? JSON.parse(RAW_USER) : null;
  let NEW_AVATAR_FILE = null; // naya avatar file

  const ADMIN_EMAILS = ['imransquareofficial@gmail.com'];
  const IS_ADMIN = CURRENT_USER && ADMIN_EMAILS.includes(CURRENT_USER.email);

const API_BASE = window.location.hostname === 'localhost' 
  ? 'http://localhost:3000' 
  : 'https://imran-square-studio.onrender.com';


  // ---- Name helper ----
  function getImranFullName(user) {
    if (!user) return 'Guest';
    const first = (user.firstName || '').trim();
    const last = (user.lastName || '').trim();
    const full = (first + ' ' + last).trim();
    return full || (user.name || 'Guest');
  }

  if (!CURRENT_USER) {
    window.location.href = 'landing.html';
  }

  // Back to dashboard
  const backBtn = document.getElementById('backToDashboard');
  if (backBtn) {
    backBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });
  }

  // ---- Fill user info (name, username, email, avatar) ----
  function fillUser() {
    const u = WORKING_USER;
    if (!u) return;

    const name = getImranFullName(u);
    const email = u.email || 'No email';
    const username = (u.username || (u.email && u.email.split('@')[0]) || 'user').toLowerCase();

    const fullNameEl = document.getElementById('accFullName');
    const usernameEl = document.getElementById('accUsername');
    const emailEl = document.getElementById('accEmail');
    const signedEl = document.getElementById('accSignedInAs');
    const aImg = document.getElementById('accAvatarImg');
    const aFallback = document.getElementById('accAvatarFallback');
    const miniImg = document.getElementById('topMiniAvatarImg');
    const miniFallback = document.getElementById('topMiniAvatarFallback');

    if (fullNameEl) fullNameEl.textContent = name;
    if (usernameEl) usernameEl.textContent = username;
    if (emailEl) emailEl.textContent = email;
    if (signedEl) signedEl.textContent = username;

    if (u.photo && aImg && miniImg) {
      aImg.src = u.photo;
      aImg.classList.remove('hidden');
      if (aFallback) aFallback.classList.add('hidden');

      miniImg.src = u.photo;
      miniImg.classList.remove('hidden');
      if (miniFallback) miniFallback.classList.add('hidden');
    } else {
      const initials =
        (name
          .split(' ')
          .map((p) => p[0])
          .join('')
          .toUpperCase()
          .slice(0, 2)) || 'U';

      if (aFallback) aFallback.textContent = initials;
      if (miniFallback) miniFallback.textContent = initials;
    }
  }

  fillUser();

  // ---- Avatar input: preview + NEW_AVATAR_FILE ----
const avatarInput = document.getElementById('accAvatarInput');
const avatarImg = document.getElementById('accAvatarImg');
const avatarBtn = document.getElementById('accChangeAvatar');

if (avatarBtn && avatarInput) {
  avatarBtn.addEventListener('click', () => avatarInput.click());
}

if (avatarInput && avatarImg) {
  avatarInput.addEventListener('change', () => {
    const file = avatarInput.files[0];
    if (!file) return;

    NEW_AVATAR_FILE = file; // save for upload on Save changes

    const reader = new FileReader();
    reader.onload = (e) => {
      avatarImg.src = e.target.result;
      avatarImg.classList.remove('hidden');
      const fallback = document.getElementById('accAvatarFallback');
      if (fallback) fallback.classList.add('hidden');
    };
    reader.readAsDataURL(file);
  });
}


  // ---- Name / username inline edit ----
  document.getElementById('btnChangeFullName').addEventListener('click', () => {
    const label = document.getElementById('accFullName');
    if (!label) return;

    const current = label.textContent === '—' ? '' : label.textContent;
    const input = document.createElement('input');
    input.type = 'text';
    input.value = current;
    input.className =
      'px-2 py-1 rounded-md bg-black/40 border border-white/20 text-sm text-gray-100 focus:outline-none focus:border-orange-400';

    label.replaceWith(input);
    input.focus();

    input.addEventListener('blur', () => {
      const newVal = input.value.trim();
      WORKING_USER.firstName = newVal.split(' ')[0] || '';
      WORKING_USER.lastName = newVal.split(' ').slice(1).join(' ') || '';

      const newLabel = document.createElement('p');
      newLabel.id = 'accFullName';
      newLabel.className = 'text-gray-100';
      newLabel.textContent = newVal || '—';
      input.replaceWith(newLabel);
    });
  });

  document.getElementById('btnChangeUsername').addEventListener('click', () => {
    const label = document.getElementById('accUsername');
    if (!label) return;

    const current = label.textContent === '—' ? '' : label.textContent;
    const input = document.createElement('input');
    input.type = 'text';
    input.value = current;
    input.className =
      'px-2 py-1 rounded-md bg-black/40 border border-white/20 text-sm text-gray-100 focus:outline-none focus:border-orange-400';

    label.replaceWith(input);
    input.focus();

    input.addEventListener('blur', () => {
      const newVal = input.value.trim();
      if (newVal) WORKING_USER.username = newVal;

      const newLabel = document.createElement('p');
      newLabel.id = 'accUsername';
      newLabel.className = 'text-gray-100';
      newLabel.textContent = newVal || '—';
      input.replaceWith(newLabel);
    });
  });







    // Tabs switch
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabAccount = document.getElementById('tab-account');
    const tabPrefs = document.getElementById('tab-preferences');

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        tabBtns.forEach(b => b.classList.remove('bg-white/5','text-gray-100'));
        btn.classList.add('bg-white/5','text-gray-100');

        if (tab === 'account') {
          tabAccount.classList.remove('hidden');
          tabPrefs.classList.add('hidden');
        } else {
          tabPrefs.classList.remove('hidden');
          tabAccount.classList.add('hidden');
        }
      });
    });

 

   
    

document.getElementById('btnViewPlan').addEventListener('click', () => {
  alert('Plan details panel yahan aayega (future).');
});
document.getElementById('btnUpgradePlan').addEventListener('click', () => {
  alert('Upgrade flow yahan implement hoga (future).');
});
document.getElementById('btnGoDiscord').addEventListener('click', () => {
  window.open('https://discord.com', '_blank');
});

document.getElementById('btnContactSupport').addEventListener('click', () => {
  alert('Support contact flow yahan aayega (email / chat).');
});

document.getElementById('btnSignOutSingle').addEventListener('click', () => doSignOut());
document.getElementById('btnSignOutAll').addEventListener('click', () => doSignOut());

document.getElementById('btnDeleteAccount').addEventListener('click', () => {
  const ok = confirm('Are you sure you want to delete this account data on this device?');
  if (!ok) return;
  localStorage.removeItem('imranUser');
  alert('Local account data cleared.');
  window.location.href = 'landing.html';
});
// Sign out

function doSignOut() {
  localStorage.removeItem('imranUser');
  window.location.href = 'landing.html';
}

// Account tab buttons
document.getElementById('btnSignOutSingle').addEventListener('click', doSignOut);
document.getElementById('btnSignOutAll').addEventListener('click', doSignOut);

// Preferences tab button
const prefSignOutBtn = document.getElementById('prefSignOut');
if (prefSignOutBtn) {
  prefSignOutBtn.addEventListener('click', doSignOut);
}


// Account page Save / Cancel
const btnAccountSave = document.getElementById('btnAccountSave');
const btnAccountCancel = document.getElementById('btnAccountCancel');

if (btnAccountSave && btnAccountCancel) {
  btnAccountSave.addEventListener('click', async () => {
    if (!WORKING_USER || !WORKING_USER.userId) {
      alert('User ID missing. Please sign in again.');
      return;
    }

    btnAccountSave.disabled = true;
    btnAccountSave.textContent = 'Saving...';

      try {
      let updatedUser = null;

      // 1) Naya avatar hua to Drive pe upload
      if (NEW_AVATAR_FILE) {
        const formData = new FormData();
        formData.append('avatar', NEW_AVATAR_FILE);
        formData.append('userId', WORKING_USER.userId);

        const resAvatar = await fetch(`${API_BASE}/api/account/upload-avatar`, {
          method: 'POST',
          body: formData
        });


        const dataAvatar = await resAvatar.json();
        console.log('UPLOAD AVATAR RESPONSE:', dataAvatar);

        if (!dataAvatar.success || !dataAvatar.user) {
          alert(dataAvatar.message || 'Failed to upload avatar.');
          btnAccountSave.disabled = false;
          btnAccountSave.textContent = 'Save changes';
          return;
        }

        updatedUser = dataAvatar.user;
        NEW_AVATAR_FILE = null;
      }

      // 2) Name / username update-profile se sync
      const res = await fetch(`${API_BASE}/api/account/update-profile`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId: WORKING_USER.userId,
          firstName: WORKING_USER.firstName || '',
          lastName: WORKING_USER.lastName || '',
          username: WORKING_USER.username || ''
        })
      });


      const data = await res.json();
      console.log('UPDATE PROFILE RESPONSE:', data);

      if (!data.success || !data.user) {
        alert(data.message || 'Failed to save account settings.');
        btnAccountSave.disabled = false;
        btnAccountSave.textContent = 'Save changes';
        return;
      }

      WORKING_USER = updatedUser || data.user;
      localStorage.setItem('imranUser', JSON.stringify(WORKING_USER));
      fillUser();

      alert('Account settings saved.');
    } catch (err) {
      console.error('❌ Account save error:', err);
      alert('Failed to save account settings. Please try again.');
    } finally {
      btnAccountSave.disabled = false;
      btnAccountSave.textContent = 'Save changes';
    }
  });

  btnAccountCancel.addEventListener('click', () => {
    const raw = localStorage.getItem('imranUser');
    if (raw) WORKING_USER = JSON.parse(raw);
    fillUser();
    alert('Changes discarded.');
  });
}


// Load preferences from storage
function loadPreferences() {
  const raw = localStorage.getItem('imranPreferences');
  if (!raw) return;
  const prefs = JSON.parse(raw);

  document.getElementById('prefAppearance').value = prefs.appearance || 'dark';
  document.getElementById('prefLanguage').value = prefs.language || 'default';
  document.getElementById('prefResponseLang').value = prefs.responseLang || 'auto';
  document.getElementById('prefAutosuggest').checked = prefs.autosuggest !== false;
  document.getElementById('prefHomepageWidgets').checked = prefs.homepageWidgets !== false;
  document.getElementById('prefAIRetention').checked = prefs.aiRetention !== false;
  document.getElementById('prefImageModel').value = prefs.imageModel || 'default';
}
loadPreferences();

// Placeholder button actions
const aiModelBtn = document.getElementById('prefAIModel');
if (aiModelBtn) {
  aiModelBtn.addEventListener('click', () => {
    alert('AI Model chooser panel (future)');
  });
}

const videoModelBtn = document.getElementById('prefVideoModel');
if (videoModelBtn) {
  videoModelBtn.addEventListener('click', () => {
    alert('Upgrade to Max for video generation');
  });
}

const sidebarBtn = document.getElementById('prefSidebarCustomize');
if (sidebarBtn) {
  sidebarBtn.addEventListener('click', () => {
    alert('Sidebar customization panel (future)');
  });
}


  </script>

    <!-- PWA Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker
            .register('/service-worker.js')
            .then((registration) => {
              console.log('✅ ServiceWorker registered:', registration.scope);
            })
            .catch((error) => {
              console.error('❌ ServiceWorker registration failed:', error);
            });
        });
      }
    </script>


</body>
</html>
