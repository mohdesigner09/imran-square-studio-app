<!DOCTYPE html>
<html lang="en">
<head>
  
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script Workspace - Imran Square</title>

    <!-- PWA Meta Tags (Aapki purani file se) -->
    <meta name="theme-color" content="#030303">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" href="/resources/icon-152.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/resources/icon-32.png">
    <link rel="shortcut icon" href="/resources/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Courier+Prime:wght@400;700&family=Playfair+Display:wght@700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <!-- External Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="main.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'], 
                        display: ['Playfair Display', 'serif'],
                        script: ['"Courier Prime"', 'Courier', 'monospace'],
                        mono: ['"JetBrains Mono"', 'monospace']
                    },
                    colors: { brand: { dark: '#030303' } }
                }
            }
        }
    </script>
    

    <style>
        /* =========================================
           üî• THEME: DARK CINEMATIC (Merged)
           ========================================= */
        :root { --text-primary: #ededed; }

        body { 
            background-color: #030303 !important;
            color: var(--text-primary); 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            height: 100vh;
        }

        /* Background Image with Blur */
        body::before {
            content: "";
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('resources/index bg .jpeg'); 
            background-size: cover; background-position: center; background-repeat: no-repeat;
            filter: blur(5px) brightness(0.6);
            transform: scale(1.05); opacity: 0.5;
            z-index: -50; pointer-events: none;
        }

        /* --- UI COMPONENTS --- */
        .glass-header {
            background: rgba(5, 5, 5, 0.85);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        /* Switcher */
        .mode-switch {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 9999px; padding: 4px; display: flex; gap: 4px;
        }
        .mode-btn {
            padding: 6px 16px; border-radius: 9999px; font-size: 11px; font-weight: 600; letter-spacing: 0.05em;
            text-transform: uppercase; transition: all 0.3s ease; color: #888;
        }
        .mode-btn.active { background: #ffffff; color: #000; box-shadow: 0 0 15px rgba(255,255,255,0.2); }

/* --- MODE 1: EDITOR STYLES (Updated) --- */
        .script-page {
            background: #ffffff; /* Paper is white */
            color: #000000;      /* Ink is black */
            width: 100%;
            max-width: 850px;    /* Standard A4 width approx */
            min-height: 1100px;
            margin: 40px auto;
            padding: 96px;       /* 1 inch margins */
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            font-family: 'Courier Prime', monospace;
            font-size: 18px;
            line-height: 1.2;
            outline: none;
        }
        
        .glass-panel {
            background: rgba(10, 10, 10, 0.7);
            backdrop-filter: blur(15px);
            border-right: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Active Item in Sidebar */
        .scene-item.active {
            background: rgba(255,255,255,0.1);
            border-left: 3px solid #fff;
            color: #fff;
        }
        
        /* Typography Glows */
        .glow-text { text-shadow: 0 0 10px rgba(255,255,255,0.3); }

        /* --- MODE 2: SECTION CARDS (Folders) --- */
        .section-card {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px; 
            padding: 1.5rem;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.8);
            position: relative; overflow: hidden;
            display: flex; flex-direction: column; height: 320px;
        }
        .section-card:hover {
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-5px);
            box-shadow: 0 20px 50px -10px rgba(0,0,0,1);
        }

        /* --- HOLOGRAPHIC RING --- */
        .capacity-wrapper { position: relative; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; }
        .capacity-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .capacity-circle-bg { fill: none; stroke: rgba(255, 255, 255, 0.1); stroke-width: 3; }
        .capacity-circle-fg { fill: none; stroke-width: 3; stroke-linecap: round; transition: stroke-dashoffset 0.6s ease; }
        
        /* Green Glow for Ring */
        .ring-green { stroke: #22c55e; filter: drop-shadow(0 0 8px rgba(34, 197, 94, 0.6)); }
        .ring-full { stroke: #ef4444; filter: drop-shadow(0 0 8px rgba(239, 68, 68, 0.6)); }
        
        .capacity-text { position: absolute; font-size: 10px; font-family: 'JetBrains Mono', monospace; font-weight: bold; color: white; }

        /* File List Inside Card */
        .file-list { flex: 1; overflow-y: auto; margin-top: 15px; margin-bottom: 15px; padding-right: 5px; }
        .file-item { 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05);
            padding: 8px 12px; border-radius: 8px; margin-bottom: 6px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 11px; color: #ccc; transition: all 0.2s;
        }
        .file-item:hover { background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.2); }

        /* Upload Button inside Card */
        .card-upload-btn {
            width: 100%; padding: 8px 0; text-align: center; border-radius: 8px;
            background: rgba(255,255,255,0.1); color: white; font-size: 11px; font-weight: 600;
            border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .card-upload-btn:hover { background: white; color: black; }
        .card-upload-btn:disabled { opacity: 0.5; cursor: not-allowed; background: rgba(255,255,255,0.05); color: #666; border: none; }

        /* --- UPLOAD QUEUE --- */
        #uploadQueue { position: fixed; bottom: 20px; right: 20px; width: 320px; z-index: 100; display: flex; flex-direction: column; gap: 8px; }
        .upload-item { 
            background: #0a0a0a; border: 1px solid rgba(255,255,255,0.15); 
            border-left: 3px solid #22c55e; padding: 14px; border-radius: 8px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.9); animation: slideIn 0.3s ease-out; 
            color: white; font-size: 12px; display: flex; align-items: center; gap: 10px;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }

        /* Helpers */
        .hidden-mode { display: none !important; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

        /* ===== MOBILE RESPONSIVE FIXES ===== */
@media (max-width: 768px) {
    /* Hide desktop sidebars on mobile */
    aside {
        display: none !important;
    }
    
    /* Full width main content */
    main {
        width: 100% !important;
    }
    
    /* Adjust editor for mobile */
    #scriptEditor {
        padding: 1rem !important;
        font-size: 14px !important;
        min-height: calc(100vh - 180px) !important;
    }
    
    /* Bottom nav safe area for iPhone notch */
    .safe-area-bottom {
        padding-bottom: env(safe-area-inset-bottom);
    }
    
    /* Mode switch on mobile bottom nav */
    #mobileWriterBtn.active {
        color: #ff6b35 !important;
    }
    
    #mobileFilesBtn.active {
        color: #ff6b35 !important;
    }
}

/* Tablet adjustments */
@media (min-width: 769px) and (max-width: 1024px) {
    /* Show only left sidebar on tablet */
    aside:last-of-type {
        display: none !important;
    }
}

    </style>
</head>
<body class="flex flex-col h-screen">

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<div id="mobileSidebar" class="flex flex-col bg-black h-full border-l border-white/10">
    
    <div class="px-5 pt-6 pb-4 bg-black z-10">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-white tracking-wide">MY PROJECTS</h2>
            <button onclick="createNewProject()" class="bg-white text-black rounded-full w-8 h-8 flex items-center justify-center hover:scale-110 transition">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <div class="relative">
            <i class="fa-solid fa-search absolute left-3 top-2.5 text-gray-500 text-xs"></i>
            <input type="text" id="projectSearch" oninput="renderProjects()" placeholder="Search scripts..." 
                class="w-full bg-white/10 border border-white/10 rounded-lg pl-8 pr-3 py-2 text-xs text-white focus:border-white/30 outline-none transition">
        </div>
    </div>

    <div id="projectList" class="flex-1 overflow-y-auto px-3 pb-20 space-y-1 custom-scrollbar">
        </div>

    <div class="p-4 border-t border-white/10 bg-black absolute bottom-0 w-full">
        <button onclick="window.location.href='index.html'" class="w-full py-2.5 rounded-lg bg-red-500/10 text-red-400 text-xs font-bold border border-red-500/20 hover:bg-red-500/20 transition flex items-center justify-center gap-2">
            <i class="fa-solid fa-arrow-left"></i> Exit to Dashboard
        </button>
    </div>
    
    <button onclick="toggleSidebar()" class="absolute top-4 right-[-40px] bg-black border border-white/10 text-white p-2 rounded-r-lg">
        <i class="fa-solid fa-xmark"></i>
    </button>
</div>

  <header class="h-14 md:h-16 glass-header flex items-center justify-between px-3 md:px-6 shrink-0 z-50">
    <div class="flex items-center gap-2 md:gap-4">
        <!-- Back Button -->
        <button onclick="goBackToHub()" class="p-2 rounded-lg hover:bg-white/10 text-gray-400 hover:text-white transition">
            <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
        </button>
        
        <div>
            <h1 class="text-xs md:text-sm font-bold text-white tracking-wide truncate max-w-[120px] md:max-w-none" id="scriptTitle">UNTITLED PROJECT</h1>
            <p class="text-[9px] md:text-[10px] text-gray-500 uppercase tracking-widest hidden sm:block">Script Workspace</p>
        </div>
    </div>

    <!-- Desktop Mode Switch (Hidden on Mobile) -->
    <div class="absolute left-1/2 transform -translate-x-1/2 hidden md:block">
        <div class="mode-switch">
            <button onclick="switchMode('editor')" id="btnEditor" class="mode-btn active">Writer</button>
            <button onclick="switchMode('files')" id="btnFiles" class="mode-btn">Files</button>
        </div>
    </div>

    <!-- Desktop Export Button (Hidden on Mobile) -->
    <div class="hidden md:flex items-center gap-3">
        <button id="editorActionBtn" class="px-4 py-2 bg-white text-black text-xs font-bold rounded-lg hover:bg-gray-200 transition">Export PDF</button>
    </div>
    
    <!-- üì± MOBILE MENU BUTTON (Three Lines) -->
<button id="hamburgerBtn" onclick="toggleSidebar()" class="md:hidden p-2 text-gray-400 hover:text-white">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
    </svg>
</button>
</header>

<!-- üì± MOBILE MENU OVERLAY -->
<div id="mobileMenuOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden md:hidden">
    <div id="mobileMenuPanel" class="absolute right-0 top-0 bottom-0 w-[280px] bg-gradient-to-br from-gray-900 via-black to-gray-900 border-l border-white/10 transform translate-x-full transition-transform duration-300 ease-out">
        <!-- Menu Header -->
        <div class="flex items-center justify-between p-4 border-b border-white/10">
            <h3 class="text-white font-bold text-lg">Menu</h3>
            <button id="closeMobileMenu" class="p-2 rounded-lg hover:bg-white/10 text-gray-400 hover:text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <!-- Menu Content -->
        <div class="p-4 space-y-3">
            <!-- Mode Toggle -->
            <div class="bg-white/5 rounded-lg p-3 border border-white/10">
                <p class="text-gray-400 text-xs mb-2 uppercase tracking-wider">View Mode</p>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="switchMode('editor'); closeMobileMenu();" id="mobileWriterBtn" class="py-2.5 px-3 bg-orange-500 text-white rounded-lg text-sm font-medium transition-all">
                        <svg class="w-4 h-4 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                        Writer
                    </button>
                    <button onclick="switchMode('files'); closeMobileMenu();" id="mobileFilesBtn" class="py-2.5 px-3 bg-white/10 text-gray-300 rounded-lg text-sm font-medium hover:bg-white/20 transition-all">
                        <svg class="w-4 h-4 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                        </svg>
                        Files
                    </button>
                </div>
            </div>
            
            <!-- Actions -->
            <button onclick="exportPDF(); closeMobileMenu();" class="w-full py-3 px-4 bg-white/5 hover:bg-white/10 text-white rounded-lg text-sm font-medium border border-white/10 transition-all flex items-center gap-3">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Export PDF
            </button>
            
            <button onclick="addNewScene(); closeMobileMenu();" class="w-full py-3 px-4 bg-white/5 hover:bg-white/10 text-white rounded-lg text-sm font-medium border border-white/10 transition-all flex items-center gap-3">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Add New Scene
            </button>
            
            <button onclick="goBackToHub(); closeMobileMenu();" class="w-full py-3 px-4 bg-white/5 hover:bg-white/10 text-white rounded-lg text-sm font-medium border border-white/10 transition-all flex items-center gap-3">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
                Back to Project Hub
            </button>
        </div>
    </div>
</div>


<!-- =========================================
         MODE 1: THE WRITER (Updated Layout)
         ========================================= -->
    <div id="modeEditor" class="flex flex-1 overflow-hidden relative w-full h-full">
        
        <!-- LEFT SIDEBAR: SCENES -->
      <aside class="w-64 glass-panel hidden md:flex flex-col z-40">
    <div class="p-4 border-b border-white/10">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider">SCENES</h2>
            <button onclick="addNewScene()" class="p-1.5 rounded-lg bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 transition-all group" title="Add New Scene">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </button>
        </div>
    </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- Scene Item Active -->
                <div class="scene-item active px-3 py-3 rounded cursor-pointer transition">
                    <div class="text-[10px] text-gray-500 font-mono mb-1">SCENE 1</div>
                    <div class="text-xs font-medium text-white truncate">INT. COFFEE SHOP - DAY</div>
                </div>
                <!-- Scene Item -->
                <div class="scene-item px-3 py-3 rounded cursor-pointer hover:bg-white/5 text-gray-400 hover:text-white transition">
                    <div class="text-[10px] text-gray-600 font-mono mb-1">SCENE 2</div>
                    <div class="text-xs font-medium truncate">EXT. STREET - CONTINUOUS</div>
                </div>
            </div>
        </aside>

        <!-- CENTER: EDITOR CANVAS -->
<main class="flex-1 overflow-y-auto relative bg-transparent flex flex-col items-center custom-scrollbar">
            
            <div class="editor-toolbar w-full sticky top-0 z-30">
                <button class="toolbar-btn font-bold" onclick="formatDoc('bold')">B</button>
                <button class="toolbar-btn italic" onclick="formatDoc('italic')">I</button>
                <button class="toolbar-btn underline" onclick="formatDoc('underline')">U</button>
                <div class="w-px h-5 bg-white/20 mx-1"></div>
                
                <select class="bg-black text-white border border-white/20 rounded px-2 py-1 text-xs" onchange="applyScriptFormat(this.value)">
                    <option value="">Format...</option>
                    <option value="scene">Scene Heading</option>
                    <option value="action">Action</option>
                    <option value="character">Character</option>
                    <option value="dialogue">Dialogue</option>
                </select>
            </div>
            <div id="editorContainer" class="flex flex-col items-center gap-6 py-8 overflow-auto custom-scrollbar w-full" style="height: calc(100vh - 120px);">
                <div class="script-page-wrapper" data-page="1">
                    <div contenteditable="true" class="script-page" id="scriptEditor" data-page-num="1">
INT. COFFEE SHOP - DAY

Rain lashes against the window. A lone figure, KABIR (30s, disheveled), sits nursing a cold espresso.

KABIR
(muttering)
It wasn't supposed to end like this.

He pulls out a crumpled photograph.
                    </div>
                    <div class="page-number">Page 1</div>
                </div>
            </div>


            <button id="mobileAIBtn" class="ai-fab md:hidden" onclick="toggleAISheet()">
                ‚ú®
            </button>

            <div id="mobileAISheet">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-green-400 font-bold uppercase">AI Copilot</h3>
                    <button onclick="toggleAISheet()" class="text-gray-400">‚úï</button>
                </div>
                <div class="bg-white/10 p-3 rounded mb-3 text-xs text-gray-300">
                    AI Suggestion: "Try making the dialogue shorter here."
                </div>
                <div class="flex gap-2">
                    <input type="text" placeholder="Ask AI..." class="flex-1 bg-black border border-white/20 rounded px-3 py-2 text-white">
                    <button class="bg-green-600 px-4 rounded text-white">Go</button>
                </div>
            </div>
            </main>

<style>
/* Google Docs Style Pages */
#editorContainer {
    background: #1a1a1a;
    padding: 2rem 1rem;
}

.script-page-wrapper {
    position: relative;
    width: 100%;
    max-width: 8.5in; /* Standard US Letter width */
    margin: 0 auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    animation: fadeIn 0.3s ease;
}

.script-page {
    width: 100%;
    min-height: 11in; /* US Letter height */
    max-height: 11in;
    background: white;
    color: black;
    padding: 1in; /* Standard 1-inch margins */
    font-family: 'Courier Prime', 'Courier New', monospace;
    font-size: 12pt;
    line-height: 1.5;
    overflow: hidden; /* Prevent overflow */
    box-sizing: border-box;
    outline: none;
}

.page-number {
    position: absolute;
    bottom: 0.5in;
    right: 1in;
    color: rgba(0,0,0,0.4);
    font-size: 10pt;
    font-family: 'Courier New', monospace;
    pointer-events: none;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .script-page-wrapper {
        max-width: 100%;
        box-shadow: none;
    }
    
    .script-page {
        min-height: auto;
        max-height: none;
        padding: 1rem;
        font-size: 11pt;
    }
    
    #editorContainer {
        padding: 1rem 0.5rem;
    }
}

/* Print Styles */
@media print {
    .script-page-wrapper {
        page-break-after: always;
        box-shadow: none;
        margin: 0;
    }
    
    .script-page {
        min-height: 11in;
        max-height: 11in;
    }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
/* ===== UPLOAD BUTTON STYLING ===== */
.card-upload-btn {
    width: 100%;
    padding: 10px;
    margin-top: 12px;
    background: linear-gradient(135deg, #ff6b35 0%, #f97d3c 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.card-upload-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #f97d3c 0%, #ff6b35 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
}

.card-upload-btn:disabled {
    background: #333;
    cursor: not-allowed;
    opacity: 0.5;
}

.card-upload-btn:active:not(:disabled) {
    transform: translateY(0);
}

/* --- NEW ADDITIONS (Paste at the end of <style>) --- */

/* 1. EDITOR TOOLBAR */
.editor-toolbar {
    background: #1a1a1a;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding: 8px 12px;
    display: flex; gap: 8px; align-items: center;
    overflow-x: auto; white-space: nowrap;
}
.toolbar-btn {
    background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
    color: #ccc; padding: 6px 10px; border-radius: 6px; font-size: 14px; cursor: pointer;
}
.toolbar-btn.active, .toolbar-btn:hover { background: #ff6b35; color: white; border-color: #ff6b35; }

/* --- 1. SIDEBAR FIX (Now opens from RIGHT) --- */
#mobileSidebar {
    position: fixed; 
    top: 0; 
    right: 0; /* Left hata diya, Right kar diya */
    bottom: 0; 
    width: 280px;
    background: #0a0a0a; 
    border-left: 1px solid rgba(255,255,255,0.1); /* Border ab left side */
    z-index: 9999; 
    
    /* Pehle -100% (Left) tha, ab 100% (Right) hai taaki right me chupe */
    transform: translateX(100%); 
    transition: transform 0.3s ease;
    padding-top: 60px;
}
#mobileSidebar.open { 
    transform: translateX(0); /* Wapis screen par layega */
}

.sidebar-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7); 
    z-index: 9998; /* Sidebar se ek level neeche */
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
}
.sidebar-overlay.open { opacity: 1; pointer-events: auto; }


/* --- 2. AI BUTTON THEME (Premium Black) --- */
.ai-fab {
    position: fixed; bottom: 80px; right: 20px; 
    width: 56px; height: 56px;
    border-radius: 50%; 
    
    /* üî• Dark Premium Theme */
    background: #000000; 
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white; 
    
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.15); /* White Glow */
    z-index: 60; font-size: 22px;
    cursor: pointer; transition: all 0.2s;
}
.ai-fab:active { transform: scale(0.95); background: #222; }


/* --- 3. AI SHEET FIX (Initially Hidden) --- */
/* Ye code zaroor add karna taaki sheet pehle se na dikhe */
#mobileAISheet {
    position: fixed; 
    bottom: 0; left: 0; right: 0;
    background: #1a1a1a; 
    border-top: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px 20px 0 0; 
    padding: 20px; 
    z-index: 10000; /* Sabse upar */
    
    /* üî• Yeh Line Important Hai: Isse sheet neeche chupi rahegi */
    transform: translateY(100%); 
    
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
#mobileAISheet.open { 
    transform: translateY(0); /* Class lagne par upar ayegi */
}


/* --- 4. TOOLBAR ACTIVE STATE --- */
.toolbar-btn.active {
    background: #ffffff; 
    color: #000000; 
    border-color: #ffffff;
    box-shadow: 0 0 10px rgba(255,255,255,0.3);
}

</style>


        </main>

        <!-- RIGHT SIDEBAR: AI TOOLS -->
        <aside class="w-72 glass-panel border-l border-white/10 hidden lg:flex flex-col z-40 bg-black/40">
            <div class="p-4 border-b border-white/5 flex justify-between items-center">
                <h3 class="text-xs font-bold text-white uppercase tracking-wider glow-text">AI Assistant</h3>
                <span class="w-2 h-2 bg-green-500 rounded-full shadow-[0_0_10px_#22c55e]"></span>
            </div>
            <div class="p-4 flex-1 overflow-y-auto">
                <div class="bg-white/5 border border-white/10 rounded-xl p-4 mb-4">
                    <p class="text-[10px] text-gray-400 mb-2 font-mono">SUGGESTION</p>
                    <p class="text-xs text-gray-200 leading-relaxed">Consider increasing the tension here. Maybe the coffee shop door opens and someone familiar walks in?</p>
                    <button class="mt-3 w-full py-1.5 bg-white/10 hover:bg-white/20 border border-white/10 rounded text-[10px] text-white transition">Apply Idea</button>
                </div>
            </div>
            <div class="p-4 border-t border-white/10">
                <input type="text" placeholder="Ask AI to rewrite..." class="w-full bg-black/50 border border-white/20 rounded-lg px-3 py-2 text-xs text-white focus:border-white/50 outline-none transition">
            </div>
        </aside>

    </div>

    <!-- =========================================
         MODE 2: THE FILES (6 Fixed Cards System)
         ========================================= -->
    <div id="modeFiles" class="hidden-mode flex-1 overflow-y-auto relative w-full h-full custom-scrollbar">
        <div class="p-8 max-w-7xl mx-auto">
            <div class="mb-8">
                <h2 class="text-2xl font-display font-bold text-white">Project Files</h2>
                <p class="text-xs text-gray-400 mt-1">6 Sections ‚Ä¢ 10 Files Limit Per Section</p>
            </div>

            <!-- THE 6 CARDS GRID -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="sectionsGrid">
                <!-- Cards will be injected by JS -->
            </div>
        </div>
    </div>

    <!-- Upload Queue -->
    <div id="uploadQueue"></div>

    <!-- Hidden Input -->
    <input type="file" id="fileInput" class="hidden" accept=".pdf,.doc,.docx,.txt">

    <!-- JS LOGIC -->
    <script>
        // --- 1. STATE MANAGEMENT ---
        let currentSectionId = null;
        const FILES_PER_SECTION = 10;
        
        // Initial Data Structure (Default 6 Sections)
        let sectionsData = [
            { id: 1, name: "Screenplays", files: [] },
            { id: 2, name: "Research", files: [] },
            { id: 3, name: "Character Notes", files: [] },
            { id: 4, name: "Locations", files: [] },
            { id: 5, name: "Legal Docs", files: [] },
            { id: 6, name: "Misc", files: [] }
        ];

        // --- 2. INIT & RENDER ---
    // --- 2. INIT & RENDER ---
// Wait for DOM and main.js to load
document.addEventListener('DOMContentLoaded', function() {
    // Check if main.js loaded
    if (typeof window.projects === 'undefined') {
        console.error('‚ùå main.js not loaded!');
        alert('Error: Please include main.js before scripts.html');
        return;
    }
    
    // Initialize page
    const params = new URLSearchParams(window.location.search);
    const projectId = params.get('id');
    
    if (projectId) {
        const project = window.projects.find(p => p.id === projectId);
        if (project) {
            const titleEl = document.getElementById('scriptTitle');
            if (titleEl) {
                titleEl.textContent = (project.title || 'UNTITLED').toUpperCase();
            }
            
            // Load sections
            if (project.sections && Array.isArray(project.sections)) {
                sectionsData = project.sections;
            }
        }
    }

    
    
    // Render
    renderSections();
    switchMode('files');
});


function renderSections() {
    // Load from main projects array
    const projectId = new URLSearchParams(window.location.search).get('id');
    const project = projects.find(p => p.id === projectId);
    
    if (project && project.sections) {
        sectionsData = project.sections;
    }
    
    const grid = document.getElementById('sectionsGrid');
    if (!grid) return;
    grid.innerHTML = '';

    sectionsData.forEach(section => {
        const count = section.files.length;
        const percent = (count / FILES_PER_SECTION) * 100;
        const isFull = count >= FILES_PER_SECTION;
        const ringColor = isFull ? 'ring-full' : 'ring-green';
        
        // SVG Dash array logic (circumference ~ 100)
        const dashArray = `${percent}, 100`;

        // Generate File List HTML
        let filesHtml = '';
        
        if(count === 0) {
            filesHtml = `<div class="h-full flex flex-col items-center justify-center text-gray-600">
                <svg class="w-8 h-8 mb-2 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <span class="text-[10px]">No files yet</span>
            </div>`;
        } else {
            // Reverse to show newest first
            const reversedFiles = [...section.files].reverse();
            reversedFiles.forEach(file => {
                filesHtml += `
                    <div class="file-item group">
                        <div class="flex items-center gap-2 truncate w-[70%]">
                            <svg class="w-3 h-3 text-gray-500 group-hover:text-green-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                            <span class="truncate" title="${file.name}">${file.name}</span>
                        </div>
                        <span class="text-[9px] text-gray-600 shrink-0">${file.date || 'Just now'}</span>
                    </div>
                `;
            });
        }

        // Card HTML
        const card = document.createElement('div');
        card.className = 'section-card';
        card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h3 class="text-sm font-bold text-white uppercase tracking-wider">${section.name}</h3>
                    <p class="text-[10px] text-gray-500">${count} Files</p>
                </div>
                <!-- Holographic Ring -->
                <div class="capacity-wrapper">
                    <svg class="capacity-svg" viewBox="0 0 36 36">
                        <path class="capacity-circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <path class="capacity-circle-fg ${ringColor}" stroke-dasharray="${dashArray}" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    </svg>
                    <div class="capacity-text">${count}/${FILES_PER_SECTION}</div>
                </div>
            </div>
            
            <div class="file-list custom-scrollbar">
                ${filesHtml}
            </div>

            <button onclick="triggerUpload(${section.id})" class="card-upload-btn" ${isFull ? 'disabled' : ''}>
                ${isFull ? '<span class="text-red-400">‚ö†Ô∏è Section Full</span>' : '<span>+ Upload File</span>'}
            </button>
        `;
        grid.appendChild(card);
    });
}

// ===== AUTO-PAGE SYSTEM (Google Docs Style) =====
let pageCount = 1;
const MAX_PAGE_HEIGHT = 11 * 96; // 11 inches in pixels (96 DPI)

function initAutoPages() {
    const editor = document.getElementById('scriptEditor');
    if (!editor) return;
    
    
    // Monitor text input
    editor.addEventListener('input', debounce(checkPageOverflow, 300));
    editor.addEventListener('paste', () => setTimeout(checkPageOverflow, 100));
}

function checkPageOverflow() {
    const container = document.getElementById('editorContainer');
    const pages = container.querySelectorAll('.script-page');
    const lastPage = pages[pages.length - 1];
    
    // Check if content exceeds page height
    if (lastPage.scrollHeight > lastPage.clientHeight) {
        addNewPage();
    }
}

function addNewPage() {
    pageCount++;
    const container = document.getElementById('editorContainer');
    
    const newPageWrapper = document.createElement('div');
    newPageWrapper.className = 'script-page-wrapper';
    newPageWrapper.setAttribute('data-page', pageCount);
    
    newPageWrapper.innerHTML = `
        <div contenteditable="true" class="script-page" data-page-num="${pageCount}">
            
        </div>
        <div class="page-number">Page ${pageCount}</div>
    `;
    
    container.appendChild(newPageWrapper);
    
    // Focus new page
    const newPage = newPageWrapper.querySelector('.script-page');
    newPage.focus();
    
    // Add input listener to new page
    newPage.addEventListener('input', debounce(checkPageOverflow, 300));
    
    console.log(`‚úÖ Added Page ${pageCount}`);
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

// Add Scene Function
function addNewScene() {
    const sceneName = prompt('Enter scene name (e.g., INT. BEDROOM - NIGHT):');
    if (!sceneName) return;
    
    const editor = document.getElementById('scriptEditor');
    if (editor) {
        // Insert at cursor or end
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            const newLine = document.createTextNode(`\n\n${sceneName.toUpperCase()}\n\n`);
            range.insertNode(newLine);
        } else {
            editor.textContent += `\n\n${sceneName.toUpperCase()}\n\n`;
        }
        
        saveEditorContent();
    }
}


function saveProject() {
    const projectId = new URLSearchParams(window.location.search).get('id');
    const project = projects.find(p => p.id === projectId);
    
    if (project) {
        project.sections = sectionsData;
        localStorage.setItem('imranProjects', JSON.stringify(projects));
        console.log('‚úÖ Project sections saved');
    }
}

// ‚úÖ SAFE EDITOR SAVE (XSS Protected)
function saveEditorContent() {
    const editor = document.getElementById('scriptEditor');
    if (!editor) return;
    
    const projectId = new URLSearchParams(window.location.search).get('id');
    const project = projects.find(p => p.id === projectId);
    
    if (project) {
        // ‚úÖ USE textContent (safe from XSS)
        project.scriptContent = editor.textContent;
        localStorage.setItem('imranProjects', JSON.stringify(projects));
        console.log('‚úÖ Script saved');
    }
}

// Auto-save on typing (debounced)
let saveTimeout;
const editorEl = document.getElementById('scriptEditor');
if (editorEl) {
    editorEl.addEventListener('input', () => {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveEditorContent, 1000);
    });
}


        // --- 3. UPLOAD LOGIC ---
        function triggerUpload(sectionId) {
            currentSectionId = sectionId;
            document.getElementById('fileInput').click();
        }

       const fileInput = document.getElementById('fileInput');
if (fileInput) {
    fileInput.addEventListener('change', function(e) {
       

            const files = Array.from(e.target.files);
            if(files.length === 0 || !currentSectionId) return;

            // Process first file only for now (to keep logic simple with queue)
            const file = files[0];
            
            // 1. Show Toast
            addToQueue(`Uploading ${file.name}...`);

            // 2. Simulate Delay & Add File
            setTimeout(() => {
                const sectionIndex = sectionsData.findIndex(s => s.id === currentSectionId);
                if(sectionIndex !== -1 && sectionsData[sectionIndex].files.length < FILES_PER_SECTION) {
                    
                    // Add file to data
                    sectionsData[sectionIndex].files.push({
                        name: file.name,
                        date: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                    });
                    
                    // Save & Re-render
                    const projectId = new URLSearchParams(window.location.search).get('id');
                    if(projectId) localStorage.setItem(`sections_${projectId}`, JSON.stringify(sectionsData));
                    
                    renderSections();
                    addToQueue(`${file.name} Uploaded!`, true);
                } else {
                    addToQueue('Error: Section Full', false);
                }
                
                // Reset
                document.getElementById('fileInput').value = '';
                currentSectionId = null;
            }, 1000);
        });
}
        

        // Helper: Queue Toast
        // Initialize page
// Line ~460 (save karne se pehle)
const editorText = document.getElementById('scriptEditor').textContent; // NOT innerHTML

        function addToQueue(msg, success = null) {
            const q = document.getElementById('uploadQueue');
            const div = document.createElement('div');
            let icon = `<div class="w-3 h-3 rounded-full border-2 border-t-transparent border-white animate-spin"></div>`;
            
            if(success === true) {
                div.style.borderLeftColor = '#22c55e'; // Green
                icon = `<svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            } else if(success === false) {
                div.style.borderLeftColor = '#ef4444'; // Red
                icon = `‚ö†Ô∏è`;
            }

            div.className = 'upload-item';
            div.innerHTML = `${icon} <span>${msg}</span>`;
            q.appendChild(div);
            
            setTimeout(() => {
                div.style.opacity = '0';
                setTimeout(() => div.remove(), 300);
            }, 3000);
        }

        // --- 4. NAVIGATION & SWITCHER ---
        function switchMode(mode) {
            const editorDiv = document.getElementById('modeEditor');
            const filesDiv = document.getElementById('modeFiles');
            const btnEditor = document.getElementById('btnEditor');
            const btnFiles = document.getElementById('btnFiles');
            const editorAction = document.getElementById('editorActionBtn');
                if (!editorDiv || !filesDiv || !btnEditor || !btnFiles) return;


            if (mode === 'editor') {
                editorDiv.classList.remove('hidden-mode');
                filesDiv.classList.add('hidden-mode');
                btnEditor.classList.add('active');
                btnFiles.classList.remove('active');
                editorAction.classList.remove('hidden-mode');
            } else {
                editorDiv.classList.add('hidden-mode');
                filesDiv.classList.remove('hidden-mode');
                btnFiles.classList.add('active');
                btnEditor.classList.remove('active');
                editorAction.classList.add('hidden-mode');
            }
        }

        function goBackToHub() {
            const id = new URLSearchParams(window.location.search).get('id');
               window.location.href = id ? `project-hub.html?id=${encodeURIComponent(id)}` : 'project-hub.html';
        }
        
        document.addEventListener('DOMContentLoaded', initPage);

        // ===== MOBILE MENU FUNCTIONALITY =====
function toggleMobileMenu() {
    const overlay = document.getElementById('mobileMenuOverlay');
    const panel = document.getElementById('mobileMenuPanel');
    
    if (overlay && panel) {
        const isHidden = overlay.classList.contains('hidden');
        
        if (isHidden) {
            // Open menu
            overlay.classList.remove('hidden');
            setTimeout(() => {
                panel.classList.remove('translate-x-full');
            }, 10);
            document.body.style.overflow = 'hidden'; // Prevent scroll
        } else {
            // Close menu
            closeMobileMenu();
        }
    }
}

function closeMobileMenu() {
    const overlay = document.getElementById('mobileMenuOverlay');
    const panel = document.getElementById('mobileMenuPanel');
    
    if (panel) {
        panel.classList.add('translate-x-full');
        setTimeout(() => {
            if (overlay) overlay.classList.add('hidden');
            document.body.style.overflow = ''; // Restore scroll
        }, 300);
    }
}

// Mobile menu button click
const mobileMenuBtn = document.getElementById('mobileMenuBtn');
if (mobileMenuBtn) {
    mobileMenuBtn.addEventListener('click', toggleMobileMenu);
}

// Close button click
const closeMobileMenuBtn = document.getElementById('closeMobileMenu');
if (closeMobileMenuBtn) {
    closeMobileMenuBtn.addEventListener('click', closeMobileMenu);
}

// Close on overlay click
const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
if (mobileMenuOverlay) {
    mobileMenuOverlay.addEventListener('click', (e) => {
        if (e.target === mobileMenuOverlay) {
            closeMobileMenu();
        }
    });
}

// Update mobile mode buttons on switchMode
const originalSwitchMode = switchMode;
switchMode = function(mode) {
    originalSwitchMode(mode);
    
    // Update mobile menu buttons
    const mobileWriterBtn = document.getElementById('mobileWriterBtn');
    const mobileFilesBtn = document.getElementById('mobileFilesBtn');
    
    if (mode === 'editor') {
        if (mobileWriterBtn) {
            mobileWriterBtn.classList.remove('bg-white/10', 'text-gray-300');
            mobileWriterBtn.classList.add('bg-orange-500', 'text-white');
        }
        if (mobileFilesBtn) {
            mobileFilesBtn.classList.remove('bg-orange-500', 'text-white');
            mobileFilesBtn.classList.add('bg-white/10', 'text-gray-300');
        }
    } else {
        if (mobileFilesBtn) {
            mobileFilesBtn.classList.remove('bg-white/10', 'text-gray-300');
            mobileFilesBtn.classList.add('bg-orange-500', 'text-white');
        }
        if (mobileWriterBtn) {
            mobileWriterBtn.classList.remove('bg-orange-500', 'text-white');
            mobileWriterBtn.classList.add('bg-white/10', 'text-gray-300');
        }
    }
};

// Make closeMobileMenu global
window.closeMobileMenu = closeMobileMenu;

// Export PDF function (placeholder)
function exportPDF() {
    alert('Export PDF feature coming soon!');
    // TODO: Implement PDF export
}

// Add Scene function (if not already defined)
if (typeof addNewScene !== 'function') {
    function addNewScene() {
        const sceneName = prompt('Enter scene name (e.g., INT. BEDROOM - NIGHT):');
        if (!sceneName) return;
        
        const editor = document.getElementById('scriptEditor');
        if (editor) {
            editor.textContent += `\n\n${sceneName.toUpperCase()}\n\n`;
            saveEditorContent();
        }
        alert('Scene added!');
    }
}

    // üëáüëáüëá FIX START: Renamed variables to avoid conflict with main.js üëáüëáüëá
    
    // --- 1. GLOBAL VARIABLES (Renamed) ---
    let myLocalProjects = []; 
    let activeScriptId = null;

    // --- 2. INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        // Load Projects
        loadMyLocalProjects();
        
        // Editor Listeners (Auto-save & Toolbar)
        const editor = document.getElementById('scriptEditor');
        if(editor) {
            // Auto-save
            editor.addEventListener('input', () => {
                if(activeScriptId) {
                    const currentProject = myLocalProjects.find(p => p.id === activeScriptId);
                    if(currentProject) {
                        currentProject.content = editor.innerHTML;
                        currentProject.lastModified = Date.now();
                        saveMyLocalProjects();
                    }
                }
            });
            
            // Toolbar Button Highlight
            editor.addEventListener('keyup', updateToolbarState);
            editor.addEventListener('mouseup', updateToolbarState);
            editor.addEventListener('click', updateToolbarState);
        }
    });

    // --- 3. SIDEBAR & MENU LOGIC (Fixed) ---
    
    // Sidebar Toggle (Right Side)
    function toggleSidebar() {
        const sidebar = document.getElementById('mobileSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        
        if (sidebar && overlay) {
            // Check current state via class 'open'
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open'); // Hide
                overlay.classList.remove('open');
            } else {
                sidebar.classList.add('open'); // Show
                overlay.classList.add('open');
            }
        } else {
            console.error("Sidebar elements missing!");
        }
    }

    // AI Sheet Toggle
    function toggleAISheet() {
        const sheet = document.getElementById('mobileAISheet');
        if(sheet) sheet.classList.toggle('open');
    }

    // Mobile Menu Toggle (Writer/Files Switcher)
    function switchMode(mode) {
        const editorDiv = document.getElementById('modeEditor');
        const filesDiv = document.getElementById('modeFiles');
        
        // Buttons
        const btnEditor = document.getElementById('btnEditor');
        const btnFiles = document.getElementById('btnFiles');
        const mobileWriter = document.getElementById('mobileWriterBtn');
        const mobileFiles = document.getElementById('mobileFilesBtn');
        const aiBtn = document.getElementById('mobileAIBtn');

        if (mode === 'editor') {
            // Show Editor
            if(editorDiv) editorDiv.classList.remove('hidden-mode');
            if(filesDiv) filesDiv.classList.add('hidden-mode');
            
            // Highlight Buttons
            if(btnEditor) btnEditor.classList.add('active');
            if(btnFiles) btnFiles.classList.remove('active');
            
            // Show AI Button
            if(aiBtn) aiBtn.style.display = 'flex';

        } else {
            // Show Files
            if(editorDiv) editorDiv.classList.add('hidden-mode');
            if(filesDiv) filesDiv.classList.remove('hidden-mode');
            
            // Highlight Buttons
            if(btnFiles) btnFiles.classList.add('active');
            if(btnEditor) btnEditor.classList.remove('active');

            // Hide AI Button
            if(aiBtn) aiBtn.style.display = 'none';
        }
    }

    // --- 4. PROJECT SYSTEM (Fixed 'projects' conflict) ---

    // A. Create New Project
    function createNewProject() {
        const title = prompt("Enter Project Name:");
        if (!title) return;

        const newProject = {
            id: 'proj_' + Date.now(),
            title: title,
            content: `<div><b>${title.toUpperCase()}</b></div><div><br></div><div>Start writing...</div>`,
            lastModified: Date.now()
        };

        myLocalProjects.unshift(newProject);
        saveMyLocalProjects();
        loadProjectIntoEditor(newProject.id);
        
        // Close sidebar if open
        const sidebar = document.getElementById('mobileSidebar');
        if(sidebar && sidebar.classList.contains('open')) toggleSidebar();
    }

    // B. Load Project
    function loadProjectIntoEditor(id) {
        const project = myLocalProjects.find(p => p.id === id);
        if (!project) return;

        activeScriptId = id;
        
        // Update UI
        const editor = document.getElementById('scriptEditor');
        const title = document.getElementById('scriptTitle');
        
        if(editor) editor.innerHTML = project.content;
        if(title) title.textContent = project.title.toUpperCase();
        
        // Refresh List
        renderProjects();
        
        // Close Sidebar on Mobile
        const sidebar = document.getElementById('mobileSidebar');
        if(sidebar && sidebar.classList.contains('open')) toggleSidebar();
    }

    // C. Render List
    function renderProjects() {
        const list = document.getElementById('projectList');
        const searchInput = document.getElementById('projectSearch');
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : "";
        
        if(!list) return;
        list.innerHTML = '';

        const filtered = myLocalProjects.filter(p => p.title.toLowerCase().includes(searchTerm));

        if(filtered.length === 0) {
            list.innerHTML = `<div class="text-center text-gray-500 text-xs mt-10">No projects found.<br>Click + to create.</div>`;
            return;
        }

        filtered.forEach(p => {
            const isActive = p.id === activeScriptId;
            const div = document.createElement('div');
            
            div.className = `p-3 rounded-lg border cursor-pointer transition flex items-center justify-between group mb-1 ${isActive ? 'bg-white text-black border-white' : 'bg-white/5 text-gray-300 border-transparent hover:bg-white/10'}`;
            
            div.onclick = () => loadProjectIntoEditor(p.id);
            
            const date = new Date(p.lastModified).toLocaleDateString();

            div.innerHTML = `
                <div class="flex items-center gap-3 overflow-hidden">
                    <i class="fa-regular fa-file-lines ${isActive ? 'text-orange-500' : 'text-gray-500'}"></i>
                    <div class="truncate">
                        <div class="font-bold text-xs truncate w-32">${p.title}</div>
                        <div class="text-[10px] opacity-60">${date}</div>
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // D. Storage (Unique Key)
    function saveMyLocalProjects() {
        localStorage.setItem('imran_scripts_fixed', JSON.stringify(myLocalProjects));
        renderProjects();
    }

    function loadMyLocalProjects() {
        const data = localStorage.getItem('imran_scripts_fixed');
        if (data) {
            myLocalProjects = JSON.parse(data);
            if(myLocalProjects.length > 0) loadProjectIntoEditor(myLocalProjects[0].id);
        } else {
            renderProjects();
        }
    }

    // --- 5. EDITOR TOOLS (FormatDoc) ---
    function formatDoc(cmd, value = null) {
        if(event) event.preventDefault(); // Stop focus loss
        document.execCommand(cmd, false, value);
        updateToolbarState();
        
        const editor = document.getElementById('scriptEditor');
        if(editor) editor.focus();
    }

    function updateToolbarState() {
        const states = ['bold', 'italic', 'underline'];
        states.forEach(cmd => {
            const isActive = document.queryCommandState(cmd);
            const btn = document.querySelector(`button[onclick="formatDoc('${cmd}')"]`);
            if(btn) isActive ? btn.classList.add('active') : btn.classList.remove('active');
        });
    }

    function applyScriptFormat(type) {
        if(!type) return;
        document.execCommand('formatBlock', false, 'div');
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            const node = selection.anchorNode.parentElement;
            node.style.cssText = ''; 
            
            if (type === 'scene') { 
                node.style.fontWeight = 'bold'; node.style.textTransform = 'uppercase'; node.style.marginTop = '20px'; 
            } 
            else if (type === 'character') { 
                node.style.textAlign = 'center'; node.style.fontWeight = 'bold'; node.style.textTransform = 'uppercase'; node.style.width = '60%'; node.style.margin = '15px auto 0 auto';
            } 
            else if (type === 'dialogue') { 
                node.style.textAlign = 'center'; node.style.width = '70%'; node.style.margin = '0 auto';
            }
        }
        const editor = document.getElementById('scriptEditor');
        if(editor) editor.focus();
    }
    
    // --- 6. EXPORT PDF (Placeholder fix) ---
    function exportPDF() {
        alert("PDF Export Feature coming soon!");
    }

</script>

        <!-- üì± MOBILE BOTTOM NAVIGATION -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 bg-black/95 backdrop-blur-lg border-t border-white/10 flex justify-around py-2 z-50 safe-area-bottom">
        <button onclick="switchMode('editor')" id="mobileWriterBtn" class="flex flex-col items-center gap-1 px-4 py-2 text-orange-400 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            <span class="text-[10px] font-medium">Write</span>
        </button>
        
        <button onclick="switchMode('files')" id="mobileFilesBtn" class="flex flex-col items-center gap-1 px-4 py-2 text-gray-400 hover:text-white transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
            </svg>
            <span class="text-[10px] font-medium">Files</span>
        </button>
        
        <button onclick="addNewScene()" class="flex flex-col items-center gap-1 px-4 py-2 text-gray-400 hover:text-white transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <span class="text-[10px] font-medium">Add</span>
        </button>
        
        <button onclick="exportPDF()" class="flex flex-col items-center gap-1 px-4 py-2 text-gray-400 hover:text-white transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <span class="text-[10px] font-medium">Export</span>
        </button>
    </div>

</body>

</body>
</html>